<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/app/src/main/java/id/stargan/intikasir/feature/settings/ui/StoreSettingsScreen.kt">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/id/stargan/intikasir/feature/settings/ui/StoreSettingsScreen.kt" />
              <option name="originalContent" value="package id.stargan.intikasir.feature.settings.ui&#10;&#10;import android.Manifest&#10;import android.bluetooth.BluetoothAdapter&#10;import android.content.Intent&#10;import android.net.Uri&#10;import android.os.Build&#10;import android.content.pm.PackageManager&#10;import androidx.activity.compose.rememberLauncherForActivityResult&#10;import androidx.activity.result.contract.ActivityResultContracts&#10;import androidx.compose.foundation.layout.*&#10;import androidx.compose.foundation.rememberScrollState&#10;import androidx.compose.foundation.shape.CircleShape&#10;import androidx.compose.foundation.verticalScroll&#10;import androidx.compose.material.icons.Icons&#10;import androidx.compose.material.icons.automirrored.filled.ArrowBack&#10;import androidx.compose.material.icons.filled.*&#10;import androidx.compose.material3.*&#10;import androidx.compose.runtime.*&#10;import androidx.compose.ui.Alignment&#10;import androidx.compose.ui.Modifier&#10;import androidx.compose.ui.draw.clip&#10;import androidx.compose.ui.layout.ContentScale&#10;import androidx.compose.ui.platform.LocalContext&#10;import androidx.compose.ui.unit.dp&#10;import androidx.core.content.FileProvider&#10;import androidx.core.content.ContextCompat&#10;import androidx.hilt.lifecycle.viewmodel.compose.hiltViewModel&#10;import coil.compose.AsyncImage&#10;import com.yalantis.ucrop.UCrop&#10;import id.stargan.intikasir.domain.model.StoreSettings&#10;import id.stargan.intikasir.feature.pos.print.ReceiptPrinter&#10;import id.stargan.intikasir.data.local.entity.TransactionEntity&#10;import id.stargan.intikasir.data.local.entity.TransactionItemEntity&#10;import id.stargan.intikasir.data.local.entity.PaymentMethod&#10;import java.io.File&#10;import java.util.UUID&#10;import kotlinx.coroutines.launch&#10;import id.stargan.intikasir.feature.pos.print.ESCPosPrinter&#10;&#10;@OptIn(ExperimentalMaterial3Api::class)&#10;@Composable&#10;fun StoreSettingsScreen(&#10;    onNavigateBack: () -&gt; Unit,&#10;    modifier: Modifier = Modifier,&#10;    viewModel: StoreSettingsViewModel = hiltViewModel()&#10;) {&#10;    val uiState by viewModel.uiState.collectAsState()&#10;    val snackbarHostState = remember { SnackbarHostState() }&#10;    val context = LocalContext.current&#10;    val scope = rememberCoroutineScope()&#10;&#10;    var pendingCameraUri by remember { mutableStateOf&lt;Uri?&gt;(null) }&#10;&#10;    val cropLauncher = rememberLauncherForActivityResult(ActivityResultContracts.StartActivityForResult()) { result -&gt;&#10;        if (result.resultCode == android.app.Activity.RESULT_OK) {&#10;            val output = result.data?.let { UCrop.getOutput(it) }&#10;            output?.let { viewModel.onEvent(StoreSettingsUiEvent.LogoCropped(it)) }&#10;        }&#10;    }&#10;&#10;    fun launchCrop(input: Uri) {&#10;        val dest = Uri.fromFile(File(context.cacheDir, &quot;logo_crop_${System.currentTimeMillis()}.jpg&quot;))&#10;        val options = UCrop.Options().apply {&#10;            // Quality &amp; behavior&#10;            setCompressionQuality(85)&#10;            setHideBottomControls(false)&#10;            setFreeStyleCropEnabled(false)&#10;&#10;            // Colors - toolbar&#10;            setToolbarColor(context.getColor(android.R.color.black))&#10;            setStatusBarColor(context.getColor(android.R.color.black))&#10;            setToolbarWidgetColor(context.getColor(android.R.color.white))&#10;&#10;            // Colors - crop frame&#10;            setActiveControlsWidgetColor(context.getColor(android.R.color.holo_green_dark))&#10;            setRootViewBackgroundColor(context.getColor(android.R.color.black))&#10;            setDimmedLayerColor(context.getColor(android.R.color.black))&#10;&#10;            // Toolbar text&#10;            setToolbarTitle(&quot;Crop Logo Toko&quot;)&#10;            setToolbarCancelDrawable(android.R.drawable.ic_menu_close_clear_cancel)&#10;            setToolbarCropDrawable(android.R.drawable.ic_menu_save)&#10;&#10;            // Crop frame display&#10;            setShowCropFrame(true)&#10;            setShowCropGrid(true)&#10;            setCropGridStrokeWidth(2)&#10;            setCropGridColor(context.getColor(android.R.color.white))&#10;            setCropFrameColor(context.getColor(android.R.color.white))&#10;&#10;            // Image settings&#10;            setCircleDimmedLayer(false)&#10;            setCompressionFormat(android.graphics.Bitmap.CompressFormat.JPEG)&#10;        }&#10;        val intent = UCrop.of(input, dest)&#10;            .withAspectRatio(1f, 1f)&#10;            .withMaxResultSize(512, 512)&#10;            .withOptions(options)&#10;            .getIntent(context)&#10;        cropLauncher.launch(intent)&#10;    }&#10;&#10;    val galleryLauncher = rememberLauncherForActivityResult(ActivityResultContracts.GetContent()) { uri -&gt; uri?.let { launchCrop(it) } }&#10;    val cameraLauncher = rememberLauncherForActivityResult(ActivityResultContracts.TakePicture()) { success -&gt;&#10;        if (success) pendingCameraUri?.let { launchCrop(it) }&#10;    }&#10;&#10;    val onPickLogo = { galleryLauncher.launch(&quot;image/*&quot;) }&#10;    val onCaptureLogo = {&#10;        val file = File(context.cacheDir, &quot;logo_cap_${System.currentTimeMillis()}.jpg&quot;)&#10;        val uri = FileProvider.getUriForFile(context, context.packageName + &quot;.fileprovider&quot;, file)&#10;        pendingCameraUri = uri&#10;        cameraLauncher.launch(uri)&#10;    }&#10;&#10;    // Handle error messages&#10;    LaunchedEffect(uiState.error) {&#10;        uiState.error?.let { message -&gt;&#10;            snackbarHostState.showSnackbar(&#10;                message = message,&#10;                duration = SnackbarDuration.Long&#10;            )&#10;            viewModel.onEvent(StoreSettingsUiEvent.DismissError)&#10;        }&#10;    }&#10;&#10;    // Handle success messages&#10;    LaunchedEffect(uiState.successMessage) {&#10;        uiState.successMessage?.let { message -&gt;&#10;            snackbarHostState.showSnackbar(&#10;                message = message,&#10;                duration = SnackbarDuration.Short&#10;            )&#10;            viewModel.onEvent(StoreSettingsUiEvent.DismissSuccess)&#10;        }&#10;    }&#10;&#10;    Scaffold(&#10;        modifier = modifier,&#10;        topBar = {&#10;            TopAppBar(&#10;                title = { Text(&quot;Pengaturan Toko&quot;) },&#10;                navigationIcon = {&#10;                    IconButton(onClick = onNavigateBack) {&#10;                        Icon(&#10;                            imageVector = Icons.AutoMirrored.Filled.ArrowBack,&#10;                            contentDescription = &quot;Kembali&quot;&#10;                        )&#10;                    }&#10;                }&#10;            )&#10;        },&#10;        snackbarHost = {&#10;            SnackbarHost(hostState = snackbarHostState)&#10;        }&#10;    ) { paddingValues -&gt;&#10;        if (uiState.isLoading) {&#10;            Box(&#10;                modifier = Modifier&#10;                    .fillMaxSize()&#10;                    .padding(paddingValues),&#10;                contentAlignment = Alignment.Center&#10;            ) {&#10;                CircularProgressIndicator()&#10;            }&#10;        } else {&#10;            Column(&#10;                modifier = Modifier&#10;                    .fillMaxSize()&#10;                    .padding(paddingValues)&#10;                    .verticalScroll(rememberScrollState())&#10;                    .padding(16.dp),&#10;                verticalArrangement = Arrangement.spacedBy(24.dp)&#10;            ) {&#10;                // Logo Section&#10;                Card(&#10;                    modifier = Modifier.fillMaxWidth(),&#10;                    elevation = CardDefaults.cardElevation(defaultElevation = 2.dp)&#10;                ) {&#10;                    Column(&#10;                        modifier = Modifier&#10;                            .fillMaxWidth()&#10;                            .padding(16.dp),&#10;                        horizontalAlignment = Alignment.CenterHorizontally,&#10;                        verticalArrangement = Arrangement.spacedBy(16.dp)&#10;                    ) {&#10;                        Text(&#10;                            text = &quot;Logo Toko&quot;,&#10;                            style = MaterialTheme.typography.titleMedium&#10;                        )&#10;&#10;                        // Logo Preview&#10;                        Box(&#10;                            modifier = Modifier&#10;                                .size(180.dp)&#10;                                .clip(CircleShape),&#10;                            contentAlignment = Alignment.Center&#10;                        ) {&#10;                            if (uiState.logoPreviewUri != null) {&#10;                                AsyncImage(&#10;                                    model = uiState.logoPreviewUri,&#10;                                    contentDescription = &quot;Logo Toko&quot;,&#10;                                    modifier = Modifier.fillMaxSize(),&#10;                                    contentScale = ContentScale.Crop&#10;                                )&#10;                            } else {&#10;                                Card(&#10;                                    modifier = Modifier.fillMaxSize(),&#10;                                    colors = CardDefaults.cardColors(&#10;                                        containerColor = MaterialTheme.colorScheme.surfaceVariant&#10;                                    ),&#10;                                    onClick = onPickLogo&#10;                                ) {&#10;                                    Box(&#10;                                        modifier = Modifier.fillMaxSize(),&#10;                                        contentAlignment = Alignment.Center&#10;                                    ) {&#10;                                        Column(&#10;                                            horizontalAlignment = Alignment.CenterHorizontally,&#10;                                            verticalArrangement = Arrangement.spacedBy(8.dp)&#10;                                        ) {&#10;                                            Icon(&#10;                                                imageVector = Icons.Default.Store,&#10;                                                contentDescription = null,&#10;                                                modifier = Modifier.size(64.dp),&#10;                                                tint = MaterialTheme.colorScheme.outline&#10;                                            )&#10;                                            Text(&#10;                                                text = &quot;Tambah Logo&quot;,&#10;                                                color = MaterialTheme.colorScheme.outline&#10;                                            )&#10;                                        }&#10;                                    }&#10;                                }&#10;                            }&#10;&#10;                            if (uiState.isImageProcessing) {&#10;                                CircularProgressIndicator(&#10;                                    modifier = Modifier.align(Alignment.Center)&#10;                                )&#10;                            }&#10;                        }&#10;&#10;                        // Action Buttons&#10;                        Row(&#10;                            modifier = Modifier.fillMaxWidth(),&#10;                            horizontalArrangement = Arrangement.spacedBy(12.dp)&#10;                        ) {&#10;                            if (uiState.logoPreviewUri != null) {&#10;                                OutlinedButton(&#10;                                    onClick = { viewModel.onEvent(StoreSettingsUiEvent.RemoveLogo) },&#10;                                    modifier = Modifier.weight(1f),&#10;                                    colors = ButtonDefaults.outlinedButtonColors(&#10;                                        contentColor = MaterialTheme.colorScheme.error&#10;                                    )&#10;                                ) {&#10;                                    Icon(Icons.Default.Delete, contentDescription = null)&#10;                                    Spacer(Modifier.width(8.dp))&#10;                                    Text(&quot;Hapus&quot;)&#10;                                }&#10;                            }&#10;&#10;                            OutlinedButton(&#10;                                onClick = onPickLogo,&#10;                                modifier = Modifier.weight(1f)&#10;                            ) {&#10;                                Icon(Icons.Default.Image, contentDescription = null)&#10;                                Spacer(Modifier.width(8.dp))&#10;                                Text(if (uiState.logoPreviewUri != null) &quot;Ganti&quot; else &quot;Galeri&quot;)&#10;                            }&#10;&#10;                            OutlinedButton(&#10;                                onClick = onCaptureLogo,&#10;                                modifier = Modifier.weight(1f)&#10;                            ) {&#10;                                Icon(Icons.Default.PhotoCamera, contentDescription = null)&#10;                                Spacer(Modifier.width(8.dp))&#10;                                Text(&quot;Kamera&quot;)&#10;                            }&#10;                        }&#10;&#10;                        Text(&#10;                            text = &quot;Logo akan ditampilkan pada struk penjualan&quot;,&#10;                            style = MaterialTheme.typography.bodySmall,&#10;                            color = MaterialTheme.colorScheme.onSurfaceVariant&#10;                        )&#10;                    }&#10;                }&#10;&#10;                // Store Info Section (Optional - for future enhancement)&#10;                Card(&#10;                    modifier = Modifier.fillMaxWidth(),&#10;                    elevation = CardDefaults.cardElevation(defaultElevation = 2.dp)&#10;                ) {&#10;                    Column(&#10;                        modifier = Modifier&#10;                            .fillMaxWidth()&#10;                            .padding(16.dp),&#10;                        verticalArrangement = Arrangement.spacedBy(8.dp)&#10;                    ) {&#10;                        Text(&#10;                            text = &quot;Informasi Toko&quot;,&#10;                            style = MaterialTheme.typography.titleMedium&#10;                        )&#10;&#10;                        HorizontalDivider(modifier = Modifier.padding(vertical = 8.dp))&#10;&#10;                        InfoRow(&#10;                            label = &quot;Nama Toko&quot;,&#10;                            value = uiState.settings?.storeName ?: &quot;Belum diatur&quot;&#10;                        )&#10;                        InfoRow(&#10;                            label = &quot;Alamat&quot;,&#10;                            value = uiState.settings?.storeAddress ?: &quot;Belum diatur&quot;&#10;                        )&#10;                        InfoRow(&#10;                            label = &quot;Telepon&quot;,&#10;                            value = uiState.settings?.storePhone ?: &quot;Belum diatur&quot;&#10;                        )&#10;                    }&#10;                }&#10;&#10;                // Printing Settings Section&#10;                Card(&#10;                    modifier = Modifier.fillMaxWidth(),&#10;                    elevation = CardDefaults.cardElevation(defaultElevation = 2.dp)&#10;                ) {&#10;                    val settings = uiState.settings ?: StoreSettings()&#10;                    var paperWidth by remember(settings) { mutableStateOf(settings.paperWidthMm) }&#10;                    var charPerLine by remember(settings) { mutableStateOf(settings.paperCharPerLine) }&#10;                    val format = &quot;THERMAL&quot; // lock to thermal only&#10;                    var autoCut by remember(settings) { mutableStateOf(settings.autoCut) }&#10;                    var printLogo by remember(settings) { mutableStateOf(settings.printLogo) }&#10;                    var useEscPosDirect by remember(settings) { mutableStateOf(settings.useEscPosDirect) }&#10;                    val hasActivePrinter = !((uiState.settings?.printerAddress).isNullOrBlank())&#10;&#10;                    Column(&#10;                        modifier = Modifier&#10;                            .fillMaxWidth()&#10;                            .padding(16.dp),&#10;                        verticalArrangement = Arrangement.spacedBy(12.dp)&#10;                    ) {&#10;                        Text(&quot;Pengaturan Cetak&quot;, style = MaterialTheme.typography.titleMedium)&#10;                        HorizontalDivider()&#10;&#10;                        // Format info (locked to Thermal)&#10;                        Row(Modifier.fillMaxWidth(), horizontalArrangement = Arrangement.SpaceBetween, verticalAlignment = Alignment.CenterVertically) {&#10;                            Text(&quot;Format Cetak&quot;)&#10;                            AssistChip(onClick = {}, label = { Text(&quot;Thermal (aktif)&quot;) }, leadingIcon = {&#10;                                Icon(Icons.Default.CheckCircle, contentDescription = null)&#10;                            }, enabled = false)&#10;                        }&#10;&#10;                        // Paper width selector&#10;                        Row(Modifier.fillMaxWidth(), horizontalArrangement = Arrangement.SpaceBetween, verticalAlignment = Alignment.CenterVertically) {&#10;                            Text(&quot;Lebar Kertas (mm)&quot;)&#10;                            Row(horizontalArrangement = Arrangement.spacedBy(8.dp)) {&#10;                                FilterChip(&#10;                                    selected = paperWidth == 58,&#10;                                    onClick = { paperWidth = 58; charPerLine = 32 },&#10;                                    label = { Text(&quot;58&quot;) },&#10;                                    leadingIcon = if (paperWidth == 58) { { Icon(Icons.Default.Check, contentDescription = null) } } else null&#10;                                )&#10;                                FilterChip(&#10;                                    selected = paperWidth == 80,&#10;                                    onClick = { paperWidth = 80; charPerLine = 48 },&#10;                                    label = { Text(&quot;80&quot;) },&#10;                                    leadingIcon = if (paperWidth == 80) { { Icon(Icons.Default.Check, contentDescription = null) } } else null&#10;                                )&#10;                            }&#10;                        }&#10;                        // Hint chars per line&#10;                        Text(&#10;                            text = if (paperWidth == 58) &quot;58 mm ≈ 32 karakter per baris&quot; else &quot;80 mm ≈ 48 karakter per baris&quot;,&#10;                            style = MaterialTheme.typography.bodySmall,&#10;                            color = MaterialTheme.colorScheme.onSurfaceVariant&#10;                        )&#10;&#10;                        // Options&#10;                        Row(Modifier.fillMaxWidth(), horizontalArrangement = Arrangement.SpaceBetween, verticalAlignment = Alignment.CenterVertically) {&#10;                            Text(&quot;Auto Cut (jika didukung)&quot;)&#10;                            Switch(checked = autoCut, onCheckedChange = { autoCut = it })&#10;                        }&#10;                        Row(Modifier.fillMaxWidth(), horizontalArrangement = Arrangement.SpaceBetween, verticalAlignment = Alignment.CenterVertically) {&#10;                            Text(&quot;Tampilkan Logo di Struk&quot;)&#10;                            Switch(checked = printLogo, onCheckedChange = { printLogo = it })&#10;                        }&#10;                        Row(Modifier.fillMaxWidth(), horizontalArrangement = Arrangement.SpaceBetween, verticalAlignment = Alignment.CenterVertically) {&#10;                            Text(&quot;Cetak langsung ESC/POS (Bluetooth)&quot;)&#10;                            Switch(&#10;                                checked = useEscPosDirect,&#10;                                onCheckedChange = { useEscPosDirect = it },&#10;                                enabled = hasActivePrinter&#10;                            )&#10;                        }&#10;                        if (!hasActivePrinter) {&#10;                            Text(&#10;                                text = &quot;Pilih printer terlebih dahulu untuk mengaktifkan cetak langsung.&quot;,&#10;                                style = MaterialTheme.typography.bodySmall,&#10;                                color = MaterialTheme.colorScheme.onSurfaceVariant&#10;                            )&#10;                        }&#10;&#10;                        // Mini preview (generate thermal pdf and show hint)&#10;                        Text(&quot;Preview Thermal (contoh)&quot;, style = MaterialTheme.typography.titleSmall)&#10;                        Text(&#10;                            text = &quot;Preview PDF akan dibuat saat Cetak/Bagikan. Untuk melihat contoh, selesaikan transaksi lalu buka struk.&quot;,&#10;                            style = MaterialTheme.typography.bodySmall,&#10;                            color = MaterialTheme.colorScheme.onSurfaceVariant&#10;                        )&#10;                        OutlinedButton(&#10;                            onClick = {&#10;                                try {&#10;                                    val effective = uiState.settings ?: StoreSettings()&#10;                                    val txId = UUID.randomUUID().toString()&#10;                                    val items = listOf(&#10;                                        TransactionItemEntity(&#10;                                            transactionId = txId,&#10;                                            productId = &quot;sku-001&quot;,&#10;                                            productName = &quot;Produk Contoh A&quot;,&#10;                                            productPrice = 10000.0,&#10;                                            quantity = 2,&#10;                                            unitPrice = 10000.0,&#10;                                            subtotal = 20000.0&#10;                                        ),&#10;                                        TransactionItemEntity(&#10;                                            transactionId = txId,&#10;                                            productId = &quot;sku-002&quot;,&#10;                                            productName = &quot;Produk Contoh B&quot;,&#10;                                            productPrice = 5000.0,&#10;                                            quantity = 1,&#10;                                            unitPrice = 5000.0,&#10;                                            subtotal = 5000.0&#10;                                        )&#10;                                    )&#10;                                    val subtotal = items.sumOf { it.subtotal }&#10;                                    val tax = if (effective.taxEnabled) subtotal * (effective.taxPercentage / 100.0) else 0.0&#10;                                    val total = subtotal + tax&#10;                                    val tx = TransactionEntity(&#10;                                        transactionNumber = &quot;PREVIEW-${System.currentTimeMillis()}&quot;,&#10;                                        cashierId = &quot;preview&quot;,&#10;                                        cashierName = &quot;Preview&quot;,&#10;                                        paymentMethod = PaymentMethod.CASH,&#10;                                        subtotal = subtotal,&#10;                                        tax = tax,&#10;                                        total = total,&#10;                                        cashReceived = total,&#10;                                        cashChange = 0.0&#10;                                    )&#10;                                    val result = ReceiptPrinter.generateThermalReceiptPdf(context, effective, tx, items)&#10;                                    val file = File(result.pdfUri.path ?: return@OutlinedButton)&#10;                                    val contentUri = FileProvider.getUriForFile(context, context.packageName + &quot;.fileprovider&quot;, file)&#10;                                    val intent = Intent(Intent.ACTION_VIEW).apply {&#10;                                        setDataAndType(contentUri, &quot;application/pdf&quot;)&#10;                                        addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION)&#10;                                    }&#10;                                    val pm = context.packageManager&#10;                                    if (intent.resolveActivity(pm) != null) {&#10;                                        context.startActivity(intent)&#10;                                    } else {&#10;                                        // Fallback: share chooser&#10;                                        ReceiptPrinter.sharePdf(context, contentUri)&#10;                                    }&#10;                                } catch (e: Exception) {&#10;                                    // Ignore preview errors for now&#10;                                }&#10;                            },&#10;                            modifier = Modifier.align(Alignment.Start)&#10;                        ) {&#10;                            Icon(Icons.Default.Preview, contentDescription = null)&#10;                            Spacer(Modifier.width(8.dp))&#10;                            Text(&quot;Preview Struk (Thermal)&quot;)&#10;                        }&#10;&#10;                        // Save button&#10;                        Button(&#10;                            onClick = {&#10;                                val current = uiState.settings ?: StoreSettings()&#10;                                val updated = current.copy(&#10;                                    paperWidthMm = paperWidth,&#10;                                    paperCharPerLine = charPerLine,&#10;                                    printFormat = format,&#10;                                    autoCut = autoCut,&#10;                                    printLogo = printLogo,&#10;                                    useEscPosDirect = useEscPosDirect,&#10;                                    updatedAt = System.currentTimeMillis()&#10;                                )&#10;                                viewModel.onEvent(StoreSettingsUiEvent.Save(updated))&#10;                            },&#10;                            modifier = Modifier.align(Alignment.End)&#10;                        ) {&#10;                            Icon(Icons.Default.Save, contentDescription = null)&#10;                            Spacer(Modifier.width(8.dp))&#10;                            Text(&quot;Simpan Pengaturan&quot;)&#10;                        }&#10;                    }&#10;                }&#10;&#10;                // Bluetooth Printer Picker Section&#10;                Card(&#10;                    modifier = Modifier.fillMaxWidth(),&#10;                    elevation = CardDefaults.cardElevation(defaultElevation = 2.dp)&#10;                ) {&#10;                    val adapter = remember { BluetoothAdapter.getDefaultAdapter() }&#10;                    val btPermission = Manifest.permission.BLUETOOTH_CONNECT&#10;                    val sdk31Plus = remember { android.os.Build.VERSION.SDK_INT &gt;= android.os.Build.VERSION_CODES.S }&#10;                    var hasBtPermission by remember {&#10;                        mutableStateOf(&#10;                            if (sdk31Plus) ContextCompat.checkSelfPermission(context, btPermission) == PackageManager.PERMISSION_GRANTED else true&#10;                        )&#10;                    }&#10;                    val requestBtPermissionLauncher = rememberLauncherForActivityResult(ActivityResultContracts.RequestPermission()) { granted -&gt;&#10;                        hasBtPermission = granted&#10;                    }&#10;                    val bonded = remember(hasBtPermission) { if (hasBtPermission) adapter?.bondedDevices?.toList().orEmpty() else emptyList() }&#10;                    var selectedAddress by remember(uiState.settings) { mutableStateOf(uiState.settings?.printerAddress) }&#10;                    var selectedName by remember(uiState.settings) { mutableStateOf(uiState.settings?.printerName) }&#10;&#10;                    Column(&#10;                        modifier = Modifier&#10;                            .fillMaxWidth()&#10;                            .padding(16.dp),&#10;                        verticalArrangement = Arrangement.spacedBy(12.dp)&#10;                    ) {&#10;                        Text(&quot;Pilih Printer Bluetooth&quot;, style = MaterialTheme.typography.titleMedium)&#10;                        val activeName = uiState.settings?.printerName&#10;                        val activeAddr = uiState.settings?.printerAddress&#10;                        if (!activeAddr.isNullOrBlank()) {&#10;                            Row(Modifier.fillMaxWidth(), horizontalArrangement = Arrangement.SpaceBetween, verticalAlignment = Alignment.CenterVertically) {&#10;                                Column(Modifier.weight(1f)) {&#10;                                    Text(&quot;Printer aktif:&quot;, style = MaterialTheme.typography.bodySmall, color = MaterialTheme.colorScheme.onSurfaceVariant)&#10;                                    Text(activeName ?: &quot;Unknown&quot;, style = MaterialTheme.typography.bodyMedium)&#10;                                    Text(activeAddr, style = MaterialTheme.typography.bodySmall, color = MaterialTheme.colorScheme.onSurfaceVariant)&#10;                                }&#10;                                Icon(imageVector = Icons.Default.CheckCircle, contentDescription = null, tint = MaterialTheme.colorScheme.primary)&#10;                            }&#10;                        }&#10;                        // Test Print button&#10;                        Row(Modifier.fillMaxWidth(), horizontalArrangement = Arrangement.End) {&#10;                            OutlinedButton(onClick = {&#10;                                when {&#10;                                    adapter == null -&gt; scope.launch { snackbarHostState.showSnackbar(&quot;Bluetooth tidak tersedia&quot;) }&#10;                                    !adapter.isEnabled -&gt; scope.launch { snackbarHostState.showSnackbar(&quot;Nyalakan Bluetooth terlebih dahulu&quot;) }&#10;                                    sdk31Plus &amp;&amp; !hasBtPermission -&gt; scope.launch { requestBtPermissionLauncher.launch(btPermission) }&#10;                                    activeAddr.isNullOrBlank() -&gt; scope.launch { snackbarHostState.showSnackbar(&quot;Pilih printer terlebih dahulu&quot;) }&#10;                                    else -&gt; {&#10;                                        scope.launch {&#10;                                            val effective = uiState.settings ?: StoreSettings()&#10;                                            val txId = UUID.randomUUID().toString()&#10;                                            val items = listOf(&#10;                                                TransactionItemEntity(&#10;                                                    transactionId = txId,&#10;                                                    productId = &quot;sku-TEST&quot;,&#10;                                                    productName = &quot;Test Item&quot;,&#10;                                                    productPrice = 1000.0,&#10;                                                    quantity = 1,&#10;                                                    unitPrice = 1000.0,&#10;                                                    subtotal = 1000.0&#10;                                                )&#10;                                            )&#10;                                            val tx = TransactionEntity(&#10;                                                transactionNumber = &quot;TEST-${System.currentTimeMillis()}&quot;,&#10;                                                cashierId = &quot;test&quot;,&#10;                                                cashierName = &quot;Tester&quot;,&#10;                                                paymentMethod = PaymentMethod.CASH,&#10;                                                subtotal = 1000.0,&#10;                                                tax = 0.0,&#10;                                                total = 1000.0,&#10;                                                cashReceived = 1000.0,&#10;                                                cashChange = 0.0&#10;                                            )&#10;                                            ESCPosPrinter.printReceipt(context, effective, tx, items)&#10;                                            snackbarHostState.showSnackbar(&quot;Perintah cetak dikirim&quot;)&#10;                                        }&#10;                                    }&#10;                                }&#10;                            }) {&#10;                                Icon(Icons.Default.Print, contentDescription = null)&#10;                                Spacer(Modifier.width(8.dp))&#10;                                Text(&quot;Test Cetak ESC/POS&quot;)&#10;                            }&#10;                        }&#10;&#10;                        HorizontalDivider()&#10;                        if (adapter == null) {&#10;                            Text(&quot;Bluetooth tidak tersedia di perangkat ini&quot;, color = MaterialTheme.colorScheme.error)&#10;                        } else if (!adapter.isEnabled) {&#10;                            Text(&quot;Bluetooth nonaktif. Aktifkan Bluetooth untuk memilih printer.&quot;, color = MaterialTheme.colorScheme.error)&#10;                        } else if (!hasBtPermission &amp;&amp; sdk31Plus) {&#10;                            Text(&quot;Izin BLUETOOTH_CONNECT diperlukan untuk melihat perangkat.&quot;)&#10;                            OutlinedButton(onClick = { requestBtPermissionLauncher.launch(btPermission) }) {&#10;                                Icon(Icons.Default.Bluetooth, contentDescription = null)&#10;                                Spacer(Modifier.width(8.dp))&#10;                                Text(&quot;Izinkan Bluetooth&quot;)&#10;                            }&#10;                        } else if (bonded.isEmpty()) {&#10;                            Text(&quot;Tidak ada perangkat Bluetooth yang terpasang.&quot;)&#10;                            Text(&quot;Silakan pasangkan printer terlebih dahulu melalui pengaturan Bluetooth.&quot;, style = MaterialTheme.typography.bodySmall)&#10;                        } else {&#10;                            bonded.forEach { device -&gt;&#10;                                val name = device.name ?: &quot;Unknown&quot;&#10;                                val addr = device.address&#10;                                val selected = selectedAddress == addr&#10;                                OutlinedButton(&#10;                                    onClick = {&#10;                                        selectedAddress = addr&#10;                                        selectedName = name&#10;                                        val current = uiState.settings ?: StoreSettings()&#10;                                        viewModel.onEvent(StoreSettingsUiEvent.Save(&#10;                                            current.copy(&#10;                                                printerName = name,&#10;                                                printerAddress = addr,&#10;                                                updatedAt = System.currentTimeMillis()&#10;                                            )&#10;                                        ))&#10;                                        scope.launch { snackbarHostState.showSnackbar(&quot;Printer di-set ke $name&quot;) }&#10;                                    },&#10;                                    modifier = Modifier.fillMaxWidth(),&#10;                                    colors = ButtonDefaults.outlinedButtonColors(&#10;                                        containerColor = if (selected) MaterialTheme.colorScheme.primary.copy(alpha = 0.08f) else MaterialTheme.colorScheme.surface&#10;                                    )&#10;                                ) {&#10;                                    Row(&#10;                                        modifier = Modifier.fillMaxWidth(),&#10;                                        horizontalArrangement = Arrangement.SpaceBetween&#10;                                    ) {&#10;                                        Column {&#10;                                            Text(name)&#10;                                            Text(addr, style = MaterialTheme.typography.bodySmall, color = MaterialTheme.colorScheme.onSurfaceVariant)&#10;                                        }&#10;                                        if (selected) Icon(Icons.Default.Check, contentDescription = null)&#10;                                    }&#10;                                }&#10;                            }&#10;                        }&#10;                    }&#10;                }&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;@Composable&#10;private fun InfoRow(label: String, value: String) {&#10;    Row(&#10;        modifier = Modifier.fillMaxWidth(),&#10;        horizontalArrangement = Arrangement.SpaceBetween&#10;    ) {&#10;        Text(&#10;            text = label,&#10;            style = MaterialTheme.typography.bodyMedium,&#10;            color = MaterialTheme.colorScheme.onSurfaceVariant&#10;        )&#10;        Text(&#10;            text = value,&#10;            style = MaterialTheme.typography.bodyMedium&#10;        )&#10;    }&#10;}&#10;" />
              <option name="updatedContent" value="package id.stargan.intikasir.feature.settings.ui&#10;&#10;import android.Manifest&#10;import android.bluetooth.BluetoothAdapter&#10;import android.content.Intent&#10;import android.net.Uri&#10;import android.os.Build&#10;import android.content.pm.PackageManager&#10;import androidx.activity.compose.rememberLauncherForActivityResult&#10;import androidx.activity.result.contract.ActivityResultContracts&#10;import androidx.compose.foundation.layout.*&#10;import androidx.compose.foundation.rememberScrollState&#10;import androidx.compose.foundation.shape.CircleShape&#10;import androidx.compose.foundation.verticalScroll&#10;import androidx.compose.material.icons.Icons&#10;import androidx.compose.material.icons.automirrored.filled.ArrowBack&#10;import androidx.compose.material.icons.filled.*&#10;import androidx.compose.material3.*&#10;import androidx.compose.runtime.*&#10;import androidx.compose.ui.Alignment&#10;import androidx.compose.ui.Modifier&#10;import androidx.compose.ui.draw.clip&#10;import androidx.compose.ui.layout.ContentScale&#10;import androidx.compose.ui.platform.LocalContext&#10;import androidx.compose.ui.unit.dp&#10;import androidx.core.content.FileProvider&#10;import androidx.core.content.ContextCompat&#10;import androidx.hilt.lifecycle.viewmodel.compose.hiltViewModel&#10;import coil.compose.AsyncImage&#10;import com.yalantis.ucrop.UCrop&#10;import id.stargan.intikasir.domain.model.StoreSettings&#10;import id.stargan.intikasir.feature.pos.print.ReceiptPrinter&#10;import id.stargan.intikasir.data.local.entity.TransactionEntity&#10;import id.stargan.intikasir.data.local.entity.TransactionItemEntity&#10;import id.stargan.intikasir.data.local.entity.PaymentMethod&#10;import java.io.File&#10;import java.util.UUID&#10;import kotlinx.coroutines.launch&#10;import id.stargan.intikasir.feature.pos.print.ESCPosPrinter&#10;&#10;@OptIn(ExperimentalMaterial3Api::class)&#10;@Composable&#10;fun StoreSettingsScreen(&#10;    onNavigateBack: () -&gt; Unit,&#10;    modifier: Modifier = Modifier,&#10;    viewModel: StoreSettingsViewModel = hiltViewModel()&#10;) {&#10;    val uiState by viewModel.uiState.collectAsState()&#10;    val snackbarHostState = remember { SnackbarHostState() }&#10;    val context = LocalContext.current&#10;    val scope = rememberCoroutineScope()&#10;&#10;    var pendingCameraUri by remember { mutableStateOf&lt;Uri?&gt;(null) }&#10;&#10;    val cropLauncher = rememberLauncherForActivityResult(ActivityResultContracts.StartActivityForResult()) { result -&gt;&#10;        if (result.resultCode == android.app.Activity.RESULT_OK) {&#10;            val output = result.data?.let { UCrop.getOutput(it) }&#10;            output?.let { viewModel.onEvent(StoreSettingsUiEvent.LogoCropped(it)) }&#10;        }&#10;    }&#10;&#10;    fun launchCrop(input: Uri) {&#10;        val dest = Uri.fromFile(File(context.cacheDir, &quot;logo_crop_${System.currentTimeMillis()}.jpg&quot;))&#10;        val options = UCrop.Options().apply {&#10;            // Quality &amp; behavior&#10;            setCompressionQuality(85)&#10;            setHideBottomControls(false)&#10;            setFreeStyleCropEnabled(false)&#10;&#10;            // Colors - toolbar&#10;            setToolbarColor(context.getColor(android.R.color.black))&#10;            setStatusBarColor(context.getColor(android.R.color.black))&#10;            setToolbarWidgetColor(context.getColor(android.R.color.white))&#10;&#10;            // Colors - crop frame&#10;            setActiveControlsWidgetColor(context.getColor(android.R.color.holo_green_dark))&#10;            setRootViewBackgroundColor(context.getColor(android.R.color.black))&#10;            setDimmedLayerColor(context.getColor(android.R.color.black))&#10;&#10;            // Toolbar text&#10;            setToolbarTitle(&quot;Crop Logo Toko&quot;)&#10;            setToolbarCancelDrawable(android.R.drawable.ic_menu_close_clear_cancel)&#10;            setToolbarCropDrawable(android.R.drawable.ic_menu_save)&#10;&#10;            // Crop frame display&#10;            setShowCropFrame(true)&#10;            setShowCropGrid(true)&#10;            setCropGridStrokeWidth(2)&#10;            setCropGridColor(context.getColor(android.R.color.white))&#10;            setCropFrameColor(context.getColor(android.R.color.white))&#10;&#10;            // Image settings&#10;            setCircleDimmedLayer(false)&#10;            setCompressionFormat(android.graphics.Bitmap.CompressFormat.JPEG)&#10;        }&#10;        val intent = UCrop.of(input, dest)&#10;            .withAspectRatio(1f, 1f)&#10;            .withMaxResultSize(512, 512)&#10;            .withOptions(options)&#10;            .getIntent(context)&#10;        cropLauncher.launch(intent)&#10;    }&#10;&#10;    val galleryLauncher = rememberLauncherForActivityResult(ActivityResultContracts.GetContent()) { uri -&gt; uri?.let { launchCrop(it) } }&#10;    val cameraLauncher = rememberLauncherForActivityResult(ActivityResultContracts.TakePicture()) { success -&gt;&#10;        if (success) pendingCameraUri?.let { launchCrop(it) }&#10;    }&#10;&#10;    val onPickLogo = { galleryLauncher.launch(&quot;image/*&quot;) }&#10;    val onCaptureLogo = {&#10;        val file = File(context.cacheDir, &quot;logo_cap_${System.currentTimeMillis()}.jpg&quot;)&#10;        val uri = FileProvider.getUriForFile(context, context.packageName + &quot;.fileprovider&quot;, file)&#10;        pendingCameraUri = uri&#10;        cameraLauncher.launch(uri)&#10;    }&#10;&#10;    // Handle error messages&#10;    LaunchedEffect(uiState.error) {&#10;        uiState.error?.let { message -&gt;&#10;            snackbarHostState.showSnackbar(&#10;                message = message,&#10;                duration = SnackbarDuration.Long&#10;            )&#10;            viewModel.onEvent(StoreSettingsUiEvent.DismissError)&#10;        }&#10;    }&#10;&#10;    // Handle success messages&#10;    LaunchedEffect(uiState.successMessage) {&#10;        uiState.successMessage?.let { message -&gt;&#10;            snackbarHostState.showSnackbar(&#10;                message = message,&#10;                duration = SnackbarDuration.Short&#10;            )&#10;            viewModel.onEvent(StoreSettingsUiEvent.DismissSuccess)&#10;        }&#10;    }&#10;&#10;    Scaffold(&#10;        modifier = modifier,&#10;        topBar = {&#10;            TopAppBar(&#10;                title = { Text(&quot;Pengaturan Toko&quot;) },&#10;                navigationIcon = {&#10;                    IconButton(onClick = onNavigateBack) {&#10;                        Icon(&#10;                            imageVector = Icons.AutoMirrored.Filled.ArrowBack,&#10;                            contentDescription = &quot;Kembali&quot;&#10;                        )&#10;                    }&#10;                }&#10;            )&#10;        },&#10;        snackbarHost = {&#10;            SnackbarHost(hostState = snackbarHostState)&#10;        }&#10;    ) { paddingValues -&gt;&#10;        if (uiState.isLoading) {&#10;            Box(&#10;                modifier = Modifier&#10;                    .fillMaxSize()&#10;                    .padding(paddingValues),&#10;                contentAlignment = Alignment.Center&#10;            ) {&#10;                CircularProgressIndicator()&#10;            }&#10;        } else {&#10;            Column(&#10;                modifier = Modifier&#10;                    .fillMaxSize()&#10;                    .padding(paddingValues)&#10;                    .verticalScroll(rememberScrollState())&#10;                    .padding(16.dp),&#10;                verticalArrangement = Arrangement.spacedBy(24.dp)&#10;            ) {&#10;                // Logo Section&#10;                Card(&#10;                    modifier = Modifier.fillMaxWidth(),&#10;                    elevation = CardDefaults.cardElevation(defaultElevation = 2.dp)&#10;                ) {&#10;                    Column(&#10;                        modifier = Modifier&#10;                            .fillMaxWidth()&#10;                            .padding(16.dp),&#10;                        horizontalAlignment = Alignment.CenterHorizontally,&#10;                        verticalArrangement = Arrangement.spacedBy(16.dp)&#10;                    ) {&#10;                        Text(&#10;                            text = &quot;Logo Toko&quot;,&#10;                            style = MaterialTheme.typography.titleMedium&#10;                        )&#10;&#10;                        // Logo Preview with single edit pencil overlay&#10;                        var showLogoOptions by remember { mutableStateOf(false) }&#10;                        Box(&#10;                            modifier = Modifier&#10;                                .size(180.dp)&#10;                                .clip(CircleShape),&#10;                            contentAlignment = Alignment.Center&#10;                        ) {&#10;                            if (uiState.logoPreviewUri != null) {&#10;                                AsyncImage(&#10;                                    model = uiState.logoPreviewUri,&#10;                                    contentDescription = &quot;Logo Toko&quot;,&#10;                                    modifier = Modifier.fillMaxSize(),&#10;                                    contentScale = ContentScale.Crop&#10;                                )&#10;                            } else {&#10;                                Card(&#10;                                    modifier = Modifier.fillMaxSize(),&#10;                                    colors = CardDefaults.cardColors(&#10;                                        containerColor = MaterialTheme.colorScheme.surfaceVariant&#10;                                    ),&#10;                                    onClick = { showLogoOptions = true }&#10;                                ) {&#10;                                    Box(&#10;                                        modifier = Modifier.fillMaxSize(),&#10;                                        contentAlignment = Alignment.Center&#10;                                    ) {&#10;                                        Column(&#10;                                            horizontalAlignment = Alignment.CenterHorizontally,&#10;                                            verticalArrangement = Arrangement.spacedBy(8.dp)&#10;                                        ) {&#10;                                            Icon(&#10;                                                imageVector = Icons.Default.Store,&#10;                                                contentDescription = null,&#10;                                                modifier = Modifier.size(64.dp),&#10;                                                tint = MaterialTheme.colorScheme.outline&#10;                                            )&#10;                                            Text(&#10;                                                text = &quot;Tambah Logo&quot;,&#10;                                                color = MaterialTheme.colorScheme.outline&#10;                                            )&#10;                                        }&#10;                                    }&#10;                                }&#10;                            }&#10;&#10;                            if (uiState.isImageProcessing) {&#10;                                CircularProgressIndicator(&#10;                                    modifier = Modifier.align(Alignment.Center)&#10;                                )&#10;                            }&#10;&#10;                            // Pencil overlay button (bottom-end)&#10;                            IconButton(&#10;                                onClick = { showLogoOptions = true },&#10;                                modifier = Modifier&#10;                                    .align(Alignment.BottomEnd)&#10;                                    .offset(x = (-8).dp, y = (-8).dp)&#10;                                    .clip(CircleShape)&#10;                            ) {&#10;                                Icon(&#10;                                    imageVector = Icons.Default.Edit,&#10;                                    contentDescription = &quot;Ubah Logo&quot;,&#10;                                    tint = MaterialTheme.colorScheme.primary&#10;                                )&#10;                            }&#10;                        }&#10;&#10;                        // Logo options dialog&#10;                        if (showLogoOptions) {&#10;                            AlertDialog(&#10;                                onDismissRequest = { showLogoOptions = false },&#10;                                title = { Text(&quot;Pilih Sumber Logo&quot;) },&#10;                                text = {&#10;                                    Column(verticalArrangement = Arrangement.spacedBy(8.dp)) {&#10;                                        // Galeri&#10;                                        OutlinedButton(onClick = {&#10;                                            showLogoOptions = false&#10;                                            onPickLogo()&#10;                                        }, modifier = Modifier.fillMaxWidth()) {&#10;                                            Icon(Icons.Default.Image, contentDescription = null)&#10;                                            Spacer(Modifier.width(8.dp))&#10;                                            Text(&quot;Pilih dari Galeri&quot;)&#10;                                        }&#10;                                        // Kamera (with runtime permission)&#10;                                        OutlinedButton(onClick = {&#10;                                            showLogoOptions = false&#10;                                            val granted = ContextCompat.checkSelfPermission(context, Manifest.permission.CAMERA) == PackageManager.PERMISSION_GRANTED&#10;                                            if (granted) {&#10;                                                onCaptureLogo()&#10;                                            } else {&#10;                                                requestCameraPermissionLauncher.launch(Manifest.permission.CAMERA)&#10;                                            }&#10;                                        }, modifier = Modifier.fillMaxWidth()) {&#10;                                            Icon(Icons.Default.PhotoCamera, contentDescription = null)&#10;                                            Spacer(Modifier.width(8.dp))&#10;                                            Text(&quot;Ambil dari Kamera&quot;)&#10;                                        }&#10;                                        if (uiState.logoPreviewUri != null) {&#10;                                            OutlinedButton(onClick = {&#10;                                                showLogoOptions = false&#10;                                                viewModel.onEvent(StoreSettingsUiEvent.RemoveLogo)&#10;                                            }, modifier = Modifier.fillMaxWidth(), colors = ButtonDefaults.outlinedButtonColors(&#10;                                                contentColor = MaterialTheme.colorScheme.error&#10;                                            )) {&#10;                                                Icon(Icons.Default.Delete, contentDescription = null)&#10;                                                Spacer(Modifier.width(8.dp))&#10;                                                Text(&quot;Hapus Logo&quot;)&#10;                                            }&#10;                                        }&#10;                                    }&#10;                                },&#10;                                confirmButton = {&#10;                                    TextButton(onClick = { showLogoOptions = false }) { Text(&quot;Tutup&quot;) }&#10;                                }&#10;                            )&#10;                        }&#10;&#10;                        Text(&#10;                            text = &quot;Logo akan ditampilkan pada struk penjualan&quot;,&#10;                            style = MaterialTheme.typography.bodySmall,&#10;                            color = MaterialTheme.colorScheme.onSurfaceVariant&#10;                        )&#10;                    }&#10;                }&#10;&#10;                // Store Info Section (Optional - for future enhancement)&#10;                Card(&#10;                    modifier = Modifier.fillMaxWidth(),&#10;                    elevation = CardDefaults.cardElevation(defaultElevation = 2.dp)&#10;                ) {&#10;                    Column(&#10;                        modifier = Modifier&#10;                            .fillMaxWidth()&#10;                            .padding(16.dp),&#10;                        verticalArrangement = Arrangement.spacedBy(8.dp)&#10;                    ) {&#10;                        Text(&#10;                            text = &quot;Informasi Toko&quot;,&#10;                            style = MaterialTheme.typography.titleMedium&#10;                        )&#10;&#10;                        HorizontalDivider(modifier = Modifier.padding(vertical = 8.dp))&#10;&#10;                        InfoRow(&#10;                            label = &quot;Nama Toko&quot;,&#10;                            value = uiState.settings?.storeName ?: &quot;Belum diatur&quot;&#10;                        )&#10;                        InfoRow(&#10;                            label = &quot;Alamat&quot;,&#10;                            value = uiState.settings?.storeAddress ?: &quot;Belum diatur&quot;&#10;                        )&#10;                        InfoRow(&#10;                            label = &quot;Telepon&quot;,&#10;                            value = uiState.settings?.storePhone ?: &quot;Belum diatur&quot;&#10;                        )&#10;                    }&#10;                }&#10;&#10;                // Printing Settings Section&#10;                Card(&#10;                    modifier = Modifier.fillMaxWidth(),&#10;                    elevation = CardDefaults.cardElevation(defaultElevation = 2.dp)&#10;                ) {&#10;                    val settings = uiState.settings ?: StoreSettings()&#10;                    var paperWidth by remember(settings) { mutableStateOf(settings.paperWidthMm) }&#10;                    var charPerLine by remember(settings) { mutableStateOf(settings.paperCharPerLine) }&#10;                    val format = &quot;THERMAL&quot; // lock to thermal only&#10;                    var autoCut by remember(settings) { mutableStateOf(settings.autoCut) }&#10;                    var printLogo by remember(settings) { mutableStateOf(settings.printLogo) }&#10;                    var useEscPosDirect by remember(settings) { mutableStateOf(settings.useEscPosDirect) }&#10;                    val hasActivePrinter = !((uiState.settings?.printerAddress).isNullOrBlank())&#10;&#10;                    Column(&#10;                        modifier = Modifier&#10;                            .fillMaxWidth()&#10;                            .padding(16.dp),&#10;                        verticalArrangement = Arrangement.spacedBy(12.dp)&#10;                    ) {&#10;                        Text(&quot;Pengaturan Cetak&quot;, style = MaterialTheme.typography.titleMedium)&#10;                        HorizontalDivider()&#10;&#10;                        // Format info (locked to Thermal)&#10;                        Row(Modifier.fillMaxWidth(), horizontalArrangement = Arrangement.SpaceBetween, verticalAlignment = Alignment.CenterVertically) {&#10;                            Text(&quot;Format Cetak&quot;)&#10;                            AssistChip(onClick = {}, label = { Text(&quot;Thermal (aktif)&quot;) }, leadingIcon = {&#10;                                Icon(Icons.Default.CheckCircle, contentDescription = null)&#10;                            }, enabled = false)&#10;                        }&#10;&#10;                        // Paper width selector&#10;                        Row(Modifier.fillMaxWidth(), horizontalArrangement = Arrangement.SpaceBetween, verticalAlignment = Alignment.CenterVertically) {&#10;                            Text(&quot;Lebar Kertas (mm)&quot;)&#10;                            Row(horizontalArrangement = Arrangement.spacedBy(8.dp)) {&#10;                                FilterChip(&#10;                                    selected = paperWidth == 58,&#10;                                    onClick = { paperWidth = 58; charPerLine = 32 },&#10;                                    label = { Text(&quot;58&quot;) },&#10;                                    leadingIcon = if (paperWidth == 58) { { Icon(Icons.Default.Check, contentDescription = null) } } else null&#10;                                )&#10;                                FilterChip(&#10;                                    selected = paperWidth == 80,&#10;                                    onClick = { paperWidth = 80; charPerLine = 48 },&#10;                                    label = { Text(&quot;80&quot;) },&#10;                                    leadingIcon = if (paperWidth == 80) { { Icon(Icons.Default.Check, contentDescription = null) } } else null&#10;                                )&#10;                            }&#10;                        }&#10;                        // Hint chars per line&#10;                        Text(&#10;                            text = if (paperWidth == 58) &quot;58 mm ≈ 32 karakter per baris&quot; else &quot;80 mm ≈ 48 karakter per baris&quot;,&#10;                            style = MaterialTheme.typography.bodySmall,&#10;                            color = MaterialTheme.colorScheme.onSurfaceVariant&#10;                        )&#10;&#10;                        // Options&#10;                        Row(Modifier.fillMaxWidth(), horizontalArrangement = Arrangement.SpaceBetween, verticalAlignment = Alignment.CenterVertically) {&#10;                            Text(&quot;Auto Cut (jika didukung)&quot;)&#10;                            Switch(checked = autoCut, onCheckedChange = { autoCut = it })&#10;                        }&#10;                        Row(Modifier.fillMaxWidth(), horizontalArrangement = Arrangement.SpaceBetween, verticalAlignment = Alignment.CenterVertically) {&#10;                            Text(&quot;Tampilkan Logo di Struk&quot;)&#10;                            Switch(checked = printLogo, onCheckedChange = { printLogo = it })&#10;                        }&#10;                        Row(Modifier.fillMaxWidth(), horizontalArrangement = Arrangement.SpaceBetween, verticalAlignment = Alignment.CenterVertically) {&#10;                            Text(&quot;Cetak langsung ESC/POS (Bluetooth)&quot;)&#10;                            Switch(&#10;                                checked = useEscPosDirect,&#10;                                onCheckedChange = { useEscPosDirect = it },&#10;                                enabled = hasActivePrinter&#10;                            )&#10;                        }&#10;                        if (!hasActivePrinter) {&#10;                            Text(&#10;                                text = &quot;Pilih printer terlebih dahulu untuk mengaktifkan cetak langsung.&quot;,&#10;                                style = MaterialTheme.typography.bodySmall,&#10;                                color = MaterialTheme.colorScheme.onSurfaceVariant&#10;                            )&#10;                        }&#10;&#10;                        // Mini preview (generate thermal pdf and show hint)&#10;                        Text(&quot;Preview Thermal (contoh)&quot;, style = MaterialTheme.typography.titleSmall)&#10;                        Text(&#10;                            text = &quot;Preview PDF akan dibuat saat Cetak/Bagikan. Untuk melihat contoh, selesaikan transaksi lalu buka struk.&quot;,&#10;                            style = MaterialTheme.typography.bodySmall,&#10;                            color = MaterialTheme.colorScheme.onSurfaceVariant&#10;                        )&#10;                        OutlinedButton(&#10;                            onClick = {&#10;                                try {&#10;                                    val effective = uiState.settings ?: StoreSettings()&#10;                                    val txId = UUID.randomUUID().toString()&#10;                                    val items = listOf(&#10;                                        TransactionItemEntity(&#10;                                            transactionId = txId,&#10;                                            productId = &quot;sku-001&quot;,&#10;                                            productName = &quot;Produk Contoh A&quot;,&#10;                                            productPrice = 10000.0,&#10;                                            quantity = 2,&#10;                                            unitPrice = 10000.0,&#10;                                            subtotal = 20000.0&#10;                                        ),&#10;                                        TransactionItemEntity(&#10;                                            transactionId = txId,&#10;                                            productId = &quot;sku-002&quot;,&#10;                                            productName = &quot;Produk Contoh B&quot;,&#10;                                            productPrice = 5000.0,&#10;                                            quantity = 1,&#10;                                            unitPrice = 5000.0,&#10;                                            subtotal = 5000.0&#10;                                        )&#10;                                    )&#10;                                    val subtotal = items.sumOf { it.subtotal }&#10;                                    val tax = if (effective.taxEnabled) subtotal * (effective.taxPercentage / 100.0) else 0.0&#10;                                    val total = subtotal + tax&#10;                                    val tx = TransactionEntity(&#10;                                        transactionNumber = &quot;PREVIEW-${System.currentTimeMillis()}&quot;,&#10;                                        cashierId = &quot;preview&quot;,&#10;                                        cashierName = &quot;Preview&quot;,&#10;                                        paymentMethod = PaymentMethod.CASH,&#10;                                        subtotal = subtotal,&#10;                                        tax = tax,&#10;                                        total = total,&#10;                                        cashReceived = total,&#10;                                        cashChange = 0.0&#10;                                    )&#10;                                    val result = ReceiptPrinter.generateThermalReceiptPdf(context, effective, tx, items)&#10;                                    val file = File(result.pdfUri.path ?: return@OutlinedButton)&#10;                                    val contentUri = FileProvider.getUriForFile(context, context.packageName + &quot;.fileprovider&quot;, file)&#10;                                    val intent = Intent(Intent.ACTION_VIEW).apply {&#10;                                        setDataAndType(contentUri, &quot;application/pdf&quot;)&#10;                                        addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION)&#10;                                    }&#10;                                    val pm = context.packageManager&#10;                                    if (intent.resolveActivity(pm) != null) {&#10;                                        context.startActivity(intent)&#10;                                    } else {&#10;                                        // Fallback: share chooser&#10;                                        ReceiptPrinter.sharePdf(context, contentUri)&#10;                                    }&#10;                                } catch (e: Exception) {&#10;                                    // Ignore preview errors for now&#10;                                }&#10;                            },&#10;                            modifier = Modifier.align(Alignment.Start)&#10;                        ) {&#10;                            Icon(Icons.Default.Preview, contentDescription = null)&#10;                            Spacer(Modifier.width(8.dp))&#10;                            Text(&quot;Preview Struk (Thermal)&quot;)&#10;                        }&#10;&#10;                        // Save button&#10;                        Button(&#10;                            onClick = {&#10;                                val current = uiState.settings ?: StoreSettings()&#10;                                val updated = current.copy(&#10;                                    paperWidthMm = paperWidth,&#10;                                    paperCharPerLine = charPerLine,&#10;                                    printFormat = format,&#10;                                    autoCut = autoCut,&#10;                                    printLogo = printLogo,&#10;                                    useEscPosDirect = useEscPosDirect,&#10;                                    updatedAt = System.currentTimeMillis()&#10;                                )&#10;                                viewModel.onEvent(StoreSettingsUiEvent.Save(updated))&#10;                            },&#10;                            modifier = Modifier.align(Alignment.End)&#10;                        ) {&#10;                            Icon(Icons.Default.Save, contentDescription = null)&#10;                            Spacer(Modifier.width(8.dp))&#10;                            Text(&quot;Simpan Pengaturan&quot;)&#10;                        }&#10;                    }&#10;                }&#10;&#10;                // Bluetooth Printer Picker Section&#10;                Card(&#10;                    modifier = Modifier.fillMaxWidth(),&#10;                    elevation = CardDefaults.cardElevation(defaultElevation = 2.dp)&#10;                ) {&#10;                    val adapter = remember { BluetoothAdapter.getDefaultAdapter() }&#10;                    val btPermission = Manifest.permission.BLUETOOTH_CONNECT&#10;                    val sdk31Plus = remember { android.os.Build.VERSION.SDK_INT &gt;= android.os.Build.VERSION_CODES.S }&#10;                    var hasBtPermission by remember {&#10;                        mutableStateOf(&#10;                            if (sdk31Plus) ContextCompat.checkSelfPermission(context, btPermission) == PackageManager.PERMISSION_GRANTED else true&#10;                        )&#10;                    }&#10;                    val requestBtPermissionLauncher = rememberLauncherForActivityResult(ActivityResultContracts.RequestPermission()) { granted -&gt;&#10;                        hasBtPermission = granted&#10;                    }&#10;                    val bonded = remember(hasBtPermission) { if (hasBtPermission) adapter?.bondedDevices?.toList().orEmpty() else emptyList() }&#10;                    var selectedAddress by remember(uiState.settings) { mutableStateOf(uiState.settings?.printerAddress) }&#10;                    var selectedName by remember(uiState.settings) { mutableStateOf(uiState.settings?.printerName) }&#10;&#10;                    Column(&#10;                        modifier = Modifier&#10;                            .fillMaxWidth()&#10;                            .padding(16.dp),&#10;                        verticalArrangement = Arrangement.spacedBy(12.dp)&#10;                    ) {&#10;                        Text(&quot;Pilih Printer Bluetooth&quot;, style = MaterialTheme.typography.titleMedium)&#10;                        val activeName = uiState.settings?.printerName&#10;                        val activeAddr = uiState.settings?.printerAddress&#10;                        if (!activeAddr.isNullOrBlank()) {&#10;                            Row(Modifier.fillMaxWidth(), horizontalArrangement = Arrangement.SpaceBetween, verticalAlignment = Alignment.CenterVertically) {&#10;                                Column(Modifier.weight(1f)) {&#10;                                    Text(&quot;Printer aktif:&quot;, style = MaterialTheme.typography.bodySmall, color = MaterialTheme.colorScheme.onSurfaceVariant)&#10;                                    Text(activeName ?: &quot;Unknown&quot;, style = MaterialTheme.typography.bodyMedium)&#10;                                    Text(activeAddr, style = MaterialTheme.typography.bodySmall, color = MaterialTheme.colorScheme.onSurfaceVariant)&#10;                                }&#10;                                Icon(imageVector = Icons.Default.CheckCircle, contentDescription = null, tint = MaterialTheme.colorScheme.primary)&#10;                            }&#10;                        }&#10;                        // Test Print button&#10;                        Row(Modifier.fillMaxWidth(), horizontalArrangement = Arrangement.End) {&#10;                            OutlinedButton(onClick = {&#10;                                when {&#10;                                    adapter == null -&gt; scope.launch { snackbarHostState.showSnackbar(&quot;Bluetooth tidak tersedia&quot;) }&#10;                                    !adapter.isEnabled -&gt; scope.launch { snackbarHostState.showSnackbar(&quot;Nyalakan Bluetooth terlebih dahulu&quot;) }&#10;                                    sdk31Plus &amp;&amp; !hasBtPermission -&gt; scope.launch { requestBtPermissionLauncher.launch(btPermission) }&#10;                                    activeAddr.isNullOrBlank() -&gt; scope.launch { snackbarHostState.showSnackbar(&quot;Pilih printer terlebih dahulu&quot;) }&#10;                                    else -&gt; {&#10;                                        scope.launch {&#10;                                            val effective = uiState.settings ?: StoreSettings()&#10;                                            val txId = UUID.randomUUID().toString()&#10;                                            val items = listOf(&#10;                                                TransactionItemEntity(&#10;                                                    transactionId = txId,&#10;                                                    productId = &quot;sku-TEST&quot;,&#10;                                                    productName = &quot;Test Item&quot;,&#10;                                                    productPrice = 1000.0,&#10;                                                    quantity = 1,&#10;                                                    unitPrice = 1000.0,&#10;                                                    subtotal = 1000.0&#10;                                                )&#10;                                            )&#10;                                            val tx = TransactionEntity(&#10;                                                transactionNumber = &quot;TEST-${System.currentTimeMillis()}&quot;,&#10;                                                cashierId = &quot;test&quot;,&#10;                                                cashierName = &quot;Tester&quot;,&#10;                                                paymentMethod = PaymentMethod.CASH,&#10;                                                subtotal = 1000.0,&#10;                                                tax = 0.0,&#10;                                                total = 1000.0,&#10;                                                cashReceived = 1000.0,&#10;                                                cashChange = 0.0&#10;                                            )&#10;                                            ESCPosPrinter.printReceipt(context, effective, tx, items)&#10;                                            snackbarHostState.showSnackbar(&quot;Perintah cetak dikirim&quot;)&#10;                                        }&#10;                                    }&#10;                                }&#10;                            }) {&#10;                                Icon(Icons.Default.Print, contentDescription = null)&#10;                                Spacer(Modifier.width(8.dp))&#10;                                Text(&quot;Test Cetak ESC/POS&quot;)&#10;                            }&#10;                        }&#10;&#10;                        HorizontalDivider()&#10;                        if (adapter == null) {&#10;                            Text(&quot;Bluetooth tidak tersedia di perangkat ini&quot;, color = MaterialTheme.colorScheme.error)&#10;                        } else if (!adapter.isEnabled) {&#10;                            Text(&quot;Bluetooth nonaktif. Aktifkan Bluetooth untuk memilih printer.&quot;, color = MaterialTheme.colorScheme.error)&#10;                        } else if (!hasBtPermission &amp;&amp; sdk31Plus) {&#10;                            Text(&quot;Izin BLUETOOTH_CONNECT diperlukan untuk melihat perangkat.&quot;)&#10;                            OutlinedButton(onClick = { requestBtPermissionLauncher.launch(btPermission) }) {&#10;                                Icon(Icons.Default.Bluetooth, contentDescription = null)&#10;                                Spacer(Modifier.width(8.dp))&#10;                                Text(&quot;Izinkan Bluetooth&quot;)&#10;                            }&#10;                        } else if (bonded.isEmpty()) {&#10;                            Text(&quot;Tidak ada perangkat Bluetooth yang terpasang.&quot;)&#10;                            Text(&quot;Silakan pasangkan printer terlebih dahulu melalui pengaturan Bluetooth.&quot;, style = MaterialTheme.typography.bodySmall)&#10;                        } else {&#10;                            bonded.forEach { device -&gt;&#10;                                val name = device.name ?: &quot;Unknown&quot;&#10;                                val addr = device.address&#10;                                val selected = selectedAddress == addr&#10;                                OutlinedButton(&#10;                                    onClick = {&#10;                                        selectedAddress = addr&#10;                                        selectedName = name&#10;                                        val current = uiState.settings ?: StoreSettings()&#10;                                        viewModel.onEvent(StoreSettingsUiEvent.Save(&#10;                                            current.copy(&#10;                                                printerName = name,&#10;                                                printerAddress = addr,&#10;                                                updatedAt = System.currentTimeMillis()&#10;                                            )&#10;                                        ))&#10;                                        scope.launch { snackbarHostState.showSnackbar(&quot;Printer di-set ke $name&quot;) }&#10;                                    },&#10;                                    modifier = Modifier.fillMaxWidth(),&#10;                                    colors = ButtonDefaults.outlinedButtonColors(&#10;                                        containerColor = if (selected) MaterialTheme.colorScheme.primary.copy(alpha = 0.08f) else MaterialTheme.colorScheme.surface&#10;                                    )&#10;                                ) {&#10;                                    Row(&#10;                                        modifier = Modifier.fillMaxWidth(),&#10;                                        horizontalArrangement = Arrangement.SpaceBetween&#10;                                    ) {&#10;                                        Column {&#10;                                            Text(name)&#10;                                            Text(addr, style = MaterialTheme.typography.bodySmall, color = MaterialTheme.colorScheme.onSurfaceVariant)&#10;                                        }&#10;                                        if (selected) Icon(Icons.Default.Check, contentDescription = null)&#10;                                    }&#10;                                }&#10;                            }&#10;                        }&#10;                    }&#10;                }&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;@Composable&#10;private fun InfoRow(label: String, value: String) {&#10;    Row(&#10;        modifier = Modifier.fillMaxWidth(),&#10;        horizontalArrangement = Arrangement.SpaceBetween&#10;    ) {&#10;        Text(&#10;            text = label,&#10;            style = MaterialTheme.typography.bodyMedium,&#10;            color = MaterialTheme.colorScheme.onSurfaceVariant&#10;        )&#10;        Text(&#10;            text = value,&#10;            style = MaterialTheme.typography.bodyMedium&#10;        )&#10;    }&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>