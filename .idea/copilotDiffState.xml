<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/app/src/main/java/id/stargan/intikasir/feature/history/ui/HistoryScreens.kt">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/id/stargan/intikasir/feature/history/ui/HistoryScreens.kt" />
              <option name="originalContent" value="package id.stargan.intikasir.feature.history.ui&#10;&#10;import androidx.compose.foundation.layout.*&#10;import androidx.compose.foundation.lazy.LazyColumn&#10;import androidx.compose.foundation.lazy.items&#10;import androidx.compose.material.icons.Icons&#10;import androidx.compose.material.icons.automirrored.filled.ArrowBack&#10;import androidx.compose.material.icons.filled.FilterList&#10;import androidx.compose.material.icons.filled.FileDownload&#10;import androidx.compose.material3.*&#10;import androidx.compose.runtime.*&#10;import androidx.compose.ui.Alignment&#10;import androidx.compose.ui.Modifier&#10;import androidx.compose.ui.platform.LocalContext&#10;import androidx.compose.ui.text.font.FontWeight&#10;import androidx.compose.ui.unit.dp&#10;import androidx.hilt.lifecycle.viewmodel.compose.hiltViewModel&#10;import id.stargan.intikasir.data.local.entity.TransactionEntity&#10;import id.stargan.intikasir.data.local.entity.TransactionStatus&#10;import id.stargan.intikasir.feature.history.viewmodel.HistoryEvent&#10;import id.stargan.intikasir.feature.history.viewmodel.HistoryViewModel&#10;import id.stargan.intikasir.feature.history.ui.components.DateRangePickerModal&#10;import id.stargan.intikasir.feature.history.ui.components.formatDateRange&#10;import id.stargan.intikasir.feature.history.util.ExportUtil&#10;import id.stargan.intikasir.ui.common.components.TransactionActions&#10;import id.stargan.intikasir.feature.pos.ui.components.OrderSummaryCard&#10;import kotlinx.coroutines.launch&#10;import java.text.NumberFormat&#10;import java.text.SimpleDateFormat&#10;import java.util.*&#10;&#10;@OptIn(ExperimentalMaterial3Api::class)&#10;@Composable&#10;fun HistoryScreen(&#10;    onBack: () -&gt; Unit,&#10;    onOpenDetail: (String) -&gt; Unit,&#10;    viewModel: HistoryViewModel = hiltViewModel()&#10;) {&#10;    val uiState by viewModel.uiState.collectAsState()&#10;    val toastMessage by viewModel.toastMessage.collectAsState()&#10;    val dateFormatter = remember { SimpleDateFormat(&quot;dd MMM yyyy, HH:mm&quot;, Locale.forLanguageTag(&quot;id-ID&quot;)) }&#10;    val currency = remember { NumberFormat.getCurrencyInstance(Locale.forLanguageTag(&quot;id-ID&quot;)).apply { maximumFractionDigits = 0 } }&#10;    val context = LocalContext.current&#10;    val scope = rememberCoroutineScope()&#10;    val snackbarHostState = remember { SnackbarHostState() }&#10;&#10;    // Calculate summary&#10;    val totalTransactions = uiState.transactions.size&#10;    val totalRevenue = uiState.transactions.sumOf { it.total }&#10;&#10;    var showExportMenu by remember { mutableStateOf(false) }&#10;&#10;    // Show toast message&#10;    LaunchedEffect(toastMessage) {&#10;        toastMessage?.let { message -&gt;&#10;            snackbarHostState.showSnackbar(&#10;                message = message,&#10;                duration = SnackbarDuration.Short&#10;            )&#10;            viewModel.onEvent(HistoryEvent.DismissToast)&#10;        }&#10;    }&#10;&#10;    Scaffold(&#10;        topBar = {&#10;            TopAppBar(&#10;                title = { Text(&quot;Riwayat Transaksi&quot;) },&#10;                navigationIcon = {&#10;                    IconButton(onClick = onBack) {&#10;                        Icon(Icons.AutoMirrored.Filled.ArrowBack, contentDescription = null)&#10;                    }&#10;                },&#10;                actions = {&#10;                    IconButton(onClick = { viewModel.onEvent(HistoryEvent.ToggleFilter) }) {&#10;                        Icon(Icons.Default.FilterList, contentDescription = null)&#10;                    }&#10;                    IconButton(onClick = { showExportMenu = true }) {&#10;                        Icon(Icons.Default.FileDownload, contentDescription = &quot;Export&quot;)&#10;                    }&#10;                    DropdownMenu(&#10;                        expanded = showExportMenu,&#10;                        onDismissRequest = { showExportMenu = false }&#10;                    ) {&#10;                        DropdownMenuItem(&#10;                            text = { Text(&quot;Export Ringkasan CSV&quot;) },&#10;                            onClick = {&#10;                                scope.launch {&#10;                                    // Load items for all transactions&#10;                                    val transactionIds = uiState.transactions.map { it.id }&#10;                                    val itemsMap = viewModel.loadAllTransactionItems(transactionIds)&#10;&#10;                                    val file = ExportUtil.exportToCSV(context, uiState.transactions, itemsMap)&#10;                                    ExportUtil.shareCSV(context, file)&#10;                                    showExportMenu = false&#10;                                    snackbarHostState.showSnackbar(&quot;Laporan berhasil diekspor&quot;)&#10;                                }&#10;                            }&#10;                        )&#10;                        DropdownMenuItem(&#10;                            text = { Text(&quot;Export Detail CSV&quot;) },&#10;                            onClick = {&#10;                                scope.launch {&#10;                                    // Load items for all transactions&#10;                                    val transactionIds = uiState.transactions.map { it.id }&#10;                                    val itemsMap = viewModel.loadAllTransactionItems(transactionIds)&#10;&#10;                                    val file = ExportUtil.exportDetailedToCSV(context, uiState.transactions, itemsMap)&#10;                                    ExportUtil.shareCSV(context, file)&#10;                                    showExportMenu = false&#10;                                    snackbarHostState.showSnackbar(&quot;Laporan detail berhasil diekspor&quot;)&#10;                                }&#10;                            }&#10;                        )&#10;                    }&#10;                }&#10;            )&#10;        },&#10;        snackbarHost = { SnackbarHost(snackbarHostState) }&#10;    ) { padding -&gt;&#10;        Column(&#10;            modifier = Modifier&#10;                .fillMaxSize()&#10;                .padding(padding)&#10;        ) {&#10;            if (uiState.showFilter) {&#10;                HistoryFilterBar(&#10;                    selectedRange = uiState.range,&#10;                    startDate = uiState.startDate,&#10;                    endDate = uiState.endDate,&#10;                    selectedStatus = uiState.selectedStatus,&#10;                    onRangeChange = { viewModel.onEvent(HistoryEvent.ChangeRange(it)) },&#10;                    onStartDateChange = { viewModel.onEvent(HistoryEvent.ChangeStartDate(it)) },&#10;                    onEndDateChange = { viewModel.onEvent(HistoryEvent.ChangeEndDate(it)) },&#10;                    onStatusChange = { viewModel.onEvent(HistoryEvent.ChangeStatus(it)) },&#10;                    onApply = { viewModel.onEvent(HistoryEvent.ApplyFilter) }&#10;                )&#10;            }&#10;&#10;            // Summary Card&#10;            if (!uiState.isLoading &amp;&amp; uiState.transactions.isNotEmpty()) {&#10;                Card(&#10;                    modifier = Modifier&#10;                        .fillMaxWidth()&#10;                        .padding(horizontal = 12.dp, vertical = 8.dp),&#10;                    colors = CardDefaults.cardColors(&#10;                        containerColor = MaterialTheme.colorScheme.primaryContainer&#10;                    )&#10;                ) {&#10;                    Row(&#10;                        modifier = Modifier&#10;                            .fillMaxWidth()&#10;                            .padding(16.dp),&#10;                        horizontalArrangement = Arrangement.SpaceBetween&#10;                    ) {&#10;                        Column {&#10;                            Text(&#10;                                text = &quot;Total Transaksi&quot;,&#10;                                style = MaterialTheme.typography.bodySmall,&#10;                                color = MaterialTheme.colorScheme.onPrimaryContainer&#10;                            )&#10;                            Text(&#10;                                text = &quot;$totalTransactions&quot;,&#10;                                style = MaterialTheme.typography.titleLarge,&#10;                                fontWeight = FontWeight.Bold,&#10;                                color = MaterialTheme.colorScheme.onPrimaryContainer&#10;                            )&#10;                        }&#10;                        Column(horizontalAlignment = Alignment.End) {&#10;                            Text(&#10;                                text = &quot;Total Pendapatan&quot;,&#10;                                style = MaterialTheme.typography.bodySmall,&#10;                                color = MaterialTheme.colorScheme.onPrimaryContainer&#10;                            )&#10;                            Text(&#10;                                text = currency.format(totalRevenue).replace(&quot;Rp&quot;, &quot;Rp &quot;),&#10;                                style = MaterialTheme.typography.titleLarge,&#10;                                fontWeight = FontWeight.Bold,&#10;                                color = MaterialTheme.colorScheme.onPrimaryContainer&#10;                            )&#10;                        }&#10;                    }&#10;                }&#10;            }&#10;&#10;            if (uiState.isLoading) {&#10;                Box(modifier = Modifier.fillMaxSize(), contentAlignment = Alignment.Center) {&#10;                    CircularProgressIndicator()&#10;                }&#10;            } else {&#10;                LazyColumn(modifier = Modifier.fillMaxSize(), contentPadding = PaddingValues(12.dp), verticalArrangement = Arrangement.spacedBy(8.dp)) {&#10;                    items(uiState.transactions) { tx -&gt;&#10;                        TransactionRow(&#10;                            tx = tx,&#10;                            currency = currency,&#10;                            dateFormatter = dateFormatter,&#10;                            onClick = { onOpenDetail(tx.id) }&#10;                        )&#10;                    }&#10;                }&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;@Composable&#10;private fun HistoryFilterBar(&#10;    selectedRange: DateRange,&#10;    startDate: Long,&#10;    endDate: Long,&#10;    selectedStatus: TransactionStatus?,&#10;    onRangeChange: (DateRange) -&gt; Unit,&#10;    onStartDateChange: (Long) -&gt; Unit,&#10;    onEndDateChange: (Long) -&gt; Unit,&#10;    onStatusChange: (TransactionStatus?) -&gt; Unit,&#10;    onApply: () -&gt; Unit&#10;) {&#10;    var showDatePicker by remember { mutableStateOf(false) }&#10;&#10;    Column(Modifier.fillMaxWidth().padding(12.dp), verticalArrangement = Arrangement.spacedBy(8.dp)) {&#10;        // Date range chips&#10;        Text(&quot;Periode&quot;, style = MaterialTheme.typography.labelMedium)&#10;        FlowRow(horizontalArrangement = Arrangement.spacedBy(8.dp)) {&#10;            DateRange.entries.forEach { range -&gt;&#10;                FilterChip(&#10;                    selected = selectedRange == range,&#10;                    onClick = { onRangeChange(range) },&#10;                    label = { Text(range.label) }&#10;                )&#10;            }&#10;        }&#10;&#10;        // Show date range for custom&#10;        if (selectedRange == DateRange.CUSTOM) {&#10;            OutlinedButton(&#10;                onClick = { showDatePicker = true },&#10;                modifier = Modifier.fillMaxWidth()&#10;            ) {&#10;                Text(formatDateRange(startDate, endDate))&#10;            }&#10;        }&#10;&#10;        // Status filter&#10;        Text(&quot;Status&quot;, style = MaterialTheme.typography.labelMedium)&#10;        FlowRow(horizontalArrangement = Arrangement.spacedBy(8.dp)) {&#10;            FilterChip(&#10;                selected = selectedStatus == null,&#10;                onClick = { onStatusChange(null) },&#10;                label = { Text(&quot;Semua&quot;) }&#10;            )&#10;            TransactionStatus.entries.forEach { status -&gt;&#10;                FilterChip(&#10;                    selected = selectedStatus == status,&#10;                    onClick = { onStatusChange(status) },&#10;                    label = { Text(status.name) }&#10;                )&#10;            }&#10;        }&#10;&#10;        Row(Modifier.fillMaxWidth(), horizontalArrangement = Arrangement.End) {&#10;            Button(onClick = onApply) { Text(&quot;Terapkan&quot;) }&#10;        }&#10;    }&#10;&#10;    DateRangePickerModal(&#10;        showDialog = showDatePicker,&#10;        onDismiss = { showDatePicker = false },&#10;        onDateRangeSelected = { start, end -&gt;&#10;            onStartDateChange(start)&#10;            onEndDateChange(end)&#10;        }&#10;    )&#10;}&#10;&#10;@Composable&#10;private fun TransactionRow(&#10;    tx: TransactionEntity,&#10;    currency: NumberFormat,&#10;    dateFormatter: SimpleDateFormat,&#10;    onClick: () -&gt; Unit&#10;) {&#10;    ElevatedCard(onClick = onClick) {&#10;        Row(&#10;            modifier = Modifier.fillMaxWidth().padding(12.dp),&#10;            horizontalArrangement = Arrangement.SpaceBetween,&#10;            verticalAlignment = Alignment.CenterVertically&#10;        ) {&#10;            Column(Modifier.weight(1f)) {&#10;                Text(tx.transactionNumber, style = MaterialTheme.typography.titleMedium, fontWeight = FontWeight.Bold)&#10;                Text(dateFormatter.format(Date(tx.updatedAt)), style = MaterialTheme.typography.bodySmall)&#10;                Text(&quot;Kasir: ${tx.cashierName}&quot;, style = MaterialTheme.typography.bodySmall)&#10;            }&#10;            Column(horizontalAlignment = Alignment.End) {&#10;                Text(currency.format(tx.total).replace(&quot;Rp&quot;, &quot;Rp &quot;), style = MaterialTheme.typography.titleMedium)&#10;                Text(tx.status.name, style = MaterialTheme.typography.bodySmall)&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;@OptIn(ExperimentalMaterial3Api::class)&#10;@Composable&#10;fun HistoryDetailScreen(&#10;    transactionId: String,&#10;    onBack: () -&gt; Unit,&#10;    onPrint: (TransactionEntity) -&gt; Unit,&#10;    onShare: (TransactionEntity) -&gt; Unit,&#10;    onDelete: (TransactionEntity) -&gt; Unit,&#10;    onEdit: (String) -&gt; Unit,&#10;    onPrintQueue: (TransactionEntity) -&gt; Unit,&#10;    onComplete: (TransactionEntity) -&gt; Unit,&#10;    isAdmin: Boolean = false,&#10;    viewModel: HistoryViewModel = hiltViewModel()&#10;) {&#10;    val uiState by viewModel.detailUiState.collectAsState()&#10;    val listUiState by viewModel.uiState.collectAsState()&#10;    val toastMessage by viewModel.toastMessage.collectAsState()&#10;    val currency = remember { NumberFormat.getCurrencyInstance(Locale.forLanguageTag(&quot;id-ID&quot;)).apply { maximumFractionDigits = 0 } }&#10;    val dateFormatter = remember { SimpleDateFormat(&quot;dd MMM yyyy, HH:mm&quot;, Locale.forLanguageTag(&quot;id-ID&quot;)) }&#10;    val snackbarHostState = remember { SnackbarHostState() }&#10;    val scope = rememberCoroutineScope()&#10;&#10;    LaunchedEffect(transactionId) { viewModel.onEvent(HistoryEvent.LoadDetail(transactionId)) }&#10;&#10;    // Show toast message&#10;    LaunchedEffect(toastMessage) {&#10;        toastMessage?.let { message -&gt;&#10;            snackbarHostState.showSnackbar(&#10;                message = message,&#10;                duration = SnackbarDuration.Short&#10;            )&#10;            viewModel.onEvent(HistoryEvent.DismissToast)&#10;        }&#10;    }&#10;&#10;    // Delete confirmation dialog&#10;    if (listUiState.showDeleteDialog) {&#10;        AlertDialog(&#10;            onDismissRequest = { viewModel.onEvent(HistoryEvent.DismissDeleteConfirmation) },&#10;            title = { Text(&quot;Hapus Transaksi?&quot;) },&#10;            text = { Text(&quot;Transaksi yang dihapus tidak dapat dikembalikan. Apakah Anda yakin ingin menghapus transaksi ini?&quot;) },&#10;            confirmButton = {&#10;                Button(&#10;                    onClick = {&#10;                        viewModel.onEvent(HistoryEvent.ConfirmDelete)&#10;                        onDelete(uiState.transaction!!)&#10;                    },&#10;                    colors = ButtonDefaults.buttonColors(&#10;                        containerColor = MaterialTheme.colorScheme.error&#10;                    )&#10;                ) {&#10;                    Text(&quot;Hapus&quot;)&#10;                }&#10;            },&#10;            dismissButton = {&#10;                TextButton(onClick = { viewModel.onEvent(HistoryEvent.DismissDeleteConfirmation) }) {&#10;                    Text(&quot;Batal&quot;)&#10;                }&#10;            }&#10;        )&#10;    }&#10;&#10;    Scaffold(&#10;        topBar = {&#10;            TopAppBar(&#10;                title = { Text(&quot;Detil Transaksi&quot;) },&#10;                navigationIcon = {&#10;                    IconButton(onClick = onBack) { Icon(Icons.AutoMirrored.Filled.ArrowBack, contentDescription = null) }&#10;                }&#10;            )&#10;        },&#10;        snackbarHost = { SnackbarHost(snackbarHostState) }&#10;    ) { padding -&gt;&#10;        if (uiState.isLoading) {&#10;            Box(Modifier.fillMaxSize().padding(padding), contentAlignment = Alignment.Center) { CircularProgressIndicator() }&#10;        } else uiState.transaction?.let { tx -&gt;&#10;            LazyColumn(&#10;                modifier = Modifier.fillMaxSize().padding(padding),&#10;                contentPadding = PaddingValues(16.dp),&#10;                verticalArrangement = Arrangement.spacedBy(12.dp)&#10;            ) {&#10;                item {&#10;                    Text(tx.transactionNumber, style = MaterialTheme.typography.titleLarge, fontWeight = FontWeight.Bold)&#10;                    Text(&quot;Tanggal: ${dateFormatter.format(Date(tx.updatedAt))}&quot;)&#10;                    Text(&quot;Kasir: ${tx.cashierName}&quot;)&#10;                    Text(&quot;Status: ${tx.status.name}&quot;)&#10;                    Text(&quot;Metode Bayar: ${tx.paymentMethod.name}&quot;)&#10;                    HorizontalDivider()&#10;                }&#10;                // Items header&#10;                if (uiState.items.isNotEmpty()) {&#10;                    item {&#10;                        Row(&#10;                            modifier = Modifier.fillMaxWidth(),&#10;                            horizontalArrangement = Arrangement.SpaceBetween,&#10;                            verticalAlignment = Alignment.CenterVertically&#10;                        ) {&#10;                            Text(&quot;Item Dibeli&quot;, style = MaterialTheme.typography.titleMedium)&#10;                            Text(&#10;                                &quot;${uiState.items.size} item • ${uiState.items.sumOf { it.quantity }} pcs&quot;,&#10;                                style = MaterialTheme.typography.bodySmall,&#10;                                color = MaterialTheme.colorScheme.onSurfaceVariant&#10;                            )&#10;                        }&#10;                    }&#10;                    items(uiState.items) { item -&gt;&#10;                        ItemDetailRow(&#10;                            name = item.productName,&#10;                            quantity = item.quantity,&#10;                            unitPrice = item.unitPrice,&#10;                            discount = item.discount,&#10;                            subtotal = item.subtotal,&#10;                            currency = currency&#10;                        )&#10;                    }&#10;                    item { HorizontalDivider() }&#10;                } else {&#10;                    item { Text(&quot;Tidak ada item&quot;, style = MaterialTheme.typography.bodyMedium) }&#10;                }&#10;&#10;                // Order Summary using OrderSummaryCard component&#10;                item {&#10;                    // Calculate values&#10;                    val grossSubtotal = uiState.items.sumOf { it.unitPrice * it.quantity }&#10;                    val itemDiscount = uiState.items.sumOf { it.discount }&#10;                    val netSubtotal = tx.subtotal&#10;                    val taxRate = if (netSubtotal &gt; 0 &amp;&amp; tx.tax &gt; 0) tx.tax / netSubtotal else 0.0&#10;                    val globalDiscount = tx.discount&#10;&#10;                    OrderSummaryCard(&#10;                        grossSubtotal = grossSubtotal,&#10;                        itemDiscount = itemDiscount,&#10;                        netSubtotal = netSubtotal,&#10;                        taxRate = taxRate,&#10;                        taxAmount = tx.tax,&#10;                        globalDiscount = globalDiscount,&#10;                        total = tx.total&#10;                    )&#10;&#10;                    // Cash payment details (if applicable)&#10;                    if (tx.cashReceived &gt; 0) {&#10;                        Spacer(Modifier.height(8.dp))&#10;                        Card(&#10;                            modifier = Modifier.fillMaxWidth(),&#10;                            colors = CardDefaults.cardColors(&#10;                                containerColor = MaterialTheme.colorScheme.surfaceVariant&#10;                            )&#10;                        ) {&#10;                            Column(&#10;                                modifier = Modifier.padding(12.dp),&#10;                                verticalArrangement = Arrangement.spacedBy(6.dp)&#10;                            ) {&#10;                                Text(&#10;                                    &quot;Detail Pembayaran Tunai&quot;,&#10;                                    style = MaterialTheme.typography.titleSmall,&#10;                                    fontWeight = FontWeight.SemiBold&#10;                                )&#10;                                HorizontalDivider()&#10;&#10;                                val receivedStr = currency.format(tx.cashReceived).replace(&quot;Rp&quot;, &quot;Rp &quot;)&#10;                                val changeStr = currency.format(tx.cashChange).replace(&quot;Rp&quot;, &quot;Rp &quot;)&#10;&#10;                                Row(&#10;                                    modifier = Modifier.fillMaxWidth(),&#10;                                    horizontalArrangement = Arrangement.SpaceBetween&#10;                                ) {&#10;                                    Text(&quot;Tunai Diterima&quot;, style = MaterialTheme.typography.bodySmall)&#10;                                    Text(receivedStr, style = MaterialTheme.typography.bodySmall)&#10;                                }&#10;                                Row(&#10;                                    modifier = Modifier.fillMaxWidth(),&#10;                                    horizontalArrangement = Arrangement.SpaceBetween&#10;                                ) {&#10;                                    Text(&#10;                                        &quot;Kembalian&quot;,&#10;                                        style = MaterialTheme.typography.bodySmall,&#10;                                        fontWeight = FontWeight.Medium&#10;                                    )&#10;                                    Text(&#10;                                        changeStr,&#10;                                        style = MaterialTheme.typography.bodySmall,&#10;                                        fontWeight = FontWeight.Medium,&#10;                                        color = MaterialTheme.colorScheme.primary&#10;                                    )&#10;                                }&#10;                            }&#10;                        }&#10;                    }&#10;&#10;                    HorizontalDivider()&#10;                }&#10;                // Actions - using reusable TransactionActions component&#10;                item {&#10;                    TransactionActions(&#10;                        status = tx.status,&#10;                        onEdit = { onEdit(tx.id) },&#10;                        onPrint = { onPrint(tx) },&#10;                        onShare = { onShare(tx) },&#10;                        onPrintQueue = {&#10;                            onPrintQueue(tx)&#10;                            scope.launch { snackbarHostState.showSnackbar(&quot;Tiket antrian dicetak&quot;) }&#10;                        },&#10;                        onComplete = {&#10;                            onComplete(tx)&#10;                            scope.launch { snackbarHostState.showSnackbar(&quot;Transaksi ditandai selesai&quot;) }&#10;                        },&#10;                        isAdmin = isAdmin,&#10;                        onDeleteAdmin = { viewModel.onEvent(HistoryEvent.ShowDeleteConfirmation(tx.id)) }&#10;                    )&#10;                }&#10;                // Bottom spacing&#10;                item { Spacer(Modifier.height(32.dp)) }&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;@Composable&#10;private fun ItemDetailRow(&#10;    name: String,&#10;    quantity: Int,&#10;    unitPrice: Double,&#10;    discount: Double,&#10;    subtotal: Double,&#10;    currency: NumberFormat&#10;) {&#10;    ElevatedCard {&#10;        Column(Modifier.fillMaxWidth().padding(12.dp), verticalArrangement = Arrangement.spacedBy(4.dp)) {&#10;            Text(name, style = MaterialTheme.typography.bodyMedium, fontWeight = FontWeight.SemiBold)&#10;            val unitStr = currency.format(unitPrice).replace(&quot;Rp&quot;, &quot;Rp &quot;)&#10;            val subStr = currency.format(subtotal).replace(&quot;Rp&quot;, &quot;Rp &quot;)&#10;            Text(&quot;$quantity x $unitStr = $subStr&quot;, style = MaterialTheme.typography.bodySmall)&#10;            if (discount &gt; 0) {&#10;                val discountStr = currency.format(discount).replace(&quot;Rp&quot;, &quot;Rp &quot;)&#10;                Text(&quot;Diskon item: -$discountStr&quot;, style = MaterialTheme.typography.bodySmall, color = MaterialTheme.colorScheme.primary)&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;enum class DateRange(val label: String) {&#10;    TODAY(&quot;Hari ini&quot;),&#10;    YESTERDAY(&quot;Kemarin&quot;),&#10;    LAST_7_DAYS(&quot;7 hari terakhir&quot;),&#10;    THIS_MONTH(&quot;Bulan ini&quot;),&#10;    LAST_MONTH(&quot;Bulan lalu&quot;),&#10;    CUSTOM(&quot;Custom&quot;)&#10;}&#10;" />
              <option name="updatedContent" value="package id.stargan.intikasir.feature.history.ui&#10;&#10;import androidx.compose.foundation.layout.*&#10;import androidx.compose.foundation.lazy.LazyColumn&#10;import androidx.compose.foundation.lazy.items&#10;import androidx.compose.material.icons.Icons&#10;import androidx.compose.material.icons.automirrored.filled.ArrowBack&#10;import androidx.compose.material.icons.filled.FilterList&#10;import androidx.compose.material.icons.filled.FileDownload&#10;import androidx.compose.material3.*&#10;import androidx.compose.runtime.*&#10;import androidx.compose.ui.Alignment&#10;import androidx.compose.ui.Modifier&#10;import androidx.compose.ui.platform.LocalContext&#10;import androidx.compose.ui.text.font.FontWeight&#10;import androidx.compose.ui.unit.dp&#10;import androidx.hilt.lifecycle.viewmodel.compose.hiltViewModel&#10;import id.stargan.intikasir.data.local.entity.TransactionEntity&#10;import id.stargan.intikasir.data.local.entity.TransactionStatus&#10;import id.stargan.intikasir.feature.history.viewmodel.HistoryEvent&#10;import id.stargan.intikasir.feature.history.viewmodel.HistoryViewModel&#10;import id.stargan.intikasir.feature.history.ui.components.DateRangePickerModal&#10;import id.stargan.intikasir.feature.history.ui.components.formatDateRange&#10;import id.stargan.intikasir.feature.history.util.ExportUtil&#10;import id.stargan.intikasir.ui.common.components.TransactionActions&#10;import id.stargan.intikasir.feature.pos.ui.components.OrderSummaryCard&#10;import kotlinx.coroutines.launch&#10;import java.text.NumberFormat&#10;import java.text.SimpleDateFormat&#10;import java.util.*&#10;&#10;@OptIn(ExperimentalMaterial3Api::class)&#10;@Composable&#10;fun HistoryScreen(&#10;    onBack: () -&gt; Unit,&#10;    onOpenDetail: (String) -&gt; Unit,&#10;    viewModel: HistoryViewModel = hiltViewModel()&#10;) {&#10;    val uiState by viewModel.uiState.collectAsState()&#10;    val toastMessage by viewModel.toastMessage.collectAsState()&#10;    val dateFormatter = remember { SimpleDateFormat(&quot;dd MMM yyyy, HH:mm&quot;, Locale.forLanguageTag(&quot;id-ID&quot;)) }&#10;    val currency = remember { NumberFormat.getCurrencyInstance(Locale.forLanguageTag(&quot;id-ID&quot;)).apply { maximumFractionDigits = 0 } }&#10;    val context = LocalContext.current&#10;    val scope = rememberCoroutineScope()&#10;    val snackbarHostState = remember { SnackbarHostState() }&#10;&#10;    // Calculate summary&#10;    val totalTransactions = uiState.transactions.size&#10;    val totalRevenue = uiState.transactions.sumOf { it.total }&#10;&#10;    var showExportMenu by remember { mutableStateOf(false) }&#10;&#10;    // Show toast message&#10;    LaunchedEffect(toastMessage) {&#10;        toastMessage?.let { message -&gt;&#10;            snackbarHostState.showSnackbar(&#10;                message = message,&#10;                duration = SnackbarDuration.Short&#10;            )&#10;            viewModel.onEvent(HistoryEvent.DismissToast)&#10;        }&#10;    }&#10;&#10;    Scaffold(&#10;        topBar = {&#10;            TopAppBar(&#10;                title = { Text(&quot;Riwayat Transaksi&quot;) },&#10;                navigationIcon = {&#10;                    IconButton(onClick = onBack) {&#10;                        Icon(Icons.AutoMirrored.Filled.ArrowBack, contentDescription = null)&#10;                    }&#10;                },&#10;                actions = {&#10;                    IconButton(onClick = { viewModel.onEvent(HistoryEvent.ToggleFilter) }) {&#10;                        Icon(Icons.Default.FilterList, contentDescription = null)&#10;                    }&#10;                    IconButton(onClick = { showExportMenu = true }) {&#10;                        Icon(Icons.Default.FileDownload, contentDescription = &quot;Export&quot;)&#10;                    }&#10;                    DropdownMenu(&#10;                        expanded = showExportMenu,&#10;                        onDismissRequest = { showExportMenu = false }&#10;                    ) {&#10;                        DropdownMenuItem(&#10;                            text = { Text(&quot;Export Ringkasan CSV&quot;) },&#10;                            onClick = {&#10;                                scope.launch {&#10;                                    // Load items for all transactions&#10;                                    val transactionIds = uiState.transactions.map { it.id }&#10;                                    val itemsMap = viewModel.loadAllTransactionItems(transactionIds)&#10;&#10;                                    val file = ExportUtil.exportToCSV(context, uiState.transactions, itemsMap)&#10;                                    ExportUtil.shareCSV(context, file)&#10;                                    showExportMenu = false&#10;                                    snackbarHostState.showSnackbar(&quot;Laporan berhasil diekspor&quot;)&#10;                                }&#10;                            }&#10;                        )&#10;                        DropdownMenuItem(&#10;                            text = { Text(&quot;Export Detail CSV&quot;) },&#10;                            onClick = {&#10;                                scope.launch {&#10;                                    // Load items for all transactions&#10;                                    val transactionIds = uiState.transactions.map { it.id }&#10;                                    val itemsMap = viewModel.loadAllTransactionItems(transactionIds)&#10;&#10;                                    val file = ExportUtil.exportDetailedToCSV(context, uiState.transactions, itemsMap)&#10;                                    ExportUtil.shareCSV(context, file)&#10;                                    showExportMenu = false&#10;                                    snackbarHostState.showSnackbar(&quot;Laporan detail berhasil diekspor&quot;)&#10;                                }&#10;                            }&#10;                        )&#10;                    }&#10;                }&#10;            )&#10;        },&#10;        snackbarHost = { SnackbarHost(snackbarHostState) }&#10;    ) { padding -&gt;&#10;        Column(&#10;            modifier = Modifier&#10;                .fillMaxSize()&#10;                .padding(padding)&#10;        ) {&#10;            if (uiState.showFilter) {&#10;                HistoryFilterBar(&#10;                    selectedRange = uiState.range,&#10;                    startDate = uiState.startDate,&#10;                    endDate = uiState.endDate,&#10;                    selectedStatus = uiState.selectedStatus,&#10;                    onRangeChange = { viewModel.onEvent(HistoryEvent.ChangeRange(it)) },&#10;                    onStartDateChange = { viewModel.onEvent(HistoryEvent.ChangeStartDate(it)) },&#10;                    onEndDateChange = { viewModel.onEvent(HistoryEvent.ChangeEndDate(it)) },&#10;                    onStatusChange = { viewModel.onEvent(HistoryEvent.ChangeStatus(it)) },&#10;                    onApply = { viewModel.onEvent(HistoryEvent.ApplyFilter) }&#10;                )&#10;            }&#10;&#10;            // Summary Card&#10;            if (!uiState.isLoading &amp;&amp; uiState.transactions.isNotEmpty()) {&#10;                Card(&#10;                    modifier = Modifier&#10;                        .fillMaxWidth()&#10;                        .padding(horizontal = 12.dp, vertical = 8.dp),&#10;                    colors = CardDefaults.cardColors(&#10;                        containerColor = MaterialTheme.colorScheme.primaryContainer&#10;                    )&#10;                ) {&#10;                    Row(&#10;                        modifier = Modifier&#10;                            .fillMaxWidth()&#10;                            .padding(16.dp),&#10;                        horizontalArrangement = Arrangement.SpaceBetween&#10;                    ) {&#10;                        Column {&#10;                            Text(&#10;                                text = &quot;Total Transaksi&quot;,&#10;                                style = MaterialTheme.typography.bodySmall,&#10;                                color = MaterialTheme.colorScheme.onPrimaryContainer&#10;                            )&#10;                            Text(&#10;                                text = &quot;$totalTransactions&quot;,&#10;                                style = MaterialTheme.typography.titleLarge,&#10;                                fontWeight = FontWeight.Bold,&#10;                                color = MaterialTheme.colorScheme.onPrimaryContainer&#10;                            )&#10;                        }&#10;                        Column(horizontalAlignment = Alignment.End) {&#10;                            Text(&#10;                                text = &quot;Total Pendapatan&quot;,&#10;                                style = MaterialTheme.typography.bodySmall,&#10;                                color = MaterialTheme.colorScheme.onPrimaryContainer&#10;                            )&#10;                            Text(&#10;                                text = currency.format(totalRevenue).replace(&quot;Rp&quot;, &quot;Rp &quot;),&#10;                                style = MaterialTheme.typography.titleLarge,&#10;                                fontWeight = FontWeight.Bold,&#10;                                color = MaterialTheme.colorScheme.onPrimaryContainer&#10;                            )&#10;                        }&#10;                    }&#10;                }&#10;            }&#10;&#10;            if (uiState.isLoading) {&#10;                Box(modifier = Modifier.fillMaxSize(), contentAlignment = Alignment.Center) {&#10;                    CircularProgressIndicator()&#10;                }&#10;            } else {&#10;                LazyColumn(modifier = Modifier.fillMaxSize(), contentPadding = PaddingValues(12.dp), verticalArrangement = Arrangement.spacedBy(8.dp)) {&#10;                    items(uiState.transactions) { tx -&gt;&#10;                        TransactionRow(&#10;                            tx = tx,&#10;                            currency = currency,&#10;                            dateFormatter = dateFormatter,&#10;                            onClick = { onOpenDetail(tx.id) }&#10;                        )&#10;                    }&#10;                }&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;@Composable&#10;private fun HistoryFilterBar(&#10;    selectedRange: DateRange,&#10;    startDate: Long,&#10;    endDate: Long,&#10;    selectedStatus: TransactionStatus?,&#10;    onRangeChange: (DateRange) -&gt; Unit,&#10;    onStartDateChange: (Long) -&gt; Unit,&#10;    onEndDateChange: (Long) -&gt; Unit,&#10;    onStatusChange: (TransactionStatus?) -&gt; Unit,&#10;    onApply: () -&gt; Unit&#10;) {&#10;    var showDatePicker by remember { mutableStateOf(false) }&#10;&#10;    Column(Modifier.fillMaxWidth().padding(12.dp), verticalArrangement = Arrangement.spacedBy(8.dp)) {&#10;        // Date range chips&#10;        Text(&quot;Periode&quot;, style = MaterialTheme.typography.labelMedium)&#10;        FlowRow(horizontalArrangement = Arrangement.spacedBy(8.dp)) {&#10;            DateRange.entries.forEach { range -&gt;&#10;                FilterChip(&#10;                    selected = selectedRange == range,&#10;                    onClick = { onRangeChange(range) },&#10;                    label = { Text(range.label) }&#10;                )&#10;            }&#10;        }&#10;&#10;        // Show date range for custom&#10;        if (selectedRange == DateRange.CUSTOM) {&#10;            OutlinedButton(&#10;                onClick = { showDatePicker = true },&#10;                modifier = Modifier.fillMaxWidth()&#10;            ) {&#10;                Text(formatDateRange(startDate, endDate))&#10;            }&#10;        }&#10;&#10;        // Status filter&#10;        Text(&quot;Status&quot;, style = MaterialTheme.typography.labelMedium)&#10;        FlowRow(horizontalArrangement = Arrangement.spacedBy(8.dp)) {&#10;            FilterChip(&#10;                selected = selectedStatus == null,&#10;                onClick = { onStatusChange(null) },&#10;                label = { Text(&quot;Semua&quot;) }&#10;            )&#10;            TransactionStatus.entries.forEach { status -&gt;&#10;                FilterChip(&#10;                    selected = selectedStatus == status,&#10;                    onClick = { onStatusChange(status) },&#10;                    label = { Text(status.name) }&#10;                )&#10;            }&#10;        }&#10;&#10;        Row(Modifier.fillMaxWidth(), horizontalArrangement = Arrangement.End) {&#10;            Button(onClick = onApply) { Text(&quot;Terapkan&quot;) }&#10;        }&#10;    }&#10;&#10;    DateRangePickerModal(&#10;        showDialog = showDatePicker,&#10;        onDismiss = { showDatePicker = false },&#10;        onDateRangeSelected = { start, end -&gt;&#10;            onStartDateChange(start)&#10;            onEndDateChange(end)&#10;        }&#10;    )&#10;}&#10;&#10;@Composable&#10;private fun TransactionRow(&#10;    tx: TransactionEntity,&#10;    currency: NumberFormat,&#10;    dateFormatter: SimpleDateFormat,&#10;    onClick: () -&gt; Unit&#10;) {&#10;    ElevatedCard(onClick = onClick) {&#10;        Row(&#10;            modifier = Modifier.fillMaxWidth().padding(12.dp),&#10;            horizontalArrangement = Arrangement.SpaceBetween,&#10;            verticalAlignment = Alignment.CenterVertically&#10;        ) {&#10;            Column(Modifier.weight(1f)) {&#10;                Text(tx.transactionNumber, style = MaterialTheme.typography.titleMedium, fontWeight = FontWeight.Bold)&#10;                Text(dateFormatter.format(Date(tx.updatedAt)), style = MaterialTheme.typography.bodySmall)&#10;                Text(&quot;Kasir: ${tx.cashierName}&quot;, style = MaterialTheme.typography.bodySmall)&#10;            }&#10;            Column(horizontalAlignment = Alignment.End) {&#10;                Text(currency.format(tx.total).replace(&quot;Rp&quot;, &quot;Rp &quot;), style = MaterialTheme.typography.titleMedium)&#10;                Text(tx.status.name, style = MaterialTheme.typography.bodySmall)&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;@OptIn(ExperimentalMaterial3Api::class)&#10;@Composable&#10;fun HistoryDetailScreen(&#10;    transactionId: String,&#10;    onBack: () -&gt; Unit,&#10;    onPrint: (TransactionEntity) -&gt; Unit,&#10;    onShare: (TransactionEntity) -&gt; Unit,&#10;    onDelete: (TransactionEntity) -&gt; Unit,&#10;    onEdit: (String) -&gt; Unit,&#10;    onPrintQueue: (TransactionEntity) -&gt; Unit,&#10;    onComplete: (TransactionEntity) -&gt; Unit,&#10;    isAdmin: Boolean = false,&#10;    viewModel: HistoryViewModel = hiltViewModel()&#10;) {&#10;    val uiState by viewModel.detailUiState.collectAsState()&#10;    val listUiState by viewModel.uiState.collectAsState()&#10;    val toastMessage by viewModel.toastMessage.collectAsState()&#10;    val currency = remember { NumberFormat.getCurrencyInstance(Locale.forLanguageTag(&quot;id-ID&quot;)).apply { maximumFractionDigits = 0 } }&#10;    val dateFormatter = remember { SimpleDateFormat(&quot;dd MMM yyyy, HH:mm&quot;, Locale.forLanguageTag(&quot;id-ID&quot;)) }&#10;    val snackbarHostState = remember { SnackbarHostState() }&#10;    val scope = rememberCoroutineScope()&#10;&#10;    LaunchedEffect(transactionId) { viewModel.onEvent(HistoryEvent.LoadDetail(transactionId)) }&#10;&#10;    // Show toast message&#10;    LaunchedEffect(toastMessage) {&#10;        toastMessage?.let { message -&gt;&#10;            snackbarHostState.showSnackbar(&#10;                message = message,&#10;                duration = SnackbarDuration.Short&#10;            )&#10;            viewModel.onEvent(HistoryEvent.DismissToast)&#10;        }&#10;    }&#10;&#10;    // Delete confirmation dialog&#10;    if (listUiState.showDeleteDialog) {&#10;        AlertDialog(&#10;            onDismissRequest = { viewModel.onEvent(HistoryEvent.DismissDeleteConfirmation) },&#10;            title = { Text(&quot;Hapus Transaksi?&quot;) },&#10;            text = { Text(&quot;Transaksi yang dihapus tidak dapat dikembalikan. Apakah Anda yakin ingin menghapus transaksi ini?&quot;) },&#10;            confirmButton = {&#10;                Button(&#10;                    onClick = {&#10;                        viewModel.onEvent(HistoryEvent.ConfirmDelete)&#10;                        onDelete(uiState.transaction!!)&#10;                    },&#10;                    colors = ButtonDefaults.buttonColors(&#10;                        containerColor = MaterialTheme.colorScheme.error&#10;                    )&#10;                ) {&#10;                    Text(&quot;Hapus&quot;)&#10;                }&#10;            },&#10;            dismissButton = {&#10;                TextButton(onClick = { viewModel.onEvent(HistoryEvent.DismissDeleteConfirmation) }) {&#10;                    Text(&quot;Batal&quot;)&#10;                }&#10;            }&#10;        )&#10;    }&#10;&#10;    Scaffold(&#10;        topBar = {&#10;            TopAppBar(&#10;                title = { Text(&quot;Detil Transaksi&quot;) },&#10;                navigationIcon = {&#10;                    IconButton(onClick = onBack) { Icon(Icons.AutoMirrored.Filled.ArrowBack, contentDescription = null) }&#10;                }&#10;            )&#10;        },&#10;        snackbarHost = { SnackbarHost(snackbarHostState) }&#10;    ) { padding -&gt;&#10;        if (uiState.isLoading) {&#10;            Box(Modifier.fillMaxSize().padding(padding), contentAlignment = Alignment.Center) { CircularProgressIndicator() }&#10;        } else uiState.transaction?.let { tx -&gt;&#10;            LazyColumn(&#10;                modifier = Modifier.fillMaxSize().padding(padding),&#10;                contentPadding = PaddingValues(16.dp),&#10;                verticalArrangement = Arrangement.spacedBy(12.dp)&#10;            ) {&#10;                item {&#10;                    Text(tx.transactionNumber, style = MaterialTheme.typography.titleLarge, fontWeight = FontWeight.Bold)&#10;                    Text(&quot;Tanggal: ${dateFormatter.format(Date(tx.updatedAt))}&quot;)&#10;                    Text(&quot;Kasir: ${tx.cashierName}&quot;)&#10;                    Text(&quot;Status: ${tx.status.name}&quot;)&#10;                    Text(&quot;Metode Bayar: ${tx.paymentMethod.name}&quot;)&#10;                    HorizontalDivider()&#10;                }&#10;                // Items header&#10;                if (uiState.items.isNotEmpty()) {&#10;                    item {&#10;                        Row(&#10;                            modifier = Modifier.fillMaxWidth(),&#10;                            horizontalArrangement = Arrangement.SpaceBetween,&#10;                            verticalAlignment = Alignment.CenterVertically&#10;                        ) {&#10;                            Text(&quot;Item Dibeli&quot;, style = MaterialTheme.typography.titleMedium)&#10;                            Text(&#10;                                &quot;${uiState.items.size} item • ${uiState.items.sumOf { it.quantity }} pcs&quot;,&#10;                                style = MaterialTheme.typography.bodySmall,&#10;                                color = MaterialTheme.colorScheme.onSurfaceVariant&#10;                            )&#10;                        }&#10;                    }&#10;                    items(uiState.items) { item -&gt;&#10;                        ItemDetailRow(&#10;                            name = item.productName,&#10;                            quantity = item.quantity,&#10;                            productPrice = item.productPrice,&#10;                            unitPrice = item.unitPrice,&#10;                            discount = item.discount,&#10;                            subtotal = item.subtotal,&#10;                            currency = currency&#10;                        )&#10;                    }&#10;                    item { HorizontalDivider() }&#10;                } else {&#10;                    item { Text(&quot;Tidak ada item&quot;, style = MaterialTheme.typography.bodyMedium) }&#10;                }&#10;&#10;                // Order Summary using OrderSummaryCard component&#10;                item {&#10;                    // Calculate values&#10;                    val grossSubtotal = uiState.items.sumOf { it.unitPrice * it.quantity }&#10;                    val itemDiscount = uiState.items.sumOf { it.discount }&#10;                    val netSubtotal = tx.subtotal&#10;                    val taxRate = if (netSubtotal &gt; 0 &amp;&amp; tx.tax &gt; 0) tx.tax / netSubtotal else 0.0&#10;                    val globalDiscount = tx.discount&#10;&#10;                    OrderSummaryCard(&#10;                        grossSubtotal = grossSubtotal,&#10;                        itemDiscount = itemDiscount,&#10;                        netSubtotal = netSubtotal,&#10;                        taxRate = taxRate,&#10;                        taxAmount = tx.tax,&#10;                        globalDiscount = globalDiscount,&#10;                        total = tx.total&#10;                    )&#10;&#10;                    // Cash payment details (if applicable)&#10;                    if (tx.cashReceived &gt; 0) {&#10;                        Spacer(Modifier.height(8.dp))&#10;                        Card(&#10;                            modifier = Modifier.fillMaxWidth(),&#10;                            colors = CardDefaults.cardColors(&#10;                                containerColor = MaterialTheme.colorScheme.surfaceVariant&#10;                            )&#10;                        ) {&#10;                            Column(&#10;                                modifier = Modifier.padding(12.dp),&#10;                                verticalArrangement = Arrangement.spacedBy(6.dp)&#10;                            ) {&#10;                                Text(&#10;                                    &quot;Detail Pembayaran Tunai&quot;,&#10;                                    style = MaterialTheme.typography.titleSmall,&#10;                                    fontWeight = FontWeight.SemiBold&#10;                                )&#10;                                HorizontalDivider()&#10;&#10;                                val receivedStr = currency.format(tx.cashReceived).replace(&quot;Rp&quot;, &quot;Rp &quot;)&#10;                                val changeStr = currency.format(tx.cashChange).replace(&quot;Rp&quot;, &quot;Rp &quot;)&#10;&#10;                                Row(&#10;                                    modifier = Modifier.fillMaxWidth(),&#10;                                    horizontalArrangement = Arrangement.SpaceBetween&#10;                                ) {&#10;                                    Text(&quot;Tunai Diterima&quot;, style = MaterialTheme.typography.bodySmall)&#10;                                    Text(receivedStr, style = MaterialTheme.typography.bodySmall)&#10;                                }&#10;                                Row(&#10;                                    modifier = Modifier.fillMaxWidth(),&#10;                                    horizontalArrangement = Arrangement.SpaceBetween&#10;                                ) {&#10;                                    Text(&#10;                                        &quot;Kembalian&quot;,&#10;                                        style = MaterialTheme.typography.bodySmall,&#10;                                        fontWeight = FontWeight.Medium&#10;                                    )&#10;                                    Text(&#10;                                        changeStr,&#10;                                        style = MaterialTheme.typography.bodySmall,&#10;                                        fontWeight = FontWeight.Medium,&#10;                                        color = MaterialTheme.colorScheme.primary&#10;                                    )&#10;                                }&#10;                            }&#10;                        }&#10;                    }&#10;&#10;                    HorizontalDivider()&#10;                }&#10;                // Actions - using reusable TransactionActions component&#10;                item {&#10;                    TransactionActions(&#10;                        status = tx.status,&#10;                        onEdit = { onEdit(tx.id) },&#10;                        onPrint = { onPrint(tx) },&#10;                        onShare = { onShare(tx) },&#10;                        onPrintQueue = {&#10;                            onPrintQueue(tx)&#10;                            scope.launch { snackbarHostState.showSnackbar(&quot;Tiket antrian dicetak&quot;) }&#10;                        },&#10;                        onComplete = {&#10;                            onComplete(tx)&#10;                            scope.launch { snackbarHostState.showSnackbar(&quot;Transaksi ditandai selesai&quot;) }&#10;                        },&#10;                        isAdmin = isAdmin,&#10;                        onDeleteAdmin = { viewModel.onEvent(HistoryEvent.ShowDeleteConfirmation(tx.id)) }&#10;                    )&#10;                }&#10;                // Bottom spacing&#10;                item { Spacer(Modifier.height(32.dp)) }&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;@Composable&#10;private fun ItemDetailRow(&#10;    name: String,&#10;    quantity: Int,&#10;    productPrice: Double,&#10;    unitPrice: Double,&#10;    discount: Double,&#10;    subtotal: Double,&#10;    currency: NumberFormat&#10;) {&#10;    ElevatedCard {&#10;        Column(Modifier.fillMaxWidth().padding(12.dp), verticalArrangement = Arrangement.spacedBy(4.dp)) {&#10;            Text(name, style = MaterialTheme.typography.bodyMedium, fontWeight = FontWeight.SemiBold)&#10;            &#10;            if (discount &gt; 0) {&#10;                // Show original price&#10;                val origPriceStr = currency.format(productPrice).replace(&quot;Rp&quot;, &quot;Rp &quot;)&#10;                Text(&#10;                    &quot;@$origPriceStr/pcs&quot;,&#10;                    style = MaterialTheme.typography.bodySmall,&#10;                    color = MaterialTheme.colorScheme.onSurfaceVariant&#10;                )&#10;                &#10;                // Calculate discounted price per unit&#10;                val discountPerUnit = discount / quantity&#10;                val discountedPricePerUnit = productPrice - discountPerUnit&#10;                val discountedStr = currency.format(discountedPricePerUnit).replace(&quot;Rp&quot;, &quot;Rp &quot;)&#10;                val subStr = currency.format(subtotal).replace(&quot;Rp&quot;, &quot;Rp &quot;)&#10;                &#10;                // Show quantity x discounted price = subtotal&#10;                Text(&#10;                    &quot;$quantity x $discountedStr = $subStr&quot;,&#10;                    style = MaterialTheme.typography.bodySmall&#10;                )&#10;                &#10;                // Show total discount&#10;                val discountStr = currency.format(discount).replace(&quot;Rp&quot;, &quot;Rp &quot;)&#10;                val discountPerUnitStr = currency.format(discountPerUnit).replace(&quot;Rp&quot;, &quot;Rp &quot;)&#10;                Text(&#10;                    &quot;Diskon: $discountPerUnitStr/pcs (Total: -$discountStr)&quot;,&#10;                    style = MaterialTheme.typography.bodySmall,&#10;                    color = MaterialTheme.colorScheme.primary&#10;                )&#10;            } else {&#10;                // No discount - simple format&#10;                val unitStr = currency.format(unitPrice).replace(&quot;Rp&quot;, &quot;Rp &quot;)&#10;                val subStr = currency.format(subtotal).replace(&quot;Rp&quot;, &quot;Rp &quot;)&#10;                Text(&quot;$quantity x $unitStr = $subStr&quot;, style = MaterialTheme.typography.bodySmall)&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;enum class DateRange(val label: String) {&#10;    TODAY(&quot;Hari ini&quot;),&#10;    YESTERDAY(&quot;Kemarin&quot;),&#10;    LAST_7_DAYS(&quot;7 hari terakhir&quot;),&#10;    THIS_MONTH(&quot;Bulan ini&quot;),&#10;    LAST_MONTH(&quot;Bulan lalu&quot;),&#10;    CUSTOM(&quot;Custom&quot;)&#10;}&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/app/src/main/java/id/stargan/intikasir/feature/pos/print/ESCPosPrinter.kt">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/id/stargan/intikasir/feature/pos/print/ESCPosPrinter.kt" />
              <option name="originalContent" value="package id.stargan.intikasir.feature.pos.print&#10;&#10;import android.Manifest&#10;import android.bluetooth.BluetoothAdapter&#10;import android.bluetooth.BluetoothDevice&#10;import android.bluetooth.BluetoothSocket&#10;import android.content.Context&#10;import android.content.pm.PackageManager&#10;import android.util.Log&#10;import androidx.core.content.ContextCompat&#10;import id.stargan.intikasir.data.local.entity.TransactionEntity&#10;import id.stargan.intikasir.data.local.entity.TransactionItemEntity&#10;import id.stargan.intikasir.domain.model.StoreSettings&#10;import id.stargan.intikasir.util.BluetoothPermissionHelper&#10;import java.io.OutputStream&#10;import java.nio.charset.Charset&#10;import java.text.NumberFormat&#10;import java.util.Locale&#10;import java.util.UUID&#10;&#10;/**&#10; * Minimal ESC/POS printer helper (Bluetooth RFCOMM)&#10; * NOTE: This is a basic stub focusing on text output.&#10; */&#10;object ESCPosPrinter {&#10;    private const val TAG = &quot;ESCPosPrinter&quot;&#10;    private val SPP_UUID: UUID = UUID.fromString(&quot;00001101-0000-1000-8000-00805F9B34FB&quot;)&#10;&#10;    sealed class PrintResult {&#10;        object Success : PrintResult()&#10;        data class Error(val message: String) : PrintResult()&#10;    }&#10;&#10;    fun printReceipt(&#10;        context: Context,&#10;        settings: StoreSettings,&#10;        transaction: TransactionEntity,&#10;        items: List&lt;TransactionItemEntity&gt;&#10;    ): PrintResult {&#10;        try {&#10;            val mac = settings.printerAddress&#10;            if (mac.isNullOrBlank()) {&#10;                Log.w(TAG, &quot;printReceipt: No printer address configured&quot;)&#10;                return PrintResult.Error(&quot;Printer belum dikonfigurasi&quot;)&#10;            }&#10;&#10;            if (!BluetoothPermissionHelper.hasBluetoothPermissions(context)) {&#10;                Log.w(TAG, &quot;printReceipt: Bluetooth permissions not granted&quot;)&#10;                return PrintResult.Error(&quot;Izin Bluetooth diperlukan untuk mencetak&quot;)&#10;            }&#10;&#10;            val adapter = BluetoothAdapter.getDefaultAdapter()&#10;            if (adapter == null) {&#10;                Log.e(TAG, &quot;printReceipt: BluetoothAdapter is null&quot;)&#10;                return PrintResult.Error(&quot;Bluetooth tidak tersedia&quot;)&#10;            }&#10;&#10;            if (!adapter.isEnabled) {&#10;                Log.w(TAG, &quot;printReceipt: Bluetooth is disabled&quot;)&#10;                return PrintResult.Error(&quot;Bluetooth tidak aktif&quot;)&#10;            }&#10;&#10;            val device: BluetoothDevice = try {&#10;                adapter.getRemoteDevice(mac)&#10;            } catch (e: Exception) {&#10;                Log.e(TAG, &quot;printReceipt: Failed to get remote device&quot;, e)&#10;                return PrintResult.Error(&quot;Printer tidak ditemukan: ${e.message}&quot;)&#10;            }&#10;&#10;            val socket: BluetoothSocket = try {&#10;                device.createRfcommSocketToServiceRecord(SPP_UUID)&#10;            } catch (e: Exception) {&#10;                Log.e(TAG, &quot;printReceipt: Failed to create socket&quot;, e)&#10;                return PrintResult.Error(&quot;Gagal membuat koneksi: ${e.message}&quot;)&#10;            }&#10;&#10;            // cancelDiscovery may require BLUETOOTH_SCAN on newer SDKs; check before calling&#10;            if (BluetoothPermissionHelper.hasBluetoothScanPermission(context)) {&#10;                try {&#10;                    adapter.cancelDiscovery()&#10;                } catch (e: Exception) {&#10;                    Log.w(TAG, &quot;printReceipt: Failed to cancel discovery&quot;, e)&#10;                }&#10;            }&#10;&#10;            try {&#10;                Log.d(TAG, &quot;printReceipt: Connecting to printer...&quot;)&#10;                socket.connect()&#10;                Log.d(TAG, &quot;printReceipt: Connected, sending data...&quot;)&#10;                socket.outputStream.use { out -&gt;&#10;                    writeReceipt(out, settings, transaction, items)&#10;                }&#10;                Log.i(TAG, &quot;printReceipt: Print successful&quot;)&#10;                return PrintResult.Success&#10;            } catch (e: Exception) {&#10;                Log.e(TAG, &quot;printReceipt: Failed to print&quot;, e)&#10;                return PrintResult.Error(&quot;Gagal mencetak: ${e.message}&quot;)&#10;            } finally {&#10;                try {&#10;                    socket.close()&#10;                } catch (e: Exception) {&#10;                    Log.w(TAG, &quot;printReceipt: Failed to close socket&quot;, e)&#10;                }&#10;            }&#10;        } catch (e: Exception) {&#10;            Log.e(TAG, &quot;printReceipt: Unexpected error&quot;, e)&#10;            return PrintResult.Error(&quot;Kesalahan tidak terduga: ${e.message}&quot;)&#10;        }&#10;    }&#10;&#10;    private fun writeReceipt(&#10;        out: OutputStream,&#10;        settings: StoreSettings,&#10;        transaction: TransactionEntity,&#10;        items: List&lt;TransactionItemEntity&gt;&#10;    ) {&#10;        val nf = NumberFormat.getCurrencyInstance(Locale.Builder().setLanguage(&quot;id&quot;).setRegion(&quot;ID&quot;).build())&#10;        val cpl = settings.paperCharPerLine&#10;        val charset = Charset.forName(&quot;US-ASCII&quot;)&#10;&#10;        fun cmd(bytes: ByteArray) = out.write(bytes)&#10;        fun text(line: String, nl: Boolean = true) {&#10;            out.write(line.toByteArray(charset))&#10;            if (nl) out.write(byteArrayOf(0x0A)) // LF&#10;        }&#10;        fun divider() = text(&quot;-&quot;.repeat(cpl))&#10;        fun alignCenter() = cmd(byteArrayOf(0x1B, 0x61, 0x01))&#10;        fun alignLeft() = cmd(byteArrayOf(0x1B, 0x61, 0x00))&#10;        fun boldOn() = cmd(byteArrayOf(0x1B, 0x45, 0x01))&#10;        fun boldOff() = cmd(byteArrayOf(0x1B, 0x45, 0x00))&#10;        fun cut() = cmd(byteArrayOf(0x1D, 0x56, 0x00)) // simple cut, may vary&#10;&#10;        // Initialize&#10;        cmd(byteArrayOf(0x1B, 0x40))&#10;&#10;        // Header&#10;        alignCenter(); boldOn(); text((settings.storeName.ifBlank { &quot;Toko&quot; }).take(cpl)); boldOff()&#10;        settings.storeAddress.takeIf { it.isNotBlank() }?.let { text(it.take(cpl)) }&#10;        divider()&#10;&#10;        // Items&#10;        alignLeft()&#10;        items.forEach { itx -&gt;&#10;            // Product name&#10;            text(itx.productName.take(cpl))&#10;&#10;            // If item has discount, show original price&#10;            if (itx.discount &gt; 0) {&#10;                val originalPrice = itx.productPrice&#10;                val discountedPrice = itx.unitPrice&#10;&#10;                // Original price (strikethrough effect with @)&#10;                val origPriceStr = &quot;@${nf.format(originalPrice).replace(&quot;Rp&quot;, &quot;Rp &quot;)}&quot;&#10;                text(&quot;  $origPriceStr&quot;)&#10;&#10;                // Discounted price line&#10;                val qty = &quot;${itx.quantity} x ${nf.format(discountedPrice).replace(&quot;Rp&quot;, &quot;Rp &quot;)}&quot;&#10;                val sub = nf.format(itx.subtotal).replace(&quot;Rp&quot;, &quot;Rp &quot;)&#10;                val pad = (cpl - qty.length - sub.length).coerceAtLeast(1)&#10;                text(qty + &quot; &quot;.repeat(pad) + sub)&#10;&#10;                // Discount amount&#10;                val discountStr = &quot;  Diskon: -${nf.format(itx.discount).replace(&quot;Rp&quot;, &quot;Rp &quot;)}&quot;&#10;                text(discountStr)&#10;            } else {&#10;                // No discount - simple format&#10;                val qty = &quot;${itx.quantity} x ${nf.format(itx.unitPrice).replace(&quot;Rp&quot;, &quot;Rp &quot;)}&quot;&#10;                val sub = nf.format(itx.subtotal).replace(&quot;Rp&quot;, &quot;Rp &quot;)&#10;                val pad = (cpl - qty.length - sub.length).coerceAtLeast(1)&#10;                text(qty + &quot; &quot;.repeat(pad) + sub)&#10;            }&#10;        }&#10;        divider()&#10;&#10;        fun totalLine(label: String, value: String) {&#10;            val pad = (cpl - label.length - value.length).coerceAtLeast(1)&#10;            text(label + &quot; &quot;.repeat(pad) + value)&#10;        }&#10;&#10;        totalLine(&quot;Subtotal&quot;, nf.format(transaction.subtotal).replace(&quot;Rp&quot;, &quot;Rp &quot;))&#10;        if (transaction.tax &gt; 0) totalLine(&quot;PPN&quot;, nf.format(transaction.tax).replace(&quot;Rp&quot;, &quot;Rp &quot;))&#10;        if (transaction.discount &gt; 0) totalLine(&quot;Diskon&quot;, &quot;-&quot; + nf.format(transaction.discount).replace(&quot;Rp&quot;, &quot;Rp &quot;))&#10;        boldOn(); totalLine(&quot;TOTAL&quot;, nf.format(transaction.total).replace(&quot;Rp&quot;, &quot;Rp &quot;)); boldOff()&#10;&#10;        val received = transaction.cashReceived&#10;        if (received &gt; 0) {&#10;            totalLine(&quot;Tunai&quot;, nf.format(received).replace(&quot;Rp&quot;, &quot;Rp &quot;))&#10;            val change = (received - transaction.total).coerceAtLeast(0.0)&#10;            totalLine(&quot;Kembali&quot;, nf.format(change).replace(&quot;Rp&quot;, &quot;Rp &quot;))&#10;        }&#10;&#10;        divider()&#10;        alignCenter(); text(&quot;Terima kasih&quot;)&#10;&#10;        // Feed and optional cut&#10;        cmd(byteArrayOf(0x1B, 0x64, 0x03)) // feed 3 lines&#10;        if (settings.autoCut) cut()&#10;    }&#10;&#10;    fun printQueueTicket(&#10;        context: Context,&#10;        settings: StoreSettings,&#10;        transaction: TransactionEntity&#10;    ): PrintResult {&#10;        try {&#10;            val mac = settings.printerAddress&#10;            if (mac.isNullOrBlank()) {&#10;                Log.w(TAG, &quot;printQueueTicket: No printer address configured&quot;)&#10;                return PrintResult.Error(&quot;Printer belum dikonfigurasi&quot;)&#10;            }&#10;&#10;            if (!BluetoothPermissionHelper.hasBluetoothPermissions(context)) {&#10;                Log.w(TAG, &quot;printQueueTicket: Bluetooth permissions not granted&quot;)&#10;                return PrintResult.Error(&quot;Izin Bluetooth diperlukan untuk mencetak&quot;)&#10;            }&#10;&#10;            val adapter = BluetoothAdapter.getDefaultAdapter()&#10;            if (adapter == null) {&#10;                Log.e(TAG, &quot;printQueueTicket: BluetoothAdapter is null&quot;)&#10;                return PrintResult.Error(&quot;Bluetooth tidak tersedia&quot;)&#10;            }&#10;&#10;            if (!adapter.isEnabled) {&#10;                Log.w(TAG, &quot;printQueueTicket: Bluetooth is disabled&quot;)&#10;                return PrintResult.Error(&quot;Bluetooth tidak aktif&quot;)&#10;            }&#10;&#10;            val device: BluetoothDevice = try {&#10;                adapter.getRemoteDevice(mac)&#10;            } catch (e: Exception) {&#10;                Log.e(TAG, &quot;printQueueTicket: Failed to get remote device&quot;, e)&#10;                return PrintResult.Error(&quot;Printer tidak ditemukan: ${e.message}&quot;)&#10;            }&#10;&#10;            val socket: BluetoothSocket = try {&#10;                device.createRfcommSocketToServiceRecord(SPP_UUID)&#10;            } catch (e: Exception) {&#10;                Log.e(TAG, &quot;printQueueTicket: Failed to create socket&quot;, e)&#10;                return PrintResult.Error(&quot;Gagal membuat koneksi: ${e.message}&quot;)&#10;            }&#10;&#10;            if (BluetoothPermissionHelper.hasBluetoothScanPermission(context)) {&#10;                try {&#10;                    adapter.cancelDiscovery()&#10;                } catch (e: Exception) {&#10;                    Log.w(TAG, &quot;printQueueTicket: Failed to cancel discovery&quot;, e)&#10;                }&#10;            }&#10;&#10;            try {&#10;                Log.d(TAG, &quot;printQueueTicket: Connecting to printer...&quot;)&#10;                socket.connect()&#10;                Log.d(TAG, &quot;printQueueTicket: Connected, sending data...&quot;)&#10;                socket.outputStream.use { out -&gt;&#10;                    writeQueueTicket(out, settings, transaction)&#10;                }&#10;                Log.i(TAG, &quot;printQueueTicket: Print successful&quot;)&#10;                return PrintResult.Success&#10;            } catch (e: Exception) {&#10;                Log.e(TAG, &quot;printQueueTicket: Failed to print&quot;, e)&#10;                return PrintResult.Error(&quot;Gagal mencetak antrian: ${e.message}&quot;)&#10;            } finally {&#10;                try {&#10;                    socket.close()&#10;                } catch (e: Exception) {&#10;                    Log.w(TAG, &quot;printQueueTicket: Failed to close socket&quot;, e)&#10;                }&#10;            }&#10;        } catch (e: Exception) {&#10;            Log.e(TAG, &quot;printQueueTicket: Unexpected error&quot;, e)&#10;            return PrintResult.Error(&quot;Kesalahan tidak terduga: ${e.message}&quot;)&#10;        }&#10;    }&#10;&#10;    private fun writeQueueTicket(&#10;        out: OutputStream,&#10;        settings: StoreSettings,&#10;        transaction: TransactionEntity&#10;    ) {&#10;        val cpl = settings.paperCharPerLine&#10;        val charset = Charset.forName(&quot;US-ASCII&quot;)&#10;        val nf = NumberFormat.getCurrencyInstance(Locale.Builder().setLanguage(&quot;id&quot;).setRegion(&quot;ID&quot;).build())&#10;&#10;        fun cmd(bytes: ByteArray) = out.write(bytes)&#10;        fun text(line: String = &quot;&quot;, nl: Boolean = true) {&#10;            out.write(line.toByteArray(charset))&#10;            if (nl) out.write(byteArrayOf(0x0A))&#10;        }&#10;        fun alignCenter() = cmd(byteArrayOf(0x1B, 0x61, 0x01))&#10;        fun alignLeft() = cmd(byteArrayOf(0x1B, 0x61, 0x00))&#10;        fun boldOn() = cmd(byteArrayOf(0x1B, 0x45, 0x01))&#10;        fun boldOff() = cmd(byteArrayOf(0x1B, 0x45, 0x00))&#10;        fun dblOn() = cmd(byteArrayOf(0x1D, 0x21, 0x11)) // double height &amp; width&#10;        fun dblOff() = cmd(byteArrayOf(0x1D, 0x21, 0x00))&#10;        fun divider() = text(&quot;-&quot;.repeat(cpl))&#10;        fun feed(n: Int) = cmd(byteArrayOf(0x1B, 0x64, n.toByte()))&#10;        fun cut() = cmd(byteArrayOf(0x1D, 0x56, 0x00))&#10;&#10;        // init&#10;        cmd(byteArrayOf(0x1B, 0x40))&#10;&#10;        // Header&#10;        alignCenter(); boldOn(); text(&quot;NOMOR ANTRIAN&quot;); boldOff()&#10;        val queueNo = transaction.transactionNumber.substringAfterLast('-').takeLast(4).padStart(4, '0')&#10;        dblOn(); text(queueNo); dblOff()&#10;        text() // blank line&#10;&#10;        // Details&#10;        alignLeft()&#10;        text(&quot;Transaksi : ${transaction.transactionNumber}&quot;)&#10;        val date = java.text.SimpleDateFormat(&quot;dd MMM yyyy, HH:mm&quot;, java.util.Locale(&quot;id&quot;, &quot;ID&quot;)).format(java.util.Date(transaction.transactionDate))&#10;        text(&quot;Waktu     : $date&quot;)&#10;        text(&quot;Total     : ${nf.format(transaction.total).replace(&quot;Rp&quot;, &quot;Rp &quot;)}&quot;)&#10;&#10;        text(); divider(); alignCenter(); text(&quot;Terima kasih&quot;); feed(3)&#10;        if (settings.autoCut) cut()&#10;    }&#10;}&#10;" />
              <option name="updatedContent" value="package id.stargan.intikasir.feature.pos.print&#10;&#10;import android.Manifest&#10;import android.bluetooth.BluetoothAdapter&#10;import android.bluetooth.BluetoothDevice&#10;import android.bluetooth.BluetoothSocket&#10;import android.content.Context&#10;import android.content.pm.PackageManager&#10;import android.util.Log&#10;import androidx.core.content.ContextCompat&#10;import id.stargan.intikasir.data.local.entity.TransactionEntity&#10;import id.stargan.intikasir.data.local.entity.TransactionItemEntity&#10;import id.stargan.intikasir.domain.model.StoreSettings&#10;import id.stargan.intikasir.util.BluetoothPermissionHelper&#10;import java.io.OutputStream&#10;import java.nio.charset.Charset&#10;import java.text.NumberFormat&#10;import java.util.Locale&#10;import java.util.UUID&#10;&#10;/**&#10; * Minimal ESC/POS printer helper (Bluetooth RFCOMM)&#10; * NOTE: This is a basic stub focusing on text output.&#10; */&#10;object ESCPosPrinter {&#10;    private const val TAG = &quot;ESCPosPrinter&quot;&#10;    private val SPP_UUID: UUID = UUID.fromString(&quot;00001101-0000-1000-8000-00805F9B34FB&quot;)&#10;&#10;    sealed class PrintResult {&#10;        object Success : PrintResult()&#10;        data class Error(val message: String) : PrintResult()&#10;    }&#10;&#10;    fun printReceipt(&#10;        context: Context,&#10;        settings: StoreSettings,&#10;        transaction: TransactionEntity,&#10;        items: List&lt;TransactionItemEntity&gt;&#10;    ): PrintResult {&#10;        try {&#10;            val mac = settings.printerAddress&#10;            if (mac.isNullOrBlank()) {&#10;                Log.w(TAG, &quot;printReceipt: No printer address configured&quot;)&#10;                return PrintResult.Error(&quot;Printer belum dikonfigurasi&quot;)&#10;            }&#10;&#10;            if (!BluetoothPermissionHelper.hasBluetoothPermissions(context)) {&#10;                Log.w(TAG, &quot;printReceipt: Bluetooth permissions not granted&quot;)&#10;                return PrintResult.Error(&quot;Izin Bluetooth diperlukan untuk mencetak&quot;)&#10;            }&#10;&#10;            val adapter = BluetoothAdapter.getDefaultAdapter()&#10;            if (adapter == null) {&#10;                Log.e(TAG, &quot;printReceipt: BluetoothAdapter is null&quot;)&#10;                return PrintResult.Error(&quot;Bluetooth tidak tersedia&quot;)&#10;            }&#10;&#10;            if (!adapter.isEnabled) {&#10;                Log.w(TAG, &quot;printReceipt: Bluetooth is disabled&quot;)&#10;                return PrintResult.Error(&quot;Bluetooth tidak aktif&quot;)&#10;            }&#10;&#10;            val device: BluetoothDevice = try {&#10;                adapter.getRemoteDevice(mac)&#10;            } catch (e: Exception) {&#10;                Log.e(TAG, &quot;printReceipt: Failed to get remote device&quot;, e)&#10;                return PrintResult.Error(&quot;Printer tidak ditemukan: ${e.message}&quot;)&#10;            }&#10;&#10;            val socket: BluetoothSocket = try {&#10;                device.createRfcommSocketToServiceRecord(SPP_UUID)&#10;            } catch (e: Exception) {&#10;                Log.e(TAG, &quot;printReceipt: Failed to create socket&quot;, e)&#10;                return PrintResult.Error(&quot;Gagal membuat koneksi: ${e.message}&quot;)&#10;            }&#10;&#10;            // cancelDiscovery may require BLUETOOTH_SCAN on newer SDKs; check before calling&#10;            if (BluetoothPermissionHelper.hasBluetoothScanPermission(context)) {&#10;                try {&#10;                    adapter.cancelDiscovery()&#10;                } catch (e: Exception) {&#10;                    Log.w(TAG, &quot;printReceipt: Failed to cancel discovery&quot;, e)&#10;                }&#10;            }&#10;&#10;            try {&#10;                Log.d(TAG, &quot;printReceipt: Connecting to printer...&quot;)&#10;                socket.connect()&#10;                Log.d(TAG, &quot;printReceipt: Connected, sending data...&quot;)&#10;                socket.outputStream.use { out -&gt;&#10;                    writeReceipt(out, settings, transaction, items)&#10;                }&#10;                Log.i(TAG, &quot;printReceipt: Print successful&quot;)&#10;                return PrintResult.Success&#10;            } catch (e: Exception) {&#10;                Log.e(TAG, &quot;printReceipt: Failed to print&quot;, e)&#10;                return PrintResult.Error(&quot;Gagal mencetak: ${e.message}&quot;)&#10;            } finally {&#10;                try {&#10;                    socket.close()&#10;                } catch (e: Exception) {&#10;                    Log.w(TAG, &quot;printReceipt: Failed to close socket&quot;, e)&#10;                }&#10;            }&#10;        } catch (e: Exception) {&#10;            Log.e(TAG, &quot;printReceipt: Unexpected error&quot;, e)&#10;            return PrintResult.Error(&quot;Kesalahan tidak terduga: ${e.message}&quot;)&#10;        }&#10;    }&#10;&#10;    private fun writeReceipt(&#10;        out: OutputStream,&#10;        settings: StoreSettings,&#10;        transaction: TransactionEntity,&#10;        items: List&lt;TransactionItemEntity&gt;&#10;    ) {&#10;        val nf = NumberFormat.getCurrencyInstance(Locale.Builder().setLanguage(&quot;id&quot;).setRegion(&quot;ID&quot;).build())&#10;        val cpl = settings.paperCharPerLine&#10;        val charset = Charset.forName(&quot;US-ASCII&quot;)&#10;&#10;        fun cmd(bytes: ByteArray) = out.write(bytes)&#10;        fun text(line: String, nl: Boolean = true) {&#10;            out.write(line.toByteArray(charset))&#10;            if (nl) out.write(byteArrayOf(0x0A)) // LF&#10;        }&#10;        fun divider() = text(&quot;-&quot;.repeat(cpl))&#10;        fun alignCenter() = cmd(byteArrayOf(0x1B, 0x61, 0x01))&#10;        fun alignLeft() = cmd(byteArrayOf(0x1B, 0x61, 0x00))&#10;        fun boldOn() = cmd(byteArrayOf(0x1B, 0x45, 0x01))&#10;        fun boldOff() = cmd(byteArrayOf(0x1B, 0x45, 0x00))&#10;        fun cut() = cmd(byteArrayOf(0x1D, 0x56, 0x00)) // simple cut, may vary&#10;&#10;        // Initialize&#10;        cmd(byteArrayOf(0x1B, 0x40))&#10;&#10;        // Header&#10;        alignCenter(); boldOn(); text((settings.storeName.ifBlank { &quot;Toko&quot; }).take(cpl)); boldOff()&#10;        settings.storeAddress.takeIf { it.isNotBlank() }?.let { text(it.take(cpl)) }&#10;        divider()&#10;&#10;        // Items&#10;        alignLeft()&#10;        items.forEach { itx -&gt;&#10;            // Product name&#10;            text(itx.productName.take(cpl))&#10;            &#10;            // If item has discount, show original price and discounted price per unit&#10;            if (itx.discount &gt; 0) {&#10;                val originalPrice = itx.productPrice&#10;                val discountPerUnit = itx.discount / itx.quantity&#10;                val discountedPricePerUnit = originalPrice - discountPerUnit&#10;                &#10;                // Original price (with @ prefix to indicate strikethrough)&#10;                val origPriceStr = &quot;@${nf.format(originalPrice).replace(&quot;Rp&quot;, &quot;Rp &quot;)}/pcs&quot;&#10;                text(&quot;  $origPriceStr&quot;)&#10;                &#10;                // Quantity x discounted price per unit = subtotal&#10;                val qty = &quot;${itx.quantity} x ${nf.format(discountedPricePerUnit).replace(&quot;Rp&quot;, &quot;Rp &quot;)}&quot;&#10;                val sub = nf.format(itx.subtotal).replace(&quot;Rp&quot;, &quot;Rp &quot;)&#10;                val pad = (cpl - qty.length - sub.length).coerceAtLeast(1)&#10;                text(qty + &quot; &quot;.repeat(pad) + sub)&#10;                &#10;                // Total discount for all units&#10;                val discountStr = &quot;  Diskon: -${nf.format(itx.discount).replace(&quot;Rp&quot;, &quot;Rp &quot;)}&quot;&#10;                text(discountStr)&#10;            } else {&#10;                // No discount - simple format&#10;                val qty = &quot;${itx.quantity} x ${nf.format(itx.unitPrice).replace(&quot;Rp&quot;, &quot;Rp &quot;)}&quot;&#10;                val sub = nf.format(itx.subtotal).replace(&quot;Rp&quot;, &quot;Rp &quot;)&#10;                val pad = (cpl - qty.length - sub.length).coerceAtLeast(1)&#10;                text(qty + &quot; &quot;.repeat(pad) + sub)&#10;            }&#10;        }&#10;        divider()&#10;&#10;        fun totalLine(label: String, value: String) {&#10;            val pad = (cpl - label.length - value.length).coerceAtLeast(1)&#10;            text(label + &quot; &quot;.repeat(pad) + value)&#10;        }&#10;&#10;        totalLine(&quot;Subtotal&quot;, nf.format(transaction.subtotal).replace(&quot;Rp&quot;, &quot;Rp &quot;))&#10;        if (transaction.tax &gt; 0) totalLine(&quot;PPN&quot;, nf.format(transaction.tax).replace(&quot;Rp&quot;, &quot;Rp &quot;))&#10;        if (transaction.discount &gt; 0) totalLine(&quot;Diskon&quot;, &quot;-&quot; + nf.format(transaction.discount).replace(&quot;Rp&quot;, &quot;Rp &quot;))&#10;        boldOn(); totalLine(&quot;TOTAL&quot;, nf.format(transaction.total).replace(&quot;Rp&quot;, &quot;Rp &quot;)); boldOff()&#10;&#10;        val received = transaction.cashReceived&#10;        if (received &gt; 0) {&#10;            totalLine(&quot;Tunai&quot;, nf.format(received).replace(&quot;Rp&quot;, &quot;Rp &quot;))&#10;            val change = (received - transaction.total).coerceAtLeast(0.0)&#10;            totalLine(&quot;Kembali&quot;, nf.format(change).replace(&quot;Rp&quot;, &quot;Rp &quot;))&#10;        }&#10;&#10;        divider()&#10;        alignCenter(); text(&quot;Terima kasih&quot;)&#10;&#10;        // Feed and optional cut&#10;        cmd(byteArrayOf(0x1B, 0x64, 0x03)) // feed 3 lines&#10;        if (settings.autoCut) cut()&#10;    }&#10;&#10;    fun printQueueTicket(&#10;        context: Context,&#10;        settings: StoreSettings,&#10;        transaction: TransactionEntity&#10;    ): PrintResult {&#10;        try {&#10;            val mac = settings.printerAddress&#10;            if (mac.isNullOrBlank()) {&#10;                Log.w(TAG, &quot;printQueueTicket: No printer address configured&quot;)&#10;                return PrintResult.Error(&quot;Printer belum dikonfigurasi&quot;)&#10;            }&#10;&#10;            if (!BluetoothPermissionHelper.hasBluetoothPermissions(context)) {&#10;                Log.w(TAG, &quot;printQueueTicket: Bluetooth permissions not granted&quot;)&#10;                return PrintResult.Error(&quot;Izin Bluetooth diperlukan untuk mencetak&quot;)&#10;            }&#10;&#10;            val adapter = BluetoothAdapter.getDefaultAdapter()&#10;            if (adapter == null) {&#10;                Log.e(TAG, &quot;printQueueTicket: BluetoothAdapter is null&quot;)&#10;                return PrintResult.Error(&quot;Bluetooth tidak tersedia&quot;)&#10;            }&#10;&#10;            if (!adapter.isEnabled) {&#10;                Log.w(TAG, &quot;printQueueTicket: Bluetooth is disabled&quot;)&#10;                return PrintResult.Error(&quot;Bluetooth tidak aktif&quot;)&#10;            }&#10;&#10;            val device: BluetoothDevice = try {&#10;                adapter.getRemoteDevice(mac)&#10;            } catch (e: Exception) {&#10;                Log.e(TAG, &quot;printQueueTicket: Failed to get remote device&quot;, e)&#10;                return PrintResult.Error(&quot;Printer tidak ditemukan: ${e.message}&quot;)&#10;            }&#10;&#10;            val socket: BluetoothSocket = try {&#10;                device.createRfcommSocketToServiceRecord(SPP_UUID)&#10;            } catch (e: Exception) {&#10;                Log.e(TAG, &quot;printQueueTicket: Failed to create socket&quot;, e)&#10;                return PrintResult.Error(&quot;Gagal membuat koneksi: ${e.message}&quot;)&#10;            }&#10;&#10;            if (BluetoothPermissionHelper.hasBluetoothScanPermission(context)) {&#10;                try {&#10;                    adapter.cancelDiscovery()&#10;                } catch (e: Exception) {&#10;                    Log.w(TAG, &quot;printQueueTicket: Failed to cancel discovery&quot;, e)&#10;                }&#10;            }&#10;&#10;            try {&#10;                Log.d(TAG, &quot;printQueueTicket: Connecting to printer...&quot;)&#10;                socket.connect()&#10;                Log.d(TAG, &quot;printQueueTicket: Connected, sending data...&quot;)&#10;                socket.outputStream.use { out -&gt;&#10;                    writeQueueTicket(out, settings, transaction)&#10;                }&#10;                Log.i(TAG, &quot;printQueueTicket: Print successful&quot;)&#10;                return PrintResult.Success&#10;            } catch (e: Exception) {&#10;                Log.e(TAG, &quot;printQueueTicket: Failed to print&quot;, e)&#10;                return PrintResult.Error(&quot;Gagal mencetak antrian: ${e.message}&quot;)&#10;            } finally {&#10;                try {&#10;                    socket.close()&#10;                } catch (e: Exception) {&#10;                    Log.w(TAG, &quot;printQueueTicket: Failed to close socket&quot;, e)&#10;                }&#10;            }&#10;        } catch (e: Exception) {&#10;            Log.e(TAG, &quot;printQueueTicket: Unexpected error&quot;, e)&#10;            return PrintResult.Error(&quot;Kesalahan tidak terduga: ${e.message}&quot;)&#10;        }&#10;    }&#10;&#10;    private fun writeQueueTicket(&#10;        out: OutputStream,&#10;        settings: StoreSettings,&#10;        transaction: TransactionEntity&#10;    ) {&#10;        val cpl = settings.paperCharPerLine&#10;        val charset = Charset.forName(&quot;US-ASCII&quot;)&#10;        val nf = NumberFormat.getCurrencyInstance(Locale.Builder().setLanguage(&quot;id&quot;).setRegion(&quot;ID&quot;).build())&#10;&#10;        fun cmd(bytes: ByteArray) = out.write(bytes)&#10;        fun text(line: String = &quot;&quot;, nl: Boolean = true) {&#10;            out.write(line.toByteArray(charset))&#10;            if (nl) out.write(byteArrayOf(0x0A))&#10;        }&#10;        fun alignCenter() = cmd(byteArrayOf(0x1B, 0x61, 0x01))&#10;        fun alignLeft() = cmd(byteArrayOf(0x1B, 0x61, 0x00))&#10;        fun boldOn() = cmd(byteArrayOf(0x1B, 0x45, 0x01))&#10;        fun boldOff() = cmd(byteArrayOf(0x1B, 0x45, 0x00))&#10;        fun dblOn() = cmd(byteArrayOf(0x1D, 0x21, 0x11)) // double height &amp; width&#10;        fun dblOff() = cmd(byteArrayOf(0x1D, 0x21, 0x00))&#10;        fun divider() = text(&quot;-&quot;.repeat(cpl))&#10;        fun feed(n: Int) = cmd(byteArrayOf(0x1B, 0x64, n.toByte()))&#10;        fun cut() = cmd(byteArrayOf(0x1D, 0x56, 0x00))&#10;&#10;        // init&#10;        cmd(byteArrayOf(0x1B, 0x40))&#10;&#10;        // Header&#10;        alignCenter(); boldOn(); text(&quot;NOMOR ANTRIAN&quot;); boldOff()&#10;        val queueNo = transaction.transactionNumber.substringAfterLast('-').takeLast(4).padStart(4, '0')&#10;        dblOn(); text(queueNo); dblOff()&#10;        text() // blank line&#10;&#10;        // Details&#10;        alignLeft()&#10;        text(&quot;Transaksi : ${transaction.transactionNumber}&quot;)&#10;        val date = java.text.SimpleDateFormat(&quot;dd MMM yyyy, HH:mm&quot;, java.util.Locale(&quot;id&quot;, &quot;ID&quot;)).format(java.util.Date(transaction.transactionDate))&#10;        text(&quot;Waktu     : $date&quot;)&#10;        text(&quot;Total     : ${nf.format(transaction.total).replace(&quot;Rp&quot;, &quot;Rp &quot;)}&quot;)&#10;&#10;        text(); divider(); alignCenter(); text(&quot;Terima kasih&quot;); feed(3)&#10;        if (settings.autoCut) cut()&#10;    }&#10;}&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/app/src/main/java/id/stargan/intikasir/feature/pos/print/ReceiptPrinter.kt">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/id/stargan/intikasir/feature/pos/print/ReceiptPrinter.kt" />
              <option name="originalContent" value="package id.stargan.intikasir.feature.pos.print&#10;&#10;import android.content.ContentValues&#10;import android.content.Context&#10;import android.widget.Toast&#10;import android.graphics.*&#10;import android.graphics.pdf.PdfDocument&#10;import android.net.Uri&#10;import android.os.Build&#10;import android.os.Environment&#10;import android.os.ParcelFileDescriptor&#10;import android.provider.MediaStore&#10;import android.print.PrintAttributes&#10;import android.print.PrintDocumentAdapter&#10;import android.print.PrintDocumentInfo&#10;import android.print.PageRange&#10;import android.print.PrintManager&#10;import androidx.core.net.toUri&#10;import id.stargan.intikasir.data.local.entity.TransactionEntity&#10;import id.stargan.intikasir.data.local.entity.TransactionItemEntity&#10;import id.stargan.intikasir.domain.model.StoreSettings&#10;import java.io.File&#10;import java.io.FileOutputStream&#10;import java.text.NumberFormat&#10;import java.text.SimpleDateFormat&#10;import java.util.Date&#10;import java.util.Locale&#10;&#10;object ReceiptPrinter {&#10;&#10;    data class Result(val pdfUri: Uri, val fileName: String)&#10;&#10;    fun generateReceiptPdf(&#10;        context: Context,&#10;        settings: StoreSettings?,&#10;        transaction: TransactionEntity,&#10;        items: List&lt;TransactionItemEntity&gt;&#10;    ): Result {&#10;        val doc = PdfDocument()&#10;        val pageInfo = PdfDocument.PageInfo.Builder(595, 842, 1).create() // A4 portrait&#10;        val page = doc.startPage(pageInfo)&#10;        val canvas = page.canvas&#10;&#10;        val nf = NumberFormat.getCurrencyInstance(Locale.Builder().setLanguage(&quot;id&quot;).setRegion(&quot;ID&quot;).build())&#10;        val dateFormat = SimpleDateFormat(&quot;dd MMMM yyyy, HH:mm&quot;, Locale(&quot;id&quot;, &quot;ID&quot;))&#10;        val paint = Paint(Paint.ANTI_ALIAS_FLAG)&#10;        val titlePaint = Paint(Paint.ANTI_ALIAS_FLAG).apply {&#10;            typeface = Typeface.create(Typeface.DEFAULT, Typeface.BOLD)&#10;            textSize = 20f&#10;        }&#10;        val smallPaint = Paint(Paint.ANTI_ALIAS_FLAG).apply { &#10;            textSize = 10f&#10;            color = Color.DKGRAY&#10;        }&#10;        val normalPaint = Paint(Paint.ANTI_ALIAS_FLAG).apply { textSize = 12f }&#10;        val boldPaint = Paint(Paint.ANTI_ALIAS_FLAG).apply {&#10;            typeface = Typeface.create(Typeface.DEFAULT, Typeface.BOLD)&#10;            textSize = 12f&#10;        }&#10;        val headerPaint = Paint(Paint.ANTI_ALIAS_FLAG).apply {&#10;            typeface = Typeface.create(Typeface.DEFAULT, Typeface.BOLD)&#10;            textSize = 14f&#10;        }&#10;&#10;        var y = 40f&#10;        val xPadding = 40f&#10;        val centerX = pageInfo.pageWidth / 2f&#10;&#10;        // Logo (if enabled and available)&#10;        if (settings?.printLogo == true &amp;&amp; !settings.storeLogo.isNullOrBlank()) {&#10;            try {&#10;                val logoFile = File(settings.storeLogo)&#10;                if (logoFile.exists()) {&#10;                    val bmp = BitmapFactory.decodeFile(settings.storeLogo)&#10;                    if (bmp != null) {&#10;                        val maxW = 100&#10;                        val ratio = bmp.width.toFloat() / bmp.height.toFloat()&#10;                        val w = maxW&#10;                        val h = (maxW / ratio).toInt().coerceAtLeast(1)&#10;                        val scaled = Bitmap.createScaledBitmap(bmp, w, h, true)&#10;                        val cx = (pageInfo.pageWidth - scaled.width) / 2f&#10;                        canvas.drawBitmap(scaled, cx, y, paint)&#10;                        y += scaled.height + 16&#10;                        bmp.recycle()&#10;                        scaled.recycle()&#10;                    }&#10;                }&#10;            } catch (_: Exception) { }&#10;        }&#10;&#10;        // Store name &amp; info&#10;        val storeName = settings?.storeName?.takeIf { it.isNotBlank() } ?: &quot;Nama Toko&quot;&#10;        val storeAddr = settings?.storeAddress?.takeIf { it.isNotBlank() } ?: &quot;Alamat toko&quot;&#10;        val storePhone = settings?.storePhone?.takeIf { it.isNotBlank() }&#10;        &#10;        drawCenteredText(canvas, storeName, centerX, y, titlePaint)&#10;        y += 24&#10;        drawCenteredText(canvas, storeAddr, centerX, y, smallPaint)&#10;        y += 14&#10;        storePhone?.let {&#10;            drawCenteredText(canvas, &quot;Telp: $it&quot;, centerX, y, smallPaint)&#10;            y += 14&#10;        }&#10;        &#10;        // Custom header&#10;        settings?.receiptHeader?.let {&#10;            if (it.isNotBlank()) {&#10;                y += 6&#10;                it.split(&quot;\n&quot;).take(3).forEach { line -&gt;&#10;                    if (line.isNotBlank()) {&#10;                        drawCenteredText(canvas, line.trim(), centerX, y, smallPaint)&#10;                        y += 14&#10;                    }&#10;                }&#10;            }&#10;        }&#10;        &#10;        y += 10&#10;&#10;        // Separator&#10;        y += 4f  // padding before divider&#10;        paint.strokeWidth = 2f&#10;        canvas.drawLine(xPadding, y, pageInfo.pageWidth - xPadding, y, paint)&#10;        y += 22f  // padding after divider&#10;&#10;        // Receipt Title&#10;        drawCenteredText(canvas, &quot;STRUK PEMBAYARAN&quot;, centerX, y, headerPaint)&#10;        y += 24&#10;&#10;        // Transaction header&#10;        val dateStr = dateFormat.format(Date(transaction.updatedAt))&#10;        canvas.drawText(&quot;No. Transaksi:&quot;, xPadding, y, boldPaint)&#10;        canvas.drawText(transaction.transactionNumber, xPadding + 100f, y, normalPaint)&#10;        y += 16&#10;        canvas.drawText(&quot;Tanggal:&quot;, xPadding, y, boldPaint)&#10;        canvas.drawText(dateStr, xPadding + 100f, y, normalPaint)&#10;        y += 16&#10;        canvas.drawText(&quot;Kasir:&quot;, xPadding, y, boldPaint)&#10;        canvas.drawText(transaction.cashierName, xPadding + 100f, y, normalPaint)&#10;        y += 20f&#10;&#10;        // Separator&#10;        y += 4f  // padding before divider&#10;        paint.strokeWidth = 1f&#10;        paint.color = Color.LTGRAY&#10;        canvas.drawLine(xPadding, y, pageInfo.pageWidth - xPadding, y, paint)&#10;        y += 18f  // padding after divider&#10;&#10;        // Items table header&#10;        val qtyColumnX = pageInfo.pageWidth - 250f  // Adjusted for better spacing&#10;        val priceColumnX = pageInfo.pageWidth - 180f  // Adjusted for better spacing&#10;        val subtotalColumnX = pageInfo.pageWidth - xPadding - boldPaint.measureText(&quot;00.000.000&quot;)  // Space for millions&#10;&#10;        canvas.drawText(&quot;Item&quot;, xPadding, y, boldPaint)&#10;        canvas.drawText(&quot;Qty&quot;, qtyColumnX, y, boldPaint)&#10;        canvas.drawText(&quot;Harga&quot;, priceColumnX, y, boldPaint)&#10;        canvas.drawText(&quot;Subtotal&quot;, pageInfo.pageWidth - xPadding - boldPaint.measureText(&quot;Subtotal&quot;), y, boldPaint)&#10;        y += 6f  // padding before divider&#10;        canvas.drawLine(xPadding, y, pageInfo.pageWidth - xPadding, y, paint)&#10;        y += 16f  // padding after divider&#10;&#10;        // Items&#10;        items.forEach { item -&gt;&#10;            val name = item.productName&#10;            val qty = &quot;${item.quantity}&quot;&#10;            val sub = nf.format(item.subtotal).replace(&quot;Rp&quot;, &quot;Rp &quot;)&#10;&#10;            // If item has discount, show original price with strikethrough&#10;            if (item.discount &gt; 0) {&#10;                val originalPrice = item.productPrice&#10;                val discountedPrice = item.unitPrice&#10;&#10;                // Name&#10;                canvas.drawText(name, xPadding, y, normalPaint)&#10;                canvas.drawText(qty, qtyColumnX, y, normalPaint)&#10;&#10;                // Original price with strikethrough&#10;                val origPriceStr = nf.format(originalPrice).replace(&quot;Rp&quot;, &quot;Rp &quot;)&#10;                canvas.drawText(origPriceStr, priceColumnX, y, normalPaint)&#10;                val textWidth = normalPaint.measureText(origPriceStr)&#10;                val lineY = y - 4f&#10;                canvas.drawLine(priceColumnX, lineY, priceColumnX + textWidth, lineY, normalPaint)&#10;&#10;                canvas.drawText(sub, pageInfo.pageWidth - xPadding - normalPaint.measureText(sub), y, normalPaint)&#10;                y += 18f&#10;&#10;                // Discounted price line&#10;                val discPriceStr = nf.format(discountedPrice).replace(&quot;Rp&quot;, &quot;Rp &quot;)&#10;                canvas.drawText(&quot;Harga diskon: $discPriceStr&quot;, xPadding + 20f, y, smallPaint)&#10;                y += 14f&#10;&#10;                // Discount amount&#10;                val discPart = &quot;Diskon: -${nf.format(item.discount).replace(&quot;Rp&quot;, &quot;Rp &quot;)}&quot;&#10;                canvas.drawText(discPart, xPadding + 20f, y, smallPaint)&#10;                y += 18f&#10;            } else {&#10;                // No discount - simple format&#10;                val price = nf.format(item.unitPrice).replace(&quot;Rp&quot;, &quot;Rp &quot;)&#10;&#10;                canvas.drawText(name, xPadding, y, normalPaint)&#10;                canvas.drawText(qty, qtyColumnX, y, normalPaint)&#10;                canvas.drawText(price, priceColumnX, y, normalPaint)&#10;                canvas.drawText(sub, pageInfo.pageWidth - xPadding - normalPaint.measureText(sub), y, normalPaint)&#10;                y += 18f&#10;            }&#10;        }&#10;&#10;        y += 8f  // padding before divider&#10;        // Separator&#10;        canvas.drawLine(xPadding, y, pageInfo.pageWidth - xPadding, y, paint)&#10;        y += 18f  // padding after divider&#10;&#10;        // Totals - right aligned&#10;        val rightX = pageInfo.pageWidth - xPadding&#10;        val labelX = rightX - 150f&#10;        &#10;        val subtotalStr = nf.format(transaction.subtotal).replace(&quot;Rp&quot;, &quot;Rp &quot;)&#10;        val taxStr = nf.format(transaction.tax).replace(&quot;Rp&quot;, &quot;Rp &quot;)&#10;        val discountStr = nf.format(transaction.discount).replace(&quot;Rp&quot;, &quot;Rp &quot;)&#10;        val totalStr = nf.format(transaction.total).replace(&quot;Rp&quot;, &quot;Rp &quot;)&#10;&#10;        canvas.drawText(&quot;Subtotal:&quot;, labelX, y, normalPaint)&#10;        canvas.drawText(subtotalStr, rightX - normalPaint.measureText(subtotalStr), y, normalPaint)&#10;        y += 16&#10;&#10;        if (transaction.tax &gt; 0) {&#10;            canvas.drawText(&quot;PPN:&quot;, labelX, y, normalPaint)&#10;            canvas.drawText(taxStr, rightX - normalPaint.measureText(taxStr), y, normalPaint)&#10;            y += 16&#10;        }&#10;        if (transaction.discount &gt; 0) {&#10;            canvas.drawText(&quot;Diskon:&quot;, labelX, y, normalPaint)&#10;            canvas.drawText(&quot;-$discountStr&quot;, rightX - normalPaint.measureText(&quot;-$discountStr&quot;), y, normalPaint)&#10;            y += 16&#10;        }&#10;&#10;        y += 8f  // padding before divider&#10;        paint.strokeWidth = 2f&#10;        paint.color = Color.BLACK&#10;        canvas.drawLine(labelX - 10f, y, rightX, y, paint)&#10;        y += 20f  // padding after divider&#10;&#10;        // Grand Total&#10;        val grandTotalPaint = Paint(Paint.ANTI_ALIAS_FLAG).apply {&#10;            textSize = 16f&#10;            typeface = Typeface.create(Typeface.DEFAULT, Typeface.BOLD)&#10;        }&#10;        canvas.drawText(&quot;TOTAL:&quot;, labelX, y, grandTotalPaint)&#10;        canvas.drawText(totalStr, rightX - grandTotalPaint.measureText(totalStr), y, grandTotalPaint)&#10;        y += 24&#10;&#10;        // Payment method&#10;        val paymentMethodName = when (transaction.paymentMethod.name) {&#10;            &quot;CASH&quot; -&gt; &quot;Tunai&quot;&#10;            &quot;DEBIT&quot; -&gt; &quot;Debit&quot;&#10;            &quot;CREDIT&quot; -&gt; &quot;Kredit&quot;&#10;            &quot;QRIS&quot; -&gt; &quot;QRIS&quot;&#10;            &quot;TRANSFER&quot; -&gt; &quot;Transfer&quot;&#10;            else -&gt; transaction.paymentMethod.name&#10;        }&#10;        canvas.drawText(&quot;Metode Pembayaran:&quot;, labelX, y, normalPaint)&#10;        canvas.drawText(paymentMethodName, rightX - normalPaint.measureText(paymentMethodName), y, normalPaint)&#10;        y += 16&#10;&#10;        // Payment info if cash&#10;        val received = transaction.cashReceived&#10;        if (received &gt; 0) {&#10;            val receivedStr = nf.format(received).replace(&quot;Rp&quot;, &quot;Rp &quot;)&#10;            val change = (received - transaction.total).coerceAtLeast(0.0)&#10;            val changeStr = nf.format(change).replace(&quot;Rp&quot;, &quot;Rp &quot;)&#10;            &#10;            canvas.drawText(&quot;Dibayar:&quot;, labelX, y, normalPaint)&#10;            canvas.drawText(receivedStr, rightX - normalPaint.measureText(receivedStr), y, normalPaint)&#10;            y += 16&#10;            &#10;            if (change &gt; 0) {&#10;                canvas.drawText(&quot;Kembalian:&quot;, labelX, y, boldPaint)&#10;                canvas.drawText(changeStr, rightX - boldPaint.measureText(changeStr), y, boldPaint)&#10;                y += 16&#10;            }&#10;        }&#10;&#10;        // Footer&#10;        y += 20f&#10;        y += 4f  // padding before divider&#10;        paint.strokeWidth = 1f&#10;        paint.color = Color.LTGRAY&#10;        canvas.drawLine(xPadding, y, pageInfo.pageWidth - xPadding, y, paint)&#10;        y += 18f  // padding after divider&#10;&#10;        drawCenteredText(canvas, &quot;Terima kasih atas kunjungan Anda&quot;, centerX, y, normalPaint)&#10;        y += 16&#10;        &#10;        settings?.receiptFooter?.let {&#10;            if (it.isNotBlank()) {&#10;                it.split(&quot;\n&quot;).take(3).forEach { line -&gt;&#10;                    if (line.isNotBlank()) {&#10;                        drawCenteredText(canvas, line.trim(), centerX, y, smallPaint)&#10;                        y += 14&#10;                    }&#10;                }&#10;                y += 6&#10;            }&#10;        }&#10;        &#10;        drawCenteredText(canvas, &quot;-- Struk ini sah tanpa tanda tangan --&quot;, centerX, y, smallPaint)&#10;&#10;        doc.finishPage(page)&#10;&#10;        val fileName = &quot;Receipt-${transaction.transactionNumber}.pdf&quot;&#10;        val file = File(context.cacheDir, fileName)&#10;        FileOutputStream(file).use { out -&gt; doc.writeTo(out) }&#10;        doc.close()&#10;        return Result(file.toUri(), fileName)&#10;    }&#10;&#10;    fun generateThermalReceiptPdf(&#10;        context: Context,&#10;        settings: StoreSettings?,&#10;        transaction: TransactionEntity,&#10;        items: List&lt;TransactionItemEntity&gt;&#10;    ): Result {&#10;        val paperWidthMm = settings?.paperWidthMm ?: 58&#10;        val charsPerLine = settings?.paperCharPerLine ?: if (paperWidthMm &gt;= 80) 48 else 32&#10;        // Approximate pixel width for 58mm (~384px) and 80mm (~576px)&#10;        val pageWidthPx = if (paperWidthMm &gt;= 80) 576 else 384&#10;        val pageHeightPx = 1400 // Increased height for better layout&#10;        val doc = PdfDocument()&#10;        val pageInfo = PdfDocument.PageInfo.Builder(pageWidthPx, pageHeightPx, 1).create()&#10;        val page = doc.startPage(pageInfo)&#10;        val canvas = page.canvas&#10;&#10;        val nf = NumberFormat.getCurrencyInstance(Locale.Builder().setLanguage(&quot;id&quot;).setRegion(&quot;ID&quot;).build())&#10;        val dateFormat = SimpleDateFormat(&quot;dd/MM/yyyy HH:mm&quot;, Locale(&quot;id&quot;, &quot;ID&quot;))&#10;&#10;        val titlePaint = Paint(Paint.ANTI_ALIAS_FLAG).apply {&#10;            textSize = 18f&#10;            typeface = Typeface.create(Typeface.DEFAULT, Typeface.BOLD)&#10;            textAlign = Paint.Align.CENTER&#10;        }&#10;        val textPaint = Paint(Paint.ANTI_ALIAS_FLAG).apply { &#10;            textSize = 14f&#10;            typeface = Typeface.create(Typeface.DEFAULT, Typeface.NORMAL)&#10;        }&#10;        val boldPaint = Paint(Paint.ANTI_ALIAS_FLAG).apply {&#10;            textSize = 14f&#10;            typeface = Typeface.create(Typeface.DEFAULT, Typeface.BOLD)&#10;        }&#10;        val smallPaint = Paint(Paint.ANTI_ALIAS_FLAG).apply { &#10;            textSize = 11f &#10;            color = Color.DKGRAY&#10;        }&#10;        val dividerPaint = Paint(Paint.ANTI_ALIAS_FLAG).apply { &#10;            strokeWidth = 1f&#10;            color = Color.LTGRAY&#10;        }&#10;        val boldDividerPaint = Paint(Paint.ANTI_ALIAS_FLAG).apply { &#10;            strokeWidth = 2f&#10;            color = Color.BLACK&#10;        }&#10;&#10;        var y = 16f&#10;        val left = 12f&#10;        val right = pageWidthPx - 12f&#10;        val centerX = pageWidthPx / 2f&#10;&#10;        fun drawLine(bold: Boolean = false) {&#10;            y += 4f  // padding before line&#10;            canvas.drawLine(left, y, right, y, if (bold) boldDividerPaint else dividerPaint)&#10;            y += if (bold) 12f else 10f  // padding after line&#10;        }&#10;&#10;        fun drawTextLine(line: String, paint: Paint = textPaint) {&#10;            canvas.drawText(line.take(charsPerLine), left, y, paint)&#10;            y += 18f&#10;        }&#10;&#10;        // Logo (if enabled and available)&#10;        if (settings?.printLogo == true &amp;&amp; !settings.storeLogo.isNullOrBlank()) {&#10;            try {&#10;                val logoFile = File(settings.storeLogo)&#10;                if (logoFile.exists()) {&#10;                    val bmp = BitmapFactory.decodeFile(settings.storeLogo)&#10;                    if (bmp != null) {&#10;                        val maxW = if (paperWidthMm &gt;= 80) 120 else 80&#10;                        val ratio = bmp.width.toFloat() / bmp.height.toFloat()&#10;                        val w = maxW&#10;                        val h = (maxW / ratio).toInt().coerceAtLeast(1)&#10;                        val scaled = Bitmap.createScaledBitmap(bmp, w, h, true)&#10;                        val cx = (pageWidthPx - scaled.width) / 2f&#10;                        canvas.drawBitmap(scaled, cx, y, null)&#10;                        y += scaled.height + 8&#10;                        bmp.recycle()&#10;                        scaled.recycle()&#10;                    }&#10;                }&#10;            } catch (_: Exception) { }&#10;        }&#10;&#10;        // Header - Store Name&#10;        val name = (settings?.storeName ?: &quot;Toko&quot;).uppercase()&#10;        canvas.drawText(name, centerX, y, titlePaint)&#10;        y += 22f&#10;        &#10;        // Address and phone&#10;        val addr = settings?.storeAddress ?: &quot;Alamat&quot;&#10;        if (addr.isNotBlank()) {&#10;            drawCenteredText(canvas, addr.take(charsPerLine), centerX, y, smallPaint)&#10;            y += 16f&#10;        }&#10;        val phone = settings?.storePhone ?: &quot;&quot;&#10;        if (phone.isNotBlank()) {&#10;            drawCenteredText(canvas, &quot;Telp: $phone&quot;, centerX, y, smallPaint)&#10;            y += 16f&#10;        }&#10;        &#10;        // Custom header&#10;        settings?.receiptHeader?.let {&#10;            if (it.isNotBlank()) {&#10;                it.split(&quot;\n&quot;).take(3).forEach { line -&gt;&#10;                    if (line.isNotBlank()) {&#10;                        drawCenteredText(canvas, line.trim().take(charsPerLine), centerX, y, smallPaint)&#10;                        y += 16f&#10;                    }&#10;                }&#10;            }&#10;        }&#10;        &#10;        drawLine(bold = true)&#10;        &#10;        // Transaction info&#10;        val dateStr = dateFormat.format(Date(transaction.updatedAt))&#10;        canvas.drawText(&quot;No: ${transaction.transactionNumber}&quot;, left, y, textPaint)&#10;        y += 16f&#10;        canvas.drawText(&quot;Tanggal: $dateStr&quot;, left, y, textPaint)&#10;        y += 16f&#10;        canvas.drawText(&quot;Kasir: ${transaction.cashierName}&quot;, left, y, textPaint)&#10;        y += 4f&#10;        drawLine()&#10;&#10;        // Items header&#10;        canvas.drawText(&quot;ITEM&quot;, left, y, boldPaint)&#10;        // Move JUMLAH column more to the left to accommodate larger amounts&#10;        val amountColumnX = right - 85f  // Adjusted from far right to support millions&#10;        canvas.drawText(&quot;JUMLAH&quot;, amountColumnX, y, boldPaint)&#10;        y += 4f&#10;        drawLine()&#10;&#10;        // Items&#10;        items.forEach { item -&gt;&#10;            // Product name&#10;            val name = item.productName.take(charsPerLine - 12)  // Leave space for amount&#10;            canvas.drawText(name, left, y, textPaint)&#10;            y += 16f&#10;            &#10;            // If item has discount, show original price with strikethrough&#10;            if (item.discount &gt; 0) {&#10;                val originalPrice = item.productPrice&#10;                val origPriceStr = &quot;@${nf.format(originalPrice).replace(&quot;Rp&quot;, &quot;Rp &quot;)}&quot;&#10;                canvas.drawText(origPriceStr, left + 8f, y, smallPaint)&#10;&#10;                // Draw strikethrough line&#10;                val textWidth = smallPaint.measureText(origPriceStr)&#10;                val lineY = y - 4f&#10;                canvas.drawLine(left + 8f, lineY, left + 8f + textWidth, lineY, smallPaint)&#10;                y += 14f&#10;            }&#10;&#10;            // Quantity, discounted price and subtotal&#10;            val qtyPart = &quot;${item.quantity} x ${nf.format(item.unitPrice).replace(&quot;Rp&quot;, &quot;Rp &quot;)}&quot;&#10;            val subPart = nf.format(item.subtotal).replace(&quot;Rp&quot;, &quot;Rp &quot;)&#10;            canvas.drawText(qtyPart, left + 8f, y, smallPaint)&#10;            // Right align subtotal at the amount column&#10;            canvas.drawText(subPart, right - smallPaint.measureText(subPart), y, textPaint)&#10;            y += 18f&#10;            &#10;            // Discount amount if any&#10;            if (item.discount &gt; 0) {&#10;                val discountPart = &quot;Diskon: -${nf.format(item.discount).replace(&quot;Rp&quot;, &quot;Rp &quot;)}&quot;&#10;                canvas.drawText(discountPart, left + 8f, y, smallPaint)&#10;                y += 16f&#10;            }&#10;        }&#10;        y += 4f&#10;        drawLine(bold = true)&#10;&#10;        // Totals&#10;        fun drawTotal(label: String, value: Double, paint: Paint = textPaint, negative: Boolean = false) {&#10;            val valueStr = nf.format(value).replace(&quot;Rp&quot;, &quot;Rp &quot;)&#10;            canvas.drawText(label, left, y, paint)&#10;            val display = if (negative) &quot;-$valueStr&quot; else valueStr&#10;            canvas.drawText(display, right - paint.measureText(display), y, paint)&#10;            y += 18f&#10;        }&#10;        &#10;        drawTotal(&quot;Subtotal&quot;, transaction.subtotal, textPaint)&#10;        if (transaction.tax &gt; 0) drawTotal(&quot;PPN&quot;, transaction.tax, textPaint)&#10;        if (transaction.discount &gt; 0) drawTotal(&quot;Diskon&quot;, transaction.discount, textPaint, negative = true)&#10;        &#10;        y += 4f&#10;        drawLine(bold = true)&#10;        &#10;        // Grand Total - larger and bold&#10;        val grandTotalPaint = Paint(Paint.ANTI_ALIAS_FLAG).apply {&#10;            textSize = 16f&#10;            typeface = Typeface.create(Typeface.DEFAULT, Typeface.BOLD)&#10;        }&#10;        val totalStr = nf.format(transaction.total).replace(&quot;Rp&quot;, &quot;Rp &quot;)&#10;        canvas.drawText(&quot;TOTAL&quot;, left, y, grandTotalPaint)&#10;        canvas.drawText(totalStr, right - grandTotalPaint.measureText(totalStr), y, grandTotalPaint)&#10;        y += 22f&#10;        &#10;        drawLine()&#10;&#10;        // Payment info&#10;        val paymentMethodName = when (transaction.paymentMethod.name) {&#10;            &quot;CASH&quot; -&gt; &quot;Tunai&quot;&#10;            &quot;DEBIT&quot; -&gt; &quot;Debit&quot;&#10;            &quot;CREDIT&quot; -&gt; &quot;Kredit&quot;&#10;            &quot;QRIS&quot; -&gt; &quot;QRIS&quot;&#10;            &quot;TRANSFER&quot; -&gt; &quot;Transfer&quot;&#10;            else -&gt; transaction.paymentMethod.name&#10;        }&#10;        canvas.drawText(&quot;Metode: $paymentMethodName&quot;, left, y, textPaint)&#10;        y += 18f&#10;        &#10;        val received = transaction.cashReceived&#10;        if (received &gt; 0) {&#10;            val change = (received - transaction.total).coerceAtLeast(0.0)&#10;            drawTotal(&quot;Dibayar&quot;, received, textPaint)&#10;            if (change &gt; 0) {&#10;                drawTotal(&quot;Kembali&quot;, change, boldPaint)&#10;            }&#10;        }&#10;        &#10;        y += 8f&#10;        drawLine(bold = true)&#10;&#10;        // Footer&#10;        y += 8f&#10;        drawCenteredText(canvas, &quot;Terima kasih atas kunjungan Anda&quot;, centerX, y, textPaint)&#10;        y += 18f&#10;        &#10;        settings?.receiptFooter?.let {&#10;            if (it.isNotBlank()) {&#10;                it.split(&quot;\n&quot;).take(3).forEach { line -&gt;&#10;                    if (line.isNotBlank()) {&#10;                        drawCenteredText(canvas, line.trim().take(charsPerLine), centerX, y, smallPaint)&#10;                        y += 16f&#10;                    }&#10;                }&#10;            }&#10;        }&#10;        &#10;        y += 8f&#10;        drawCenteredText(canvas, &quot;-- Struk ini sah tanpa tanda tangan --&quot;, centerX, y, smallPaint)&#10;&#10;        doc.finishPage(page)&#10;        val fileName = &quot;Receipt-${transaction.transactionNumber}-${paperWidthMm}mm.pdf&quot;&#10;        val file = File(context.cacheDir, fileName)&#10;        FileOutputStream(file).use { out -&gt; doc.writeTo(out) }&#10;        doc.close()&#10;        return Result(file.toUri(), fileName)&#10;    }&#10;&#10;    /**&#10;     * Generate queue number ticket (thermal)&#10;     */&#10;    fun generateQueueTicketPdf(&#10;        context: Context,&#10;        settings: StoreSettings?,&#10;        transaction: TransactionEntity&#10;    ): Result {&#10;        val dateFormat = SimpleDateFormat(&quot;yyyyMMdd_HHmmss&quot;, Locale.getDefault())&#10;        val fileName = &quot;Antrian_${transaction.transactionNumber}_${dateFormat.format(Date())}.pdf&quot;&#10;        val file = File(context.cacheDir, fileName)&#10;&#10;        val pageWidth = if (settings?.paperWidthMm?.let { it &gt;= 80 } == true) 576f else 384f&#10;        val pageHeight = 400f // Short ticket&#10;        val document = PdfDocument()&#10;        val pageInfo = PdfDocument.PageInfo.Builder(pageWidth.toInt(), pageHeight.toInt(), 1).create()&#10;        val page = document.startPage(pageInfo)&#10;        val canvas = page.canvas&#10;&#10;        val paint = Paint().apply {&#10;            color = Color.DKGRAY&#10;            textSize = 28f&#10;            typeface = Typeface.create(Typeface.DEFAULT, Typeface.NORMAL)&#10;        }&#10;        val boldPaint = Paint(paint).apply {&#10;            typeface = Typeface.create(Typeface.DEFAULT, Typeface.BOLD)&#10;            textSize = 32f&#10;        }&#10;        val titlePaint = Paint(paint).apply {&#10;            typeface = Typeface.create(Typeface.DEFAULT, Typeface.BOLD)&#10;            textSize = 48f&#10;            textAlign = Paint.Align.CENTER&#10;        }&#10;&#10;        var y = 40f&#10;        val left = 20f&#10;        val center = pageWidth / 2&#10;&#10;        // Header&#10;        canvas.drawText(&quot;NOMOR ANTRIAN&quot;, center, y, titlePaint)&#10;        y += 60f&#10;&#10;        // Queue Number (from transaction number - extract last 4 digits)&#10;        val queueNumber = transaction.transactionNumber.substringAfterLast('-')&#10;        titlePaint.textSize = 72f&#10;        canvas.drawText(queueNumber, center, y, titlePaint)&#10;        y += 80f&#10;&#10;        titlePaint.textSize = 28f&#10;        titlePaint.textAlign = Paint.Align.LEFT&#10;&#10;        // Transaction summary&#10;        val dateFormatter = SimpleDateFormat(&quot;dd MMM yyyy, HH:mm&quot;, Locale(&quot;id&quot;, &quot;ID&quot;))&#10;        canvas.drawText(&quot;Transaksi: ${transaction.transactionNumber}&quot;, left, y, paint)&#10;        y += 30f&#10;        canvas.drawText(&quot;Waktu: ${dateFormatter.format(Date(transaction.transactionDate))}&quot;, left, y, paint)&#10;        y += 30f&#10;&#10;        val nf = NumberFormat.getCurrencyInstance(Locale(&quot;id&quot;, &quot;ID&quot;))&#10;        canvas.drawText(&quot;Total: ${nf.format(transaction.total).replace(&quot;Rp&quot;, &quot;Rp &quot;)}&quot;, left, y, boldPaint)&#10;        y += 40f&#10;&#10;        // Footer&#10;        paint.textAlign = Paint.Align.CENTER&#10;        canvas.drawText(&quot;Terima kasih&quot;, center, y, paint)&#10;&#10;        document.finishPage(page)&#10;&#10;        try {&#10;            document.writeTo(FileOutputStream(file))&#10;            val uri = androidx.core.content.FileProvider.getUriForFile(&#10;                context,&#10;                &quot;${context.packageName}.fileprovider&quot;,&#10;                file&#10;            )&#10;            return Result(uri, fileName)&#10;        } finally {&#10;            document.close()&#10;        }&#10;    }&#10;&#10;    fun printOrSave(&#10;        context: Context,&#10;        settings: StoreSettings?,&#10;        pdfUri: Uri,&#10;        jobName: String&#10;    ) {&#10;        if (settings?.printerConnected == true) {&#10;            val printManager = context.getSystemService(Context.PRINT_SERVICE) as PrintManager&#10;            val adapter = PdfFilePrintAdapter(context, pdfUri, jobName)&#10;            val attr = PrintAttributes.Builder()&#10;                .setMediaSize(PrintAttributes.MediaSize.NA_LETTER.asPortrait())&#10;                .setColorMode(PrintAttributes.COLOR_MODE_MONOCHROME)&#10;                .build()&#10;            printManager.print(jobName, adapter, attr)&#10;        } else {&#10;            saveToDownloads(context, pdfUri, jobName)&#10;        }&#10;    }&#10;&#10;    private fun saveToDownloads(context: Context, pdfUri: Uri, fileName: String) {&#10;        try {&#10;            if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.Q) {&#10;                val values = ContentValues().apply {&#10;                    put(MediaStore.Downloads.DISPLAY_NAME, fileName)&#10;                    put(MediaStore.Downloads.MIME_TYPE, &quot;application/pdf&quot;)&#10;                    put(MediaStore.Downloads.IS_PENDING, 1)&#10;                }&#10;                val resolver = context.contentResolver&#10;                val collection = MediaStore.Downloads.EXTERNAL_CONTENT_URI&#10;                val itemUri = resolver.insert(collection, values) ?: return&#10;                resolver.openOutputStream(itemUri)?.use { out -&gt;&#10;                    resolver.openInputStream(pdfUri)?.use { input -&gt;&#10;                        input.copyTo(out)&#10;                    }&#10;                }&#10;                values.clear()&#10;                values.put(MediaStore.Downloads.IS_PENDING, 0)&#10;                resolver.update(itemUri, values, null, null)&#10;            } else {&#10;                val dir = Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOWNLOADS)&#10;                if (!dir.exists()) dir.mkdirs()&#10;                val outFile = File(dir, fileName)&#10;                context.contentResolver.openInputStream(pdfUri)?.use { input -&gt;&#10;                    FileOutputStream(outFile).use { out -&gt; input.copyTo(out) }&#10;                }&#10;            }&#10;        } catch (_: Exception) { }&#10;    }&#10;&#10;    fun sharePdf(context: Context, pdfUri: Uri) {&#10;        val intent = android.content.Intent(android.content.Intent.ACTION_SEND).apply {&#10;            type = &quot;application/pdf&quot;&#10;            putExtra(android.content.Intent.EXTRA_STREAM, pdfUri)&#10;            addFlags(android.content.Intent.FLAG_GRANT_READ_URI_PERMISSION)&#10;        }&#10;        context.startActivity(&#10;            android.content.Intent.createChooser(intent, &quot;Bagikan Struk&quot;)&#10;                .addFlags(android.content.Intent.FLAG_ACTIVITY_NEW_TASK)&#10;        )&#10;    }&#10;&#10;    private fun drawCenteredText(canvas: Canvas, text: String, cx: Float, y: Float, paint: Paint) {&#10;        val w = paint.measureText(text)&#10;        canvas.drawText(text, cx - w / 2f, y, paint)&#10;    }&#10;&#10;    fun printQueueOrPdf(&#10;        context: Context,&#10;        settings: StoreSettings?,&#10;        transaction: TransactionEntity&#10;    ): ESCPosPrinter.PrintResult? {&#10;        return if (settings?.useEscPosDirect == true &amp;&amp; !settings.printerAddress.isNullOrBlank()) {&#10;            // Return PrintResult for ESC/POS direct print&#10;            ESCPosPrinter.printQueueTicket(context, settings, transaction)&#10;        } else {&#10;            // For PDF, just generate and print/save, return null (no need for PrintResult)&#10;            val result = generateQueueTicketPdf(context, settings, transaction)&#10;            printOrSave(context, settings, result.pdfUri, result.fileName)&#10;            null&#10;        }&#10;    }&#10;}&#10;&#10;private class PdfFilePrintAdapter(&#10;    private val context: Context,&#10;    private val pdfUri: Uri,&#10;    private val jobName: String&#10;) : PrintDocumentAdapter() {&#10;&#10;    override fun onLayout(&#10;        oldAttributes: PrintAttributes?,&#10;        newAttributes: PrintAttributes,&#10;        cancellationSignal: android.os.CancellationSignal?,&#10;        callback: LayoutResultCallback,&#10;        extras: android.os.Bundle?&#10;    ) {&#10;        val info = PrintDocumentInfo.Builder(jobName)&#10;            .setContentType(PrintDocumentInfo.CONTENT_TYPE_DOCUMENT)&#10;            .setPageCount(PrintDocumentInfo.PAGE_COUNT_UNKNOWN)&#10;            .build()&#10;        callback.onLayoutFinished(info, true)&#10;    }&#10;&#10;    override fun onWrite(&#10;        pages: Array&lt;PageRange&gt;,&#10;        destination: ParcelFileDescriptor,&#10;        cancellationSignal: android.os.CancellationSignal,&#10;        callback: WriteResultCallback&#10;    ) {&#10;        try {&#10;            context.contentResolver.openInputStream(pdfUri)?.use { input -&gt;&#10;                FileOutputStream(destination.fileDescriptor).use { output -&gt;&#10;                    input.copyTo(output)&#10;                }&#10;            }&#10;            callback.onWriteFinished(arrayOf(PageRange.ALL_PAGES))&#10;        } catch (e: Exception) {&#10;            callback.onWriteFailed(e.message)&#10;        }&#10;    }&#10;}&#10;" />
              <option name="updatedContent" value="package id.stargan.intikasir.feature.pos.print&#10;&#10;import android.content.ContentValues&#10;import android.content.Context&#10;import android.widget.Toast&#10;import android.graphics.*&#10;import android.graphics.pdf.PdfDocument&#10;import android.net.Uri&#10;import android.os.Build&#10;import android.os.Environment&#10;import android.os.ParcelFileDescriptor&#10;import android.provider.MediaStore&#10;import android.print.PrintAttributes&#10;import android.print.PrintDocumentAdapter&#10;import android.print.PrintDocumentInfo&#10;import android.print.PageRange&#10;import android.print.PrintManager&#10;import androidx.core.net.toUri&#10;import id.stargan.intikasir.data.local.entity.TransactionEntity&#10;import id.stargan.intikasir.data.local.entity.TransactionItemEntity&#10;import id.stargan.intikasir.domain.model.StoreSettings&#10;import java.io.File&#10;import java.io.FileOutputStream&#10;import java.text.NumberFormat&#10;import java.text.SimpleDateFormat&#10;import java.util.Date&#10;import java.util.Locale&#10;&#10;object ReceiptPrinter {&#10;&#10;    data class Result(val pdfUri: Uri, val fileName: String)&#10;&#10;    fun generateReceiptPdf(&#10;        context: Context,&#10;        settings: StoreSettings?,&#10;        transaction: TransactionEntity,&#10;        items: List&lt;TransactionItemEntity&gt;&#10;    ): Result {&#10;        val doc = PdfDocument()&#10;        val pageInfo = PdfDocument.PageInfo.Builder(595, 842, 1).create() // A4 portrait&#10;        val page = doc.startPage(pageInfo)&#10;        val canvas = page.canvas&#10;&#10;        val nf = NumberFormat.getCurrencyInstance(Locale.Builder().setLanguage(&quot;id&quot;).setRegion(&quot;ID&quot;).build())&#10;        val dateFormat = SimpleDateFormat(&quot;dd MMMM yyyy, HH:mm&quot;, Locale(&quot;id&quot;, &quot;ID&quot;))&#10;        val paint = Paint(Paint.ANTI_ALIAS_FLAG)&#10;        val titlePaint = Paint(Paint.ANTI_ALIAS_FLAG).apply {&#10;            typeface = Typeface.create(Typeface.DEFAULT, Typeface.BOLD)&#10;            textSize = 20f&#10;        }&#10;        val smallPaint = Paint(Paint.ANTI_ALIAS_FLAG).apply { &#10;            textSize = 10f&#10;            color = Color.DKGRAY&#10;        }&#10;        val normalPaint = Paint(Paint.ANTI_ALIAS_FLAG).apply { textSize = 12f }&#10;        val boldPaint = Paint(Paint.ANTI_ALIAS_FLAG).apply {&#10;            typeface = Typeface.create(Typeface.DEFAULT, Typeface.BOLD)&#10;            textSize = 12f&#10;        }&#10;        val headerPaint = Paint(Paint.ANTI_ALIAS_FLAG).apply {&#10;            typeface = Typeface.create(Typeface.DEFAULT, Typeface.BOLD)&#10;            textSize = 14f&#10;        }&#10;&#10;        var y = 40f&#10;        val xPadding = 40f&#10;        val centerX = pageInfo.pageWidth / 2f&#10;&#10;        // Logo (if enabled and available)&#10;        if (settings?.printLogo == true &amp;&amp; !settings.storeLogo.isNullOrBlank()) {&#10;            try {&#10;                val logoFile = File(settings.storeLogo)&#10;                if (logoFile.exists()) {&#10;                    val bmp = BitmapFactory.decodeFile(settings.storeLogo)&#10;                    if (bmp != null) {&#10;                        val maxW = 100&#10;                        val ratio = bmp.width.toFloat() / bmp.height.toFloat()&#10;                        val w = maxW&#10;                        val h = (maxW / ratio).toInt().coerceAtLeast(1)&#10;                        val scaled = Bitmap.createScaledBitmap(bmp, w, h, true)&#10;                        val cx = (pageInfo.pageWidth - scaled.width) / 2f&#10;                        canvas.drawBitmap(scaled, cx, y, paint)&#10;                        y += scaled.height + 16&#10;                        bmp.recycle()&#10;                        scaled.recycle()&#10;                    }&#10;                }&#10;            } catch (_: Exception) { }&#10;        }&#10;&#10;        // Store name &amp; info&#10;        val storeName = settings?.storeName?.takeIf { it.isNotBlank() } ?: &quot;Nama Toko&quot;&#10;        val storeAddr = settings?.storeAddress?.takeIf { it.isNotBlank() } ?: &quot;Alamat toko&quot;&#10;        val storePhone = settings?.storePhone?.takeIf { it.isNotBlank() }&#10;        &#10;        drawCenteredText(canvas, storeName, centerX, y, titlePaint)&#10;        y += 24&#10;        drawCenteredText(canvas, storeAddr, centerX, y, smallPaint)&#10;        y += 14&#10;        storePhone?.let {&#10;            drawCenteredText(canvas, &quot;Telp: $it&quot;, centerX, y, smallPaint)&#10;            y += 14&#10;        }&#10;        &#10;        // Custom header&#10;        settings?.receiptHeader?.let {&#10;            if (it.isNotBlank()) {&#10;                y += 6&#10;                it.split(&quot;\n&quot;).take(3).forEach { line -&gt;&#10;                    if (line.isNotBlank()) {&#10;                        drawCenteredText(canvas, line.trim(), centerX, y, smallPaint)&#10;                        y += 14&#10;                    }&#10;                }&#10;            }&#10;        }&#10;        &#10;        y += 10&#10;&#10;        // Separator&#10;        y += 4f  // padding before divider&#10;        paint.strokeWidth = 2f&#10;        canvas.drawLine(xPadding, y, pageInfo.pageWidth - xPadding, y, paint)&#10;        y += 22f  // padding after divider&#10;&#10;        // Receipt Title&#10;        drawCenteredText(canvas, &quot;STRUK PEMBAYARAN&quot;, centerX, y, headerPaint)&#10;        y += 24&#10;&#10;        // Transaction header&#10;        val dateStr = dateFormat.format(Date(transaction.updatedAt))&#10;        canvas.drawText(&quot;No. Transaksi:&quot;, xPadding, y, boldPaint)&#10;        canvas.drawText(transaction.transactionNumber, xPadding + 100f, y, normalPaint)&#10;        y += 16&#10;        canvas.drawText(&quot;Tanggal:&quot;, xPadding, y, boldPaint)&#10;        canvas.drawText(dateStr, xPadding + 100f, y, normalPaint)&#10;        y += 16&#10;        canvas.drawText(&quot;Kasir:&quot;, xPadding, y, boldPaint)&#10;        canvas.drawText(transaction.cashierName, xPadding + 100f, y, normalPaint)&#10;        y += 20f&#10;&#10;        // Separator&#10;        y += 4f  // padding before divider&#10;        paint.strokeWidth = 1f&#10;        paint.color = Color.LTGRAY&#10;        canvas.drawLine(xPadding, y, pageInfo.pageWidth - xPadding, y, paint)&#10;        y += 18f  // padding after divider&#10;&#10;        // Items table header&#10;        val qtyColumnX = pageInfo.pageWidth - 250f  // Adjusted for better spacing&#10;        val priceColumnX = pageInfo.pageWidth - 180f  // Adjusted for better spacing&#10;        val subtotalColumnX = pageInfo.pageWidth - xPadding - boldPaint.measureText(&quot;00.000.000&quot;)  // Space for millions&#10;&#10;        canvas.drawText(&quot;Item&quot;, xPadding, y, boldPaint)&#10;        canvas.drawText(&quot;Qty&quot;, qtyColumnX, y, boldPaint)&#10;        canvas.drawText(&quot;Harga&quot;, priceColumnX, y, boldPaint)&#10;        canvas.drawText(&quot;Subtotal&quot;, pageInfo.pageWidth - xPadding - boldPaint.measureText(&quot;Subtotal&quot;), y, boldPaint)&#10;        y += 6f  // padding before divider&#10;        canvas.drawLine(xPadding, y, pageInfo.pageWidth - xPadding, y, paint)&#10;        y += 16f  // padding after divider&#10;&#10;        // Items&#10;        items.forEach { item -&gt;&#10;            val name = item.productName&#10;            val qty = &quot;${item.quantity}&quot;&#10;            val sub = nf.format(item.subtotal).replace(&quot;Rp&quot;, &quot;Rp &quot;)&#10;&#10;            // If item has discount, show original price with strikethrough&#10;            if (item.discount &gt; 0) {&#10;                val originalPrice = item.productPrice&#10;                val discountedPrice = item.unitPrice&#10;&#10;                // Name&#10;                canvas.drawText(name, xPadding, y, normalPaint)&#10;                canvas.drawText(qty, qtyColumnX, y, normalPaint)&#10;&#10;                // Original price with strikethrough&#10;                val origPriceStr = nf.format(originalPrice).replace(&quot;Rp&quot;, &quot;Rp &quot;)&#10;                canvas.drawText(origPriceStr, priceColumnX, y, normalPaint)&#10;                val textWidth = normalPaint.measureText(origPriceStr)&#10;                val lineY = y - 4f&#10;                canvas.drawLine(priceColumnX, lineY, priceColumnX + textWidth, lineY, normalPaint)&#10;&#10;                canvas.drawText(sub, pageInfo.pageWidth - xPadding - normalPaint.measureText(sub), y, normalPaint)&#10;                y += 18f&#10;&#10;                // Discounted price line&#10;                val discPriceStr = nf.format(discountedPrice).replace(&quot;Rp&quot;, &quot;Rp &quot;)&#10;                canvas.drawText(&quot;Harga diskon: $discPriceStr&quot;, xPadding + 20f, y, smallPaint)&#10;                y += 14f&#10;&#10;                // Discount amount&#10;                val discPart = &quot;Diskon: -${nf.format(item.discount).replace(&quot;Rp&quot;, &quot;Rp &quot;)}&quot;&#10;                canvas.drawText(discPart, xPadding + 20f, y, smallPaint)&#10;                y += 18f&#10;            } else {&#10;                // No discount - simple format&#10;                val price = nf.format(item.unitPrice).replace(&quot;Rp&quot;, &quot;Rp &quot;)&#10;&#10;                canvas.drawText(name, xPadding, y, normalPaint)&#10;                canvas.drawText(qty, qtyColumnX, y, normalPaint)&#10;                canvas.drawText(price, priceColumnX, y, normalPaint)&#10;                canvas.drawText(sub, pageInfo.pageWidth - xPadding - normalPaint.measureText(sub), y, normalPaint)&#10;                y += 18f&#10;            }&#10;        }&#10;&#10;        y += 8f  // padding before divider&#10;        // Separator&#10;        canvas.drawLine(xPadding, y, pageInfo.pageWidth - xPadding, y, paint)&#10;        y += 18f  // padding after divider&#10;&#10;        // Totals - right aligned&#10;        val rightX = pageInfo.pageWidth - xPadding&#10;        val labelX = rightX - 150f&#10;        &#10;        val subtotalStr = nf.format(transaction.subtotal).replace(&quot;Rp&quot;, &quot;Rp &quot;)&#10;        val taxStr = nf.format(transaction.tax).replace(&quot;Rp&quot;, &quot;Rp &quot;)&#10;        val discountStr = nf.format(transaction.discount).replace(&quot;Rp&quot;, &quot;Rp &quot;)&#10;        val totalStr = nf.format(transaction.total).replace(&quot;Rp&quot;, &quot;Rp &quot;)&#10;&#10;        canvas.drawText(&quot;Subtotal:&quot;, labelX, y, normalPaint)&#10;        canvas.drawText(subtotalStr, rightX - normalPaint.measureText(subtotalStr), y, normalPaint)&#10;        y += 16&#10;&#10;        if (transaction.tax &gt; 0) {&#10;            canvas.drawText(&quot;PPN:&quot;, labelX, y, normalPaint)&#10;            canvas.drawText(taxStr, rightX - normalPaint.measureText(taxStr), y, normalPaint)&#10;            y += 16&#10;        }&#10;        if (transaction.discount &gt; 0) {&#10;            canvas.drawText(&quot;Diskon:&quot;, labelX, y, normalPaint)&#10;            canvas.drawText(&quot;-$discountStr&quot;, rightX - normalPaint.measureText(&quot;-$discountStr&quot;), y, normalPaint)&#10;            y += 16&#10;        }&#10;&#10;        y += 8f  // padding before divider&#10;        paint.strokeWidth = 2f&#10;        paint.color = Color.BLACK&#10;        canvas.drawLine(labelX - 10f, y, rightX, y, paint)&#10;        y += 20f  // padding after divider&#10;&#10;        // Grand Total&#10;        val grandTotalPaint = Paint(Paint.ANTI_ALIAS_FLAG).apply {&#10;            textSize = 16f&#10;            typeface = Typeface.create(Typeface.DEFAULT, Typeface.BOLD)&#10;        }&#10;        canvas.drawText(&quot;TOTAL:&quot;, labelX, y, grandTotalPaint)&#10;        canvas.drawText(totalStr, rightX - grandTotalPaint.measureText(totalStr), y, grandTotalPaint)&#10;        y += 24&#10;&#10;        // Payment method&#10;        val paymentMethodName = when (transaction.paymentMethod.name) {&#10;            &quot;CASH&quot; -&gt; &quot;Tunai&quot;&#10;            &quot;DEBIT&quot; -&gt; &quot;Debit&quot;&#10;            &quot;CREDIT&quot; -&gt; &quot;Kredit&quot;&#10;            &quot;QRIS&quot; -&gt; &quot;QRIS&quot;&#10;            &quot;TRANSFER&quot; -&gt; &quot;Transfer&quot;&#10;            else -&gt; transaction.paymentMethod.name&#10;        }&#10;        canvas.drawText(&quot;Metode Pembayaran:&quot;, labelX, y, normalPaint)&#10;        canvas.drawText(paymentMethodName, rightX - normalPaint.measureText(paymentMethodName), y, normalPaint)&#10;        y += 16&#10;&#10;        // Payment info if cash&#10;        val received = transaction.cashReceived&#10;        if (received &gt; 0) {&#10;            val receivedStr = nf.format(received).replace(&quot;Rp&quot;, &quot;Rp &quot;)&#10;            val change = (received - transaction.total).coerceAtLeast(0.0)&#10;            val changeStr = nf.format(change).replace(&quot;Rp&quot;, &quot;Rp &quot;)&#10;            &#10;            canvas.drawText(&quot;Dibayar:&quot;, labelX, y, normalPaint)&#10;            canvas.drawText(receivedStr, rightX - normalPaint.measureText(receivedStr), y, normalPaint)&#10;            y += 16&#10;            &#10;            if (change &gt; 0) {&#10;                canvas.drawText(&quot;Kembalian:&quot;, labelX, y, boldPaint)&#10;                canvas.drawText(changeStr, rightX - boldPaint.measureText(changeStr), y, boldPaint)&#10;                y += 16&#10;            }&#10;        }&#10;&#10;        // Footer&#10;        y += 20f&#10;        y += 4f  // padding before divider&#10;        paint.strokeWidth = 1f&#10;        paint.color = Color.LTGRAY&#10;        canvas.drawLine(xPadding, y, pageInfo.pageWidth - xPadding, y, paint)&#10;        y += 18f  // padding after divider&#10;&#10;        drawCenteredText(canvas, &quot;Terima kasih atas kunjungan Anda&quot;, centerX, y, normalPaint)&#10;        y += 16&#10;        &#10;        settings?.receiptFooter?.let {&#10;            if (it.isNotBlank()) {&#10;                it.split(&quot;\n&quot;).take(3).forEach { line -&gt;&#10;                    if (line.isNotBlank()) {&#10;                        drawCenteredText(canvas, line.trim(), centerX, y, smallPaint)&#10;                        y += 14&#10;                    }&#10;                }&#10;                y += 6&#10;            }&#10;        }&#10;        &#10;        drawCenteredText(canvas, &quot;-- Struk ini sah tanpa tanda tangan --&quot;, centerX, y, smallPaint)&#10;&#10;        doc.finishPage(page)&#10;&#10;        val fileName = &quot;Receipt-${transaction.transactionNumber}.pdf&quot;&#10;        val file = File(context.cacheDir, fileName)&#10;        FileOutputStream(file).use { out -&gt; doc.writeTo(out) }&#10;        doc.close()&#10;        return Result(file.toUri(), fileName)&#10;    }&#10;&#10;    fun generateThermalReceiptPdf(&#10;        context: Context,&#10;        settings: StoreSettings?,&#10;        transaction: TransactionEntity,&#10;        items: List&lt;TransactionItemEntity&gt;&#10;    ): Result {&#10;        val paperWidthMm = settings?.paperWidthMm ?: 58&#10;        val charsPerLine = settings?.paperCharPerLine ?: if (paperWidthMm &gt;= 80) 48 else 32&#10;        // Approximate pixel width for 58mm (~384px) and 80mm (~576px)&#10;        val pageWidthPx = if (paperWidthMm &gt;= 80) 576 else 384&#10;        val pageHeightPx = 1400 // Increased height for better layout&#10;        val doc = PdfDocument()&#10;        val pageInfo = PdfDocument.PageInfo.Builder(pageWidthPx, pageHeightPx, 1).create()&#10;        val page = doc.startPage(pageInfo)&#10;        val canvas = page.canvas&#10;&#10;        val nf = NumberFormat.getCurrencyInstance(Locale.Builder().setLanguage(&quot;id&quot;).setRegion(&quot;ID&quot;).build())&#10;        val dateFormat = SimpleDateFormat(&quot;dd/MM/yyyy HH:mm&quot;, Locale(&quot;id&quot;, &quot;ID&quot;))&#10;&#10;        val titlePaint = Paint(Paint.ANTI_ALIAS_FLAG).apply {&#10;            textSize = 18f&#10;            typeface = Typeface.create(Typeface.DEFAULT, Typeface.BOLD)&#10;            textAlign = Paint.Align.CENTER&#10;        }&#10;        val textPaint = Paint(Paint.ANTI_ALIAS_FLAG).apply { &#10;            textSize = 14f&#10;            typeface = Typeface.create(Typeface.DEFAULT, Typeface.NORMAL)&#10;        }&#10;        val boldPaint = Paint(Paint.ANTI_ALIAS_FLAG).apply {&#10;            textSize = 14f&#10;            typeface = Typeface.create(Typeface.DEFAULT, Typeface.BOLD)&#10;        }&#10;        val smallPaint = Paint(Paint.ANTI_ALIAS_FLAG).apply { &#10;            textSize = 11f &#10;            color = Color.DKGRAY&#10;        }&#10;        val dividerPaint = Paint(Paint.ANTI_ALIAS_FLAG).apply { &#10;            strokeWidth = 1f&#10;            color = Color.LTGRAY&#10;        }&#10;        val boldDividerPaint = Paint(Paint.ANTI_ALIAS_FLAG).apply { &#10;            strokeWidth = 2f&#10;            color = Color.BLACK&#10;        }&#10;&#10;        var y = 16f&#10;        val left = 12f&#10;        val right = pageWidthPx - 12f&#10;        val centerX = pageWidthPx / 2f&#10;&#10;        fun drawLine(bold: Boolean = false) {&#10;            y += 4f  // padding before line&#10;            canvas.drawLine(left, y, right, y, if (bold) boldDividerPaint else dividerPaint)&#10;            y += if (bold) 12f else 10f  // padding after line&#10;        }&#10;&#10;        fun drawTextLine(line: String, paint: Paint = textPaint) {&#10;            canvas.drawText(line.take(charsPerLine), left, y, paint)&#10;            y += 18f&#10;        }&#10;&#10;        // Logo (if enabled and available)&#10;        if (settings?.printLogo == true &amp;&amp; !settings.storeLogo.isNullOrBlank()) {&#10;            try {&#10;                val logoFile = File(settings.storeLogo)&#10;                if (logoFile.exists()) {&#10;                    val bmp = BitmapFactory.decodeFile(settings.storeLogo)&#10;                    if (bmp != null) {&#10;                        val maxW = if (paperWidthMm &gt;= 80) 120 else 80&#10;                        val ratio = bmp.width.toFloat() / bmp.height.toFloat()&#10;                        val w = maxW&#10;                        val h = (maxW / ratio).toInt().coerceAtLeast(1)&#10;                        val scaled = Bitmap.createScaledBitmap(bmp, w, h, true)&#10;                        val cx = (pageWidthPx - scaled.width) / 2f&#10;                        canvas.drawBitmap(scaled, cx, y, null)&#10;                        y += scaled.height + 8&#10;                        bmp.recycle()&#10;                        scaled.recycle()&#10;                    }&#10;                }&#10;            } catch (_: Exception) { }&#10;        }&#10;&#10;        // Header - Store Name&#10;        val name = (settings?.storeName ?: &quot;Toko&quot;).uppercase()&#10;        canvas.drawText(name, centerX, y, titlePaint)&#10;        y += 22f&#10;        &#10;        // Address and phone&#10;        val addr = settings?.storeAddress ?: &quot;Alamat&quot;&#10;        if (addr.isNotBlank()) {&#10;            drawCenteredText(canvas, addr.take(charsPerLine), centerX, y, smallPaint)&#10;            y += 16f&#10;        }&#10;        val phone = settings?.storePhone ?: &quot;&quot;&#10;        if (phone.isNotBlank()) {&#10;            drawCenteredText(canvas, &quot;Telp: $phone&quot;, centerX, y, smallPaint)&#10;            y += 16f&#10;        }&#10;        &#10;        // Custom header&#10;        settings?.receiptHeader?.let {&#10;            if (it.isNotBlank()) {&#10;                it.split(&quot;\n&quot;).take(3).forEach { line -&gt;&#10;                    if (line.isNotBlank()) {&#10;                        drawCenteredText(canvas, line.trim().take(charsPerLine), centerX, y, smallPaint)&#10;                        y += 16f&#10;                    }&#10;                }&#10;            }&#10;        }&#10;        &#10;        drawLine(bold = true)&#10;        &#10;        // Transaction info&#10;        val dateStr = dateFormat.format(Date(transaction.updatedAt))&#10;        canvas.drawText(&quot;No: ${transaction.transactionNumber}&quot;, left, y, textPaint)&#10;        y += 16f&#10;        canvas.drawText(&quot;Tanggal: $dateStr&quot;, left, y, textPaint)&#10;        y += 16f&#10;        canvas.drawText(&quot;Kasir: ${transaction.cashierName}&quot;, left, y, textPaint)&#10;        y += 4f&#10;        drawLine()&#10;&#10;        // Items header&#10;        canvas.drawText(&quot;ITEM&quot;, left, y, boldPaint)&#10;        // Move JUMLAH column more to the left to accommodate larger amounts&#10;        val amountColumnX = right - 85f  // Adjusted from far right to support millions&#10;        canvas.drawText(&quot;JUMLAH&quot;, amountColumnX, y, boldPaint)&#10;        y += 4f&#10;        drawLine()&#10;&#10;        // Items&#10;        items.forEach { item -&gt;&#10;            // Product name&#10;            val name = item.productName.take(charsPerLine - 12)  // Leave space for amount&#10;            canvas.drawText(name, left, y, textPaint)&#10;            y += 16f&#10;            &#10;            // If item has discount, show original price with strikethrough&#10;            if (item.discount &gt; 0) {&#10;                val originalPrice = item.productPrice&#10;                val discountPerUnit = item.discount / item.quantity&#10;                val discountedPricePerUnit = originalPrice - discountPerUnit&#10;                &#10;                val origPriceStr = &quot;@${nf.format(originalPrice).replace(&quot;Rp&quot;, &quot;Rp &quot;)}/pcs&quot;&#10;                canvas.drawText(origPriceStr, left + 8f, y, smallPaint)&#10;                &#10;                // Draw strikethrough line&#10;                val textWidth = smallPaint.measureText(origPriceStr)&#10;                val lineY = y - 4f&#10;                canvas.drawLine(left + 8f, lineY, left + 8f + textWidth, lineY, smallPaint)&#10;                y += 14f&#10;            &#10;                // Quantity x discounted price per unit = subtotal&#10;                val qtyPart = &quot;${item.quantity} x ${nf.format(discountedPricePerUnit).replace(&quot;Rp&quot;, &quot;Rp &quot;)}&quot;&#10;                val subPart = nf.format(item.subtotal).replace(&quot;Rp&quot;, &quot;Rp &quot;)&#10;                canvas.drawText(qtyPart, left + 8f, y, smallPaint)&#10;                // Right align subtotal at the amount column&#10;                canvas.drawText(subPart, right - smallPaint.measureText(subPart), y, textPaint)&#10;                y += 18f&#10;                &#10;                // Total discount amount&#10;                val discountPart = &quot;Diskon: -${nf.format(item.discount).replace(&quot;Rp&quot;, &quot;Rp &quot;)}&quot;&#10;                canvas.drawText(discountPart, left + 8f, y, smallPaint)&#10;                y += 16f&#10;            } else {&#10;                // No discount - simple format&#10;                val qtyPart = &quot;${item.quantity} x ${nf.format(item.unitPrice).replace(&quot;Rp&quot;, &quot;Rp &quot;)}&quot;&#10;                val subPart = nf.format(item.subtotal).replace(&quot;Rp&quot;, &quot;Rp &quot;)&#10;                canvas.drawText(qtyPart, left + 8f, y, smallPaint)&#10;                canvas.drawText(subPart, right - smallPaint.measureText(subPart), y, textPaint)&#10;                y += 18f&#10;            }&#10;        }&#10;        y += 4f&#10;        drawLine(bold = true)&#10;&#10;        // Totals&#10;        fun drawTotal(label: String, value: Double, paint: Paint = textPaint, negative: Boolean = false) {&#10;            val valueStr = nf.format(value).replace(&quot;Rp&quot;, &quot;Rp &quot;)&#10;            canvas.drawText(label, left, y, paint)&#10;            val display = if (negative) &quot;-$valueStr&quot; else valueStr&#10;            canvas.drawText(display, right - paint.measureText(display), y, paint)&#10;            y += 18f&#10;        }&#10;        &#10;        drawTotal(&quot;Subtotal&quot;, transaction.subtotal, textPaint)&#10;        if (transaction.tax &gt; 0) drawTotal(&quot;PPN&quot;, transaction.tax, textPaint)&#10;        if (transaction.discount &gt; 0) drawTotal(&quot;Diskon&quot;, transaction.discount, textPaint, negative = true)&#10;        &#10;        y += 4f&#10;        drawLine(bold = true)&#10;        &#10;        // Grand Total - larger and bold&#10;        val grandTotalPaint = Paint(Paint.ANTI_ALIAS_FLAG).apply {&#10;            textSize = 16f&#10;            typeface = Typeface.create(Typeface.DEFAULT, Typeface.BOLD)&#10;        }&#10;        val totalStr = nf.format(transaction.total).replace(&quot;Rp&quot;, &quot;Rp &quot;)&#10;        canvas.drawText(&quot;TOTAL&quot;, left, y, grandTotalPaint)&#10;        canvas.drawText(totalStr, right - grandTotalPaint.measureText(totalStr), y, grandTotalPaint)&#10;        y += 22f&#10;        &#10;        drawLine()&#10;&#10;        // Payment info&#10;        val paymentMethodName = when (transaction.paymentMethod.name) {&#10;            &quot;CASH&quot; -&gt; &quot;Tunai&quot;&#10;            &quot;DEBIT&quot; -&gt; &quot;Debit&quot;&#10;            &quot;CREDIT&quot; -&gt; &quot;Kredit&quot;&#10;            &quot;QRIS&quot; -&gt; &quot;QRIS&quot;&#10;            &quot;TRANSFER&quot; -&gt; &quot;Transfer&quot;&#10;            else -&gt; transaction.paymentMethod.name&#10;        }&#10;        canvas.drawText(&quot;Metode: $paymentMethodName&quot;, left, y, textPaint)&#10;        y += 18f&#10;        &#10;        val received = transaction.cashReceived&#10;        if (received &gt; 0) {&#10;            val change = (received - transaction.total).coerceAtLeast(0.0)&#10;            drawTotal(&quot;Dibayar&quot;, received, textPaint)&#10;            if (change &gt; 0) {&#10;                drawTotal(&quot;Kembali&quot;, change, boldPaint)&#10;            }&#10;        }&#10;        &#10;        y += 8f&#10;        drawLine(bold = true)&#10;&#10;        // Footer&#10;        y += 8f&#10;        drawCenteredText(canvas, &quot;Terima kasih atas kunjungan Anda&quot;, centerX, y, textPaint)&#10;        y += 18f&#10;        &#10;        settings?.receiptFooter?.let {&#10;            if (it.isNotBlank()) {&#10;                it.split(&quot;\n&quot;).take(3).forEach { line -&gt;&#10;                    if (line.isNotBlank()) {&#10;                        drawCenteredText(canvas, line.trim().take(charsPerLine), centerX, y, smallPaint)&#10;                        y += 16f&#10;                    }&#10;                }&#10;            }&#10;        }&#10;        &#10;        y += 8f&#10;        drawCenteredText(canvas, &quot;-- Struk ini sah tanpa tanda tangan --&quot;, centerX, y, smallPaint)&#10;&#10;        doc.finishPage(page)&#10;        val fileName = &quot;Receipt-${transaction.transactionNumber}-${paperWidthMm}mm.pdf&quot;&#10;        val file = File(context.cacheDir, fileName)&#10;        FileOutputStream(file).use { out -&gt; doc.writeTo(out) }&#10;        doc.close()&#10;        return Result(file.toUri(), fileName)&#10;    }&#10;&#10;    /**&#10;     * Generate queue number ticket (thermal)&#10;     */&#10;    fun generateQueueTicketPdf(&#10;        context: Context,&#10;        settings: StoreSettings?,&#10;        transaction: TransactionEntity&#10;    ): Result {&#10;        val dateFormat = SimpleDateFormat(&quot;yyyyMMdd_HHmmss&quot;, Locale.getDefault())&#10;        val fileName = &quot;Antrian_${transaction.transactionNumber}_${dateFormat.format(Date())}.pdf&quot;&#10;        val file = File(context.cacheDir, fileName)&#10;&#10;        val pageWidth = if (settings?.paperWidthMm?.let { it &gt;= 80 } == true) 576f else 384f&#10;        val pageHeight = 400f // Short ticket&#10;        val document = PdfDocument()&#10;        val pageInfo = PdfDocument.PageInfo.Builder(pageWidth.toInt(), pageHeight.toInt(), 1).create()&#10;        val page = document.startPage(pageInfo)&#10;        val canvas = page.canvas&#10;&#10;        val paint = Paint().apply {&#10;            color = Color.DKGRAY&#10;            textSize = 28f&#10;            typeface = Typeface.create(Typeface.DEFAULT, Typeface.NORMAL)&#10;        }&#10;        val boldPaint = Paint(paint).apply {&#10;            typeface = Typeface.create(Typeface.DEFAULT, Typeface.BOLD)&#10;            textSize = 32f&#10;        }&#10;        val titlePaint = Paint(paint).apply {&#10;            typeface = Typeface.create(Typeface.DEFAULT, Typeface.BOLD)&#10;            textSize = 48f&#10;            textAlign = Paint.Align.CENTER&#10;        }&#10;&#10;        var y = 40f&#10;        val left = 20f&#10;        val center = pageWidth / 2&#10;&#10;        // Header&#10;        canvas.drawText(&quot;NOMOR ANTRIAN&quot;, center, y, titlePaint)&#10;        y += 60f&#10;&#10;        // Queue Number (from transaction number - extract last 4 digits)&#10;        val queueNumber = transaction.transactionNumber.substringAfterLast('-')&#10;        titlePaint.textSize = 72f&#10;        canvas.drawText(queueNumber, center, y, titlePaint)&#10;        y += 80f&#10;&#10;        titlePaint.textSize = 28f&#10;        titlePaint.textAlign = Paint.Align.LEFT&#10;&#10;        // Transaction summary&#10;        val dateFormatter = SimpleDateFormat(&quot;dd MMM yyyy, HH:mm&quot;, Locale(&quot;id&quot;, &quot;ID&quot;))&#10;        canvas.drawText(&quot;Transaksi: ${transaction.transactionNumber}&quot;, left, y, paint)&#10;        y += 30f&#10;        canvas.drawText(&quot;Waktu: ${dateFormatter.format(Date(transaction.transactionDate))}&quot;, left, y, paint)&#10;        y += 30f&#10;&#10;        val nf = NumberFormat.getCurrencyInstance(Locale(&quot;id&quot;, &quot;ID&quot;))&#10;        canvas.drawText(&quot;Total: ${nf.format(transaction.total).replace(&quot;Rp&quot;, &quot;Rp &quot;)}&quot;, left, y, boldPaint)&#10;        y += 40f&#10;&#10;        // Footer&#10;        paint.textAlign = Paint.Align.CENTER&#10;        canvas.drawText(&quot;Terima kasih&quot;, center, y, paint)&#10;&#10;        document.finishPage(page)&#10;&#10;        try {&#10;            document.writeTo(FileOutputStream(file))&#10;            val uri = androidx.core.content.FileProvider.getUriForFile(&#10;                context,&#10;                &quot;${context.packageName}.fileprovider&quot;,&#10;                file&#10;            )&#10;            return Result(uri, fileName)&#10;        } finally {&#10;            document.close()&#10;        }&#10;    }&#10;&#10;    fun printOrSave(&#10;        context: Context,&#10;        settings: StoreSettings?,&#10;        pdfUri: Uri,&#10;        jobName: String&#10;    ) {&#10;        if (settings?.printerConnected == true) {&#10;            val printManager = context.getSystemService(Context.PRINT_SERVICE) as PrintManager&#10;            val adapter = PdfFilePrintAdapter(context, pdfUri, jobName)&#10;            val attr = PrintAttributes.Builder()&#10;                .setMediaSize(PrintAttributes.MediaSize.NA_LETTER.asPortrait())&#10;                .setColorMode(PrintAttributes.COLOR_MODE_MONOCHROME)&#10;                .build()&#10;            printManager.print(jobName, adapter, attr)&#10;        } else {&#10;            saveToDownloads(context, pdfUri, jobName)&#10;        }&#10;    }&#10;&#10;    private fun saveToDownloads(context: Context, pdfUri: Uri, fileName: String) {&#10;        try {&#10;            if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.Q) {&#10;                val values = ContentValues().apply {&#10;                    put(MediaStore.Downloads.DISPLAY_NAME, fileName)&#10;                    put(MediaStore.Downloads.MIME_TYPE, &quot;application/pdf&quot;)&#10;                    put(MediaStore.Downloads.IS_PENDING, 1)&#10;                }&#10;                val resolver = context.contentResolver&#10;                val collection = MediaStore.Downloads.EXTERNAL_CONTENT_URI&#10;                val itemUri = resolver.insert(collection, values) ?: return&#10;                resolver.openOutputStream(itemUri)?.use { out -&gt;&#10;                    resolver.openInputStream(pdfUri)?.use { input -&gt;&#10;                        input.copyTo(out)&#10;                    }&#10;                }&#10;                values.clear()&#10;                values.put(MediaStore.Downloads.IS_PENDING, 0)&#10;                resolver.update(itemUri, values, null, null)&#10;            } else {&#10;                val dir = Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOWNLOADS)&#10;                if (!dir.exists()) dir.mkdirs()&#10;                val outFile = File(dir, fileName)&#10;                context.contentResolver.openInputStream(pdfUri)?.use { input -&gt;&#10;                    FileOutputStream(outFile).use { out -&gt; input.copyTo(out) }&#10;                }&#10;            }&#10;        } catch (_: Exception) { }&#10;    }&#10;&#10;    fun sharePdf(context: Context, pdfUri: Uri) {&#10;        val intent = android.content.Intent(android.content.Intent.ACTION_SEND).apply {&#10;            type = &quot;application/pdf&quot;&#10;            putExtra(android.content.Intent.EXTRA_STREAM, pdfUri)&#10;            addFlags(android.content.Intent.FLAG_GRANT_READ_URI_PERMISSION)&#10;        }&#10;        context.startActivity(&#10;            android.content.Intent.createChooser(intent, &quot;Bagikan Struk&quot;)&#10;                .addFlags(android.content.Intent.FLAG_ACTIVITY_NEW_TASK)&#10;        )&#10;    }&#10;&#10;    private fun drawCenteredText(canvas: Canvas, text: String, cx: Float, y: Float, paint: Paint) {&#10;        val w = paint.measureText(text)&#10;        canvas.drawText(text, cx - w / 2f, y, paint)&#10;    }&#10;&#10;    fun printQueueOrPdf(&#10;        context: Context,&#10;        settings: StoreSettings?,&#10;        transaction: TransactionEntity&#10;    ): ESCPosPrinter.PrintResult? {&#10;        return if (settings?.useEscPosDirect == true &amp;&amp; !settings.printerAddress.isNullOrBlank()) {&#10;            // Return PrintResult for ESC/POS direct print&#10;            ESCPosPrinter.printQueueTicket(context, settings, transaction)&#10;        } else {&#10;            // For PDF, just generate and print/save, return null (no need for PrintResult)&#10;            val result = generateQueueTicketPdf(context, settings, transaction)&#10;            printOrSave(context, settings, result.pdfUri, result.fileName)&#10;            null&#10;        }&#10;    }&#10;}&#10;&#10;private class PdfFilePrintAdapter(&#10;    private val context: Context,&#10;    private val pdfUri: Uri,&#10;    private val jobName: String&#10;) : PrintDocumentAdapter() {&#10;&#10;    override fun onLayout(&#10;        oldAttributes: PrintAttributes?,&#10;        newAttributes: PrintAttributes,&#10;        cancellationSignal: android.os.CancellationSignal?,&#10;        callback: LayoutResultCallback,&#10;        extras: android.os.Bundle?&#10;    ) {&#10;        val info = PrintDocumentInfo.Builder(jobName)&#10;            .setContentType(PrintDocumentInfo.CONTENT_TYPE_DOCUMENT)&#10;            .setPageCount(PrintDocumentInfo.PAGE_COUNT_UNKNOWN)&#10;            .build()&#10;        callback.onLayoutFinished(info, true)&#10;    }&#10;&#10;    override fun onWrite(&#10;        pages: Array&lt;PageRange&gt;,&#10;        destination: ParcelFileDescriptor,&#10;        cancellationSignal: android.os.CancellationSignal,&#10;        callback: WriteResultCallback&#10;    ) {&#10;        try {&#10;            context.contentResolver.openInputStream(pdfUri)?.use { input -&gt;&#10;                FileOutputStream(destination.fileDescriptor).use { output -&gt;&#10;                    input.copyTo(output)&#10;                }&#10;            }&#10;            callback.onWriteFinished(arrayOf(PageRange.ALL_PAGES))&#10;        } catch (e: Exception) {&#10;            callback.onWriteFailed(e.message)&#10;        }&#10;    }&#10;}&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/app/src/main/java/id/stargan/intikasir/feature/pos/ui/components/PosProductItemReactive.kt">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/id/stargan/intikasir/feature/pos/ui/components/PosProductItemReactive.kt" />
              <option name="originalContent" value="package id.stargan.intikasir.feature.pos.ui.components&#10;&#10;import androidx.compose.foundation.layout.*&#10;import androidx.compose.foundation.text.KeyboardOptions&#10;import androidx.compose.material.icons.Icons&#10;import androidx.compose.material.icons.filled.MoreVert&#10;import androidx.compose.material3.*&#10;import androidx.compose.runtime.*&#10;import androidx.compose.ui.Alignment&#10;import androidx.compose.ui.Modifier&#10;import androidx.compose.ui.text.input.KeyboardType&#10;import androidx.compose.ui.text.style.TextOverflow&#10;import androidx.compose.ui.unit.dp&#10;import id.stargan.intikasir.domain.model.Product&#10;import id.stargan.intikasir.data.local.entity.TransactionItemEntity&#10;import id.stargan.intikasir.ui.common.Stepper&#10;import id.stargan.intikasir.ui.common.LeftButtonMode&#10;import java.text.NumberFormat&#10;import java.util.Locale&#10;&#10;@Composable&#10;fun PosProductItemReactive(&#10;    modifier: Modifier = Modifier,&#10;    product: Product,&#10;    transactionItem: TransactionItemEntity?,&#10;    onAdd: () -&gt; Unit,&#10;    onChangeQty: (Int) -&gt; Unit,&#10;    onSetDiscount: ((Double) -&gt; Unit)? = null,&#10;) {&#10;    val nf = NumberFormat.getCurrencyInstance(Locale.Builder().setLanguage(&quot;id&quot;).setRegion(&quot;ID&quot;).build())&#10;    var showDiscountDialog by remember { mutableStateOf(false) }&#10;&#10;    Surface(&#10;        modifier = modifier.fillMaxWidth(),&#10;        tonalElevation = 1.dp,&#10;        shape = MaterialTheme.shapes.medium&#10;    ) {&#10;        Row(&#10;            modifier = Modifier&#10;                .fillMaxWidth()&#10;                .padding(12.dp)&#10;                .defaultMinSize(minHeight = 80.dp)&#10;            ,&#10;            verticalAlignment = Alignment.Top&#10;        ) {&#10;            Column(Modifier.weight(1f), verticalArrangement = Arrangement.spacedBy(4.dp)) {&#10;                Text(&#10;                    product.name,&#10;                    style = MaterialTheme.typography.bodyLarge,&#10;                    maxLines = 1,&#10;                    overflow = TextOverflow.Ellipsis&#10;                )&#10;                Text(&#10;                    nf.format(product.price).replace(&quot;Rp&quot;, &quot;Rp &quot;),&#10;                    style = MaterialTheme.typography.labelMedium&#10;                )&#10;&#10;                // Show discount if applied&#10;                if (transactionItem != null &amp;&amp; transactionItem.discount &gt; 0) {&#10;                    Text(&#10;                        &quot;Diskon: ${nf.format(transactionItem.discount).replace(&quot;Rp&quot;, &quot;Rp &quot;)}&quot;,&#10;                        color = MaterialTheme.colorScheme.primary,&#10;                        style = MaterialTheme.typography.labelSmall&#10;                    )&#10;                }&#10;&#10;                // Show subtotal if qty &gt; 1&#10;                if (transactionItem != null &amp;&amp; transactionItem.quantity &gt; 1) {&#10;                    Text(&#10;//                        &quot;Subtotal: ${transactionItem.quantity} x ${nf.format(product.price).replace(&quot;Rp&quot;, &quot;Rp &quot;)} = ${nf.format(transactionItem.subtotal).replace(&quot;Rp&quot;, &quot;Rp &quot;)}&quot;,&#10;                        &quot; x ${transactionItem.quantity} = ${nf.format(transactionItem.subtotal).replace(&quot;Rp&quot;, &quot;Rp &quot;)}&quot;,&#10;                        style = MaterialTheme.typography.labelSmall,&#10;                        color = MaterialTheme.colorScheme.onSurfaceVariant&#10;                    )&#10;                }&#10;&#10;                // Low stock warning&#10;                if (product.stock &lt;= (product.lowStockThreshold ?: 10)) {&#10;                    Text(&#10;                        &quot;Stok menipis&quot;,&#10;                        color = MaterialTheme.colorScheme.error,&#10;                        style = MaterialTheme.typography.labelSmall&#10;                    )&#10;                }&#10;            }&#10;&#10;            if (transactionItem == null) {&#10;                Button(onClick = onAdd, enabled = product.stock &gt; 0) {&#10;                    Text(&quot;Tambah&quot;)&#10;                }&#10;            } else {&#10;                Row(&#10;                    horizontalArrangement = Arrangement.spacedBy(4.dp),&#10;                    verticalAlignment = Alignment.CenterVertically&#10;                ) {&#10;                    if (onSetDiscount != null) {&#10;                        IconButton(onClick = { showDiscountDialog = true }) {&#10;                            Icon(Icons.Default.MoreVert, contentDescription = &quot;Diskon&quot;)&#10;                        }&#10;                    }&#10;                    Stepper(&#10;                        value = transactionItem.quantity,&#10;                        onValueChange = onChangeQty,&#10;                        min = 0,&#10;                        max = product.stock,&#10;                        leftButtonMode = LeftButtonMode.Delete,&#10;                        onDelete = { onChangeQty(0) },&#10;                        step = 1&#10;                    )&#10;                }&#10;            }&#10;        }&#10;    }&#10;&#10;    // Discount dialog&#10;    if (showDiscountDialog &amp;&amp; transactionItem != null &amp;&amp; onSetDiscount != null) {&#10;        var discountText by remember { mutableStateOf(transactionItem.discount.toInt().toString()) }&#10;        AlertDialog(&#10;            onDismissRequest = { showDiscountDialog = false },&#10;            title = { Text(&quot;Diskon Item&quot;) },&#10;            text = {&#10;                OutlinedTextField(&#10;                    value = discountText,&#10;                    onValueChange = { discountText = it.filter { c -&gt; c.isDigit() } },&#10;                    label = { Text(&quot;Jumlah Diskon&quot;) },&#10;                    prefix = { Text(&quot;Rp &quot;) },&#10;                    singleLine = true,&#10;                    keyboardOptions = KeyboardOptions(keyboardType = KeyboardType.Number)&#10;                )&#10;            },&#10;            confirmButton = {&#10;                TextButton(onClick = {&#10;                    val discount = discountText.toDoubleOrNull() ?: 0.0&#10;                    onSetDiscount(discount)&#10;                    showDiscountDialog = false&#10;                }) { Text(&quot;Simpan&quot;) }&#10;            },&#10;            dismissButton = {&#10;                TextButton(onClick = { showDiscountDialog = false }) { Text(&quot;Batal&quot;) }&#10;            }&#10;        )&#10;    }&#10;}&#10;&#10;" />
              <option name="updatedContent" value="package id.stargan.intikasir.feature.pos.ui.components&#10;&#10;import androidx.compose.foundation.layout.*&#10;import androidx.compose.foundation.text.KeyboardOptions&#10;import androidx.compose.material.icons.Icons&#10;import androidx.compose.material.icons.filled.MoreVert&#10;import androidx.compose.material3.*&#10;import androidx.compose.runtime.*&#10;import androidx.compose.ui.Alignment&#10;import androidx.compose.ui.Modifier&#10;import androidx.compose.ui.text.input.KeyboardType&#10;import androidx.compose.ui.text.style.TextOverflow&#10;import androidx.compose.ui.unit.dp&#10;import id.stargan.intikasir.domain.model.Product&#10;import id.stargan.intikasir.data.local.entity.TransactionItemEntity&#10;import id.stargan.intikasir.ui.common.Stepper&#10;import id.stargan.intikasir.ui.common.LeftButtonMode&#10;import java.text.NumberFormat&#10;import java.util.Locale&#10;&#10;@Composable&#10;fun PosProductItemReactive(&#10;    modifier: Modifier = Modifier,&#10;    product: Product,&#10;    transactionItem: TransactionItemEntity?,&#10;    onAdd: () -&gt; Unit,&#10;    onChangeQty: (Int) -&gt; Unit,&#10;    onSetDiscount: ((Double) -&gt; Unit)? = null,&#10;) {&#10;    val nf = NumberFormat.getCurrencyInstance(Locale.Builder().setLanguage(&quot;id&quot;).setRegion(&quot;ID&quot;).build())&#10;    var showDiscountDialog by remember { mutableStateOf(false) }&#10;&#10;    Surface(&#10;        modifier = modifier.fillMaxWidth(),&#10;        tonalElevation = 1.dp,&#10;        shape = MaterialTheme.shapes.medium&#10;    ) {&#10;        Row(&#10;            modifier = Modifier&#10;                .fillMaxWidth()&#10;                .padding(12.dp)&#10;                .defaultMinSize(minHeight = 80.dp)&#10;            ,&#10;            verticalAlignment = Alignment.Top&#10;        ) {&#10;            Column(Modifier.weight(1f), verticalArrangement = Arrangement.spacedBy(4.dp)) {&#10;                Text(&#10;                    product.name,&#10;                    style = MaterialTheme.typography.bodyLarge,&#10;                    maxLines = 1,&#10;                    overflow = TextOverflow.Ellipsis&#10;                )&#10;                &#10;                // Show original price (always)&#10;                if (transactionItem != null &amp;&amp; transactionItem.discount &gt; 0) {&#10;                    // Show original price with strikethrough indicator&#10;                    Text(&#10;                        &quot;@${nf.format(product.price).replace(&quot;Rp&quot;, &quot;Rp &quot;)}/pcs&quot;,&#10;                        style = MaterialTheme.typography.labelMedium,&#10;                        color = MaterialTheme.colorScheme.onSurfaceVariant&#10;                    )&#10;                    &#10;                    // Calculate and show discounted price per unit&#10;                    val discountPerUnit = transactionItem.discount / transactionItem.quantity&#10;                    val discountedPricePerUnit = product.price - discountPerUnit&#10;                    Text(&#10;                        nf.format(discountedPricePerUnit).replace(&quot;Rp&quot;, &quot;Rp &quot;) + &quot;/pcs&quot;,&#10;                        style = MaterialTheme.typography.labelMedium,&#10;                        color = MaterialTheme.colorScheme.primary&#10;                    )&#10;                } else {&#10;                    Text(&#10;                        nf.format(product.price).replace(&quot;Rp&quot;, &quot;Rp &quot;) + &quot;/pcs&quot;,&#10;                        style = MaterialTheme.typography.labelMedium&#10;                    )&#10;                }&#10;&#10;                // Show total discount if applied&#10;                if (transactionItem != null &amp;&amp; transactionItem.discount &gt; 0) {&#10;                    val discountPerUnit = transactionItem.discount / transactionItem.quantity&#10;                    Text(&#10;                        &quot;Diskon: ${nf.format(discountPerUnit).replace(&quot;Rp&quot;, &quot;Rp &quot;)}/pcs (Total: ${nf.format(transactionItem.discount).replace(&quot;Rp&quot;, &quot;Rp &quot;)})&quot;,&#10;                        color = MaterialTheme.colorScheme.primary,&#10;                        style = MaterialTheme.typography.labelSmall&#10;                    )&#10;                }&#10;&#10;                // Show subtotal with quantity&#10;                if (transactionItem != null &amp;&amp; transactionItem.quantity &gt; 0) {&#10;                    val discountPerUnit = if (transactionItem.discount &gt; 0) {&#10;                        transactionItem.discount / transactionItem.quantity&#10;                    } else 0.0&#10;                    val priceAfterDiscount = product.price - discountPerUnit&#10;                    &#10;                    Text(&#10;                        &quot;${transactionItem.quantity} x ${nf.format(priceAfterDiscount).replace(&quot;Rp&quot;, &quot;Rp &quot;)} = ${nf.format(transactionItem.subtotal).replace(&quot;Rp&quot;, &quot;Rp &quot;)}&quot;,&#10;                        style = MaterialTheme.typography.labelSmall,&#10;                        color = MaterialTheme.colorScheme.onSurfaceVariant&#10;                    )&#10;                }&#10;&#10;                // Low stock warning&#10;                if (product.stock &lt;= (product.lowStockThreshold ?: 10)) {&#10;                    Text(&#10;                        &quot;Stok menipis&quot;,&#10;                        color = MaterialTheme.colorScheme.error,&#10;                        style = MaterialTheme.typography.labelSmall&#10;                    )&#10;                }&#10;            }&#10;&#10;            if (transactionItem == null) {&#10;                Button(onClick = onAdd, enabled = product.stock &gt; 0) {&#10;                    Text(&quot;Tambah&quot;)&#10;                }&#10;            } else {&#10;                Row(&#10;                    horizontalArrangement = Arrangement.spacedBy(4.dp),&#10;                    verticalAlignment = Alignment.CenterVertically&#10;                ) {&#10;                    if (onSetDiscount != null) {&#10;                        IconButton(onClick = { showDiscountDialog = true }) {&#10;                            Icon(Icons.Default.MoreVert, contentDescription = &quot;Diskon&quot;)&#10;                        }&#10;                    }&#10;                    Stepper(&#10;                        value = transactionItem.quantity,&#10;                        onValueChange = onChangeQty,&#10;                        min = 0,&#10;                        max = product.stock,&#10;                        leftButtonMode = LeftButtonMode.Delete,&#10;                        onDelete = { onChangeQty(0) },&#10;                        step = 1&#10;                    )&#10;                }&#10;            }&#10;        }&#10;    }&#10;&#10;    // Discount dialog&#10;    if (showDiscountDialog &amp;&amp; transactionItem != null &amp;&amp; onSetDiscount != null) {&#10;        var discountText by remember { mutableStateOf(transactionItem.discount.toInt().toString()) }&#10;        AlertDialog(&#10;            onDismissRequest = { showDiscountDialog = false },&#10;            title = { Text(&quot;Diskon Item&quot;) },&#10;            text = {&#10;                OutlinedTextField(&#10;                    value = discountText,&#10;                    onValueChange = { discountText = it.filter { c -&gt; c.isDigit() } },&#10;                    label = { Text(&quot;Jumlah Diskon&quot;) },&#10;                    prefix = { Text(&quot;Rp &quot;) },&#10;                    singleLine = true,&#10;                    keyboardOptions = KeyboardOptions(keyboardType = KeyboardType.Number)&#10;                )&#10;            },&#10;            confirmButton = {&#10;                TextButton(onClick = {&#10;                    val discount = discountText.toDoubleOrNull() ?: 0.0&#10;                    onSetDiscount(discount)&#10;                    showDiscountDialog = false&#10;                }) { Text(&quot;Simpan&quot;) }&#10;            },&#10;            dismissButton = {&#10;                TextButton(onClick = { showDiscountDialog = false }) { Text(&quot;Batal&quot;) }&#10;            }&#10;        )&#10;    }&#10;}&#10;&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/docs/DISCOUNT_LOGIC_FINAL.md">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/docs/DISCOUNT_LOGIC_FINAL.md" />
              <option name="updatedContent" value="# Discount Logic &amp; Receipt Display - Final Documentation&#10;&#10;## Tanggal: 18 November 2025&#10;&#10;---&#10;&#10;##  Logika Diskon yang Diterapkan&#10;&#10;### ✅ **OPSI B: Diskon Per Unit (Total = Diskon × Quantity)**&#10;&#10;**Contoh:**&#10;```&#10;Sabun @ Rp 1.000/pcs&#10;Diskon: Rp 200/pcs&#10;&#10;Beli 1 pcs:&#10;- Harga: 1 × Rp 1.000 = Rp 1.000&#10;- Diskon: 1 × Rp 200 = Rp 200&#10;- Subtotal: Rp 800&#10;&#10;Beli 2 pcs:&#10;- Harga: 2 × Rp 1.000 = Rp 2.000&#10;- Diskon: 2 × Rp 200 = Rp 400&#10;- Subtotal: Rp 1.600&#10;&#10;Beli 5 pcs:&#10;- Harga: 5 × Rp 1.000 = Rp 5.000&#10;- Diskon: 5 × Rp 200 = Rp 1.000&#10;- Subtotal: Rp 4.000&#10;```&#10;&#10;---&#10;&#10;##  Kenapa Opsi B (Best Practice)?&#10;&#10;### 1. **Standar Industri Retail**&#10;- Shopify, Square, WooCommerce, dll → semua pakai sistem ini&#10;- Konsisten dengan ekspektasi customer&#10;- Professional standard&#10;&#10;### 2. **Konsistensi Harga**&#10;- 1 pcs @ Rp 800 (setelah diskon)&#10;- 2 pcs @ Rp 1.600 (2 × Rp 800)&#10;- 10 pcs @ Rp 8.000 (10 × Rp 800)&#10;- **Harga per unit selalu sama!**&#10;&#10;### 3. **Mudah Dipahami Customer**&#10;```&#10;&quot;Sabun diskon jadi Rp 800/pcs&quot;&#10;&quot;Beli 3 = 3 × Rp 800 = Rp 2.400&quot;&#10;```&#10;✅ Simple &amp; clear&#10;&#10;### 4. **Marketing Friendly**&#10;```&#10;&quot;HEMAT Rp 200 per pcs!&quot;&#10;&quot;Beli 10, hemat Rp 2.000!&quot;&#10;```&#10;✅ Menarik &amp; jelas&#10;&#10;---&#10;&#10;##  Data Structure&#10;&#10;```kotlin&#10;data class TransactionItemEntity(&#10;    val productName: String,       // &quot;Sabun&quot;&#10;    val productPrice: Double,      // 1000 (harga asli per pcs)&#10;    val quantity: Int,             // 2&#10;    val unitPrice: Double,         // 1000 (sama dengan productPrice)&#10;    val discount: Double,          // 400 (TOTAL diskon = 200 × 2)&#10;    val subtotal: Double           // 1600 = (1000 × 2) - 400&#10;)&#10;```&#10;&#10;### Calculation Formula:&#10;```kotlin&#10;subtotal = (productPrice × quantity) - discount&#10;&#10;// Untuk mendapat harga per pcs setelah diskon:&#10;discountPerUnit = discount / quantity&#10;discountedPricePerUnit = productPrice - discountPerUnit&#10;```&#10;&#10;---&#10;&#10;## ️ Tampilan di Struk (Updated)&#10;&#10;### ESC/POS Thermal Printer:&#10;```&#10;================================&#10;         TOKO SAYA&#10;    Jl. Contoh No. 123&#10;--------------------------------&#10;Sabun Mandi&#10;  @Rp 1.000/pcs (harga asli)&#10;2 x Rp 800         Rp 1.600&#10;  Diskon: -Rp 400&#10;&#10;Shampoo&#10;  @Rp 5.000/pcs&#10;1 x Rp 4.000       Rp 4.000&#10;  Diskon: -Rp 1.000&#10;&#10;Pasta Gigi (no discount)&#10;3 x Rp 2.000       Rp 6.000&#10;--------------------------------&#10;Subtotal           Rp 11.600&#10;Diskon item        -Rp 1.400&#10;PPN (11%)           Rp 1.122&#10;--------------------------------&#10;TOTAL              Rp 11.322&#10;================================&#10;```&#10;&#10;### Penjelasan Format:&#10;1. **Line 1:** Nama produk&#10;2. **Line 2:** `@Rp X/pcs` = Harga asli per pcs (dengan @ untuk indicate strikethrough)&#10;3. **Line 3:** `Qty x Harga setelah diskon per pcs = Subtotal`&#10;4. **Line 4:** `Diskon: -Rp X` (total diskon untuk semua quantity)&#10;&#10;### Example Breakdown:&#10;```&#10;Sabun Mandi&#10;  @Rp 1.000/pcs         ← Harga asli&#10;2 x Rp 800 = Rp 1.600   ← 2 pcs × Rp 800/pcs (1000-200)&#10;  Diskon: -Rp 400       ← Total diskon (2 × 200)&#10;```&#10;&#10;---&#10;&#10;##  Implementation di Code&#10;&#10;### ESCPosPrinter.kt (Bluetooth Thermal):&#10;```kotlin&#10;items.forEach { itx -&gt;&#10;    text(itx.productName.take(cpl))&#10;    &#10;    if (itx.discount &gt; 0) {&#10;        val originalPrice = itx.productPrice&#10;        val discountPerUnit = itx.discount / itx.quantity&#10;        val discountedPricePerUnit = originalPrice - discountPerUnit&#10;        &#10;        // Harga asli dengan /pcs&#10;        text(&quot;  @${nf.format(originalPrice)}/pcs&quot;)&#10;        &#10;        // Qty x harga setelah diskon per pcs = subtotal&#10;        text(&quot;${itx.quantity} x ${nf.format(discountedPricePerUnit)} = ${nf.format(itx.subtotal)}&quot;)&#10;        &#10;        // Total diskon&#10;        text(&quot;  Diskon: -${nf.format(itx.discount)}&quot;)&#10;    } else {&#10;        // Simple format tanpa diskon&#10;        text(&quot;${itx.quantity} x ${nf.format(itx.unitPrice)} = ${nf.format(itx.subtotal)}&quot;)&#10;    }&#10;}&#10;```&#10;&#10;### ReceiptPrinter.kt (PDF Thermal):&#10;```kotlin&#10;items.forEach { item -&gt;&#10;    canvas.drawText(name, left, y, textPaint)&#10;    y += 16f&#10;    &#10;    if (item.discount &gt; 0) {&#10;        val originalPrice = item.productPrice&#10;        val discountPerUnit = item.discount / item.quantity&#10;        val discountedPricePerUnit = originalPrice - discountPerUnit&#10;        &#10;        // Harga asli dengan strikethrough&#10;        val origPriceStr = &quot;@${nf.format(originalPrice)}/pcs&quot;&#10;        canvas.drawText(origPriceStr, left + 8f, y, smallPaint)&#10;        canvas.drawLine(...) // strikethrough&#10;        y += 14f&#10;        &#10;        // Qty x harga setelah diskon per pcs&#10;        val qtyPart = &quot;${item.quantity} x ${nf.format(discountedPricePerUnit)}&quot;&#10;        canvas.drawText(qtyPart, left + 8f, y, smallPaint)&#10;        canvas.drawText(subtotal, right, y, textPaint)&#10;        y += 18f&#10;        &#10;        // Total diskon&#10;        canvas.drawText(&quot;Diskon: -${nf.format(item.discount)}&quot;, left + 8f, y, smallPaint)&#10;        y += 16f&#10;    }&#10;}&#10;```&#10;&#10;---&#10;&#10;##  Contoh Perhitungan&#10;&#10;### Skenario 1: Single Item dengan Diskon&#10;```&#10;Produk: Sabun @ Rp 1.000&#10;Quantity: 2 pcs&#10;Diskon per pcs: Rp 200&#10;&#10;Calculation:&#10;- productPrice = 1000&#10;- quantity = 2&#10;- discount = 400 (200 × 2)&#10;- discountPerUnit = 400 / 2 = 200&#10;- discountedPricePerUnit = 1000 - 200 = 800&#10;- subtotal = (1000 × 2) - 400 = 1600&#10;&#10;Struk:&#10;Sabun&#10;  @Rp 1.000/pcs&#10;2 x Rp 800         Rp 1.600&#10;  Diskon: -Rp 400&#10;```&#10;&#10;### Skenario 2: Multiple Items dengan Berbagai Diskon&#10;```&#10;Item 1: Sabun @ Rp 1.000, qty 2, disc Rp 400&#10;Item 2: Shampoo @ Rp 5.000, qty 1, disc Rp 1.000&#10;Item 3: Pasta @ Rp 2.000, qty 3, no disc&#10;&#10;Struk:&#10;Sabun&#10;  @Rp 1.000/pcs&#10;2 x Rp 800         Rp 1.600&#10;  Diskon: -Rp 400&#10;&#10;Shampoo&#10;  @Rp 5.000/pcs&#10;1 x Rp 4.000       Rp 4.000&#10;  Diskon: -Rp 1.000&#10;&#10;Pasta&#10;3 x Rp 2.000       Rp 6.000&#10;--------------------------------&#10;Subtotal           Rp 11.600&#10;Diskon item        -Rp 1.400&#10;PPN (11%)           Rp 1.122&#10;--------------------------------&#10;TOTAL              Rp 11.322&#10;```&#10;&#10;---&#10;&#10;## ✅ Validation di Code&#10;&#10;### Max Discount Check:&#10;```kotlin&#10;val maxDiscount = product.price * quantity&#10;val safeDiscount = discountAmount.coerceIn(0.0, maxDiscount)&#10;```&#10;&#10;**Purpose:**&#10;- Prevent diskon lebih besar dari total harga&#10;- Sabun Rp 1.000, qty 2 → max discount = Rp 2.000&#10;- Jika user input Rp 3.000 → system coerce to Rp 2.000&#10;&#10;---&#10;&#10;##  Visual Examples&#10;&#10;### Format 1: Item dengan Diskon&#10;```&#10;┌──────────────────────────────┐&#10;│ Sabun Mandi                  │&#10;│   @Rp 1.000/pcs  (original)  │&#10;│ 2 x Rp 800     = Rp 1.600    │&#10;│   Diskon: -Rp 400            │&#10;└──────────────────────────────┘&#10;```&#10;&#10;### Format 2: Item tanpa Diskon&#10;```&#10;┌──────────────────────────────┐&#10;│ Pasta Gigi                   │&#10;│ 3 x Rp 2.000   = Rp 6.000    │&#10;└──────────────────────────────┘&#10;```&#10;&#10;---&#10;&#10;##  Comparison: Opsi A vs Opsi B&#10;&#10;### Opsi A (Flat Discount - TIDAK DIPAKAI):&#10;```&#10;Sabun @ Rp 1.000&#10;Diskon: Rp 200 (flat)&#10;&#10;1 pcs: Rp 1.000 - Rp 200 = Rp 800 (Rp 800/pcs)&#10;2 pcs: Rp 2.000 - Rp 200 = Rp 1.800 (Rp 900/pcs) ❌&#10;5 pcs: Rp 5.000 - Rp 200 = Rp 4.800 (Rp 960/pcs) ❌&#10;```&#10;❌ Harga per pcs berubah-ubah → confusing!&#10;&#10;### Opsi B (Per Unit Discount - ✅ DIPAKAI):&#10;```&#10;Sabun @ Rp 1.000&#10;Diskon: Rp 200/pcs&#10;&#10;1 pcs: Rp 1.000 - Rp 200 = Rp 800 (Rp 800/pcs) ✅&#10;2 pcs: Rp 2.000 - Rp 400 = Rp 1.600 (Rp 800/pcs) ✅&#10;5 pcs: Rp 5.000 - Rp 1.000 = Rp 4.000 (Rp 800/pcs) ✅&#10;```&#10;✅ Harga per pcs konsisten → clear &amp; fair!&#10;&#10;---&#10;&#10;##  Files Modified&#10;&#10;1. ✅ `ESCPosPrinter.kt`&#10;   - Calculate `discountPerUnit` and `discountedPricePerUnit`&#10;   - Display format: `@Rp X/pcs` for original price&#10;   - Display format: `Qty x Rp Y = Subtotal` for discounted price&#10;   - Display total discount amount&#10;&#10;2. ✅ `ReceiptPrinter.kt` (Thermal PDF)&#10;   - Same calculation logic&#10;   - Strikethrough for original price&#10;   - Clear display of per-unit discount&#10;&#10;3. ✅ `ReceiptPrinter.kt` (A4 PDF)&#10;   - Same logic applied&#10;&#10;---&#10;&#10;##  Build Status&#10;&#10;✅ **BUILD SUCCESSFUL**&#10;```&#10;42 actionable tasks: 6 executed, 36 up-to-date&#10;Warnings: Only deprecated API (cosmetic)&#10;```&#10;&#10;---&#10;&#10;##  Summary&#10;&#10;### ✅ Logika Diskon:&#10;**OPSI B** - Diskon per unit, total diskon = diskon per unit × quantity&#10;&#10;### ✅ Tampilan Struk:&#10;```&#10;Produk&#10;  @Rp X/pcs (harga asli)&#10;Qty x Rp Y = Subtotal (Y = harga setelah diskon per pcs)&#10;  Diskon: -Rp Z (total diskon)&#10;```&#10;&#10;### ✅ Benefits:&#10;- Standar industri retail ✅&#10;- Harga per unit konsisten ✅&#10;- Mudah dipahami customer ✅&#10;- Marketing friendly ✅&#10;- Best practice ✅&#10;&#10;### ✅ Example:&#10;```&#10;Sabun @ Rp 1.000&#10;Diskon Rp 200/pcs&#10;Beli 2 pcs:&#10;&#10;Sabun&#10;  @Rp 1.000/pcs&#10;2 x Rp 800         Rp 1.600&#10;  Diskon: -Rp 400&#10;```&#10;&#10;**Customer lihat:**&#10;- &quot;Oh, sabun harga asli Rp 1.000&quot;&#10;- &quot;Dapat diskon jadi Rp 800/pcs&quot;&#10;- &quot;Saya beli 2, jadi 2 × Rp 800 = Rp 1.600&quot;&#10;- &quot;Total hemat Rp 400&quot;&#10;&#10;✅ **Clear, transparent, professional!**&#10;&#10;---&#10;&#10;**Status: ✅ COMPLETE &amp; DOCUMENTED**&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/docs/RECEIPT_DISCOUNT_DISPLAY.md">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/docs/RECEIPT_DISCOUNT_DISPLAY.md" />
              <option name="updatedContent" value="# Receipt Item Discount Display Improvement&#10;&#10;## Tanggal: 18 November 2025&#10;&#10;## Masalah yang Diperbaiki&#10;&#10;### Item dengan Diskon Tidak Jelas di Struk&#10;&#10;**Sebelum:**&#10;```&#10;Produk A&#10;1 x Rp 4.000 = Rp 4.000&#10;```&#10;❌ **Masalah:**&#10;- Tidak terlihat harga asli (Rp 5.000)&#10;- Tidak terlihat ada diskon Rp 1.000&#10;- User bingung kenapa harga berbeda&#10;&#10;**Sesudah:**&#10;```&#10;Produk A&#10;  @Rp 5.000 (harga asli, dicoret)&#10;1 x Rp 4.000 = Rp 4.000&#10;  Diskon: -Rp 1.000&#10;```&#10;✅ **Perbaikan:**&#10;- Harga asli ditampilkan dengan tanda @ (strikethrough)&#10;- Quantity x harga setelah diskon = subtotal&#10;- Diskon amount jelas terlihat&#10;&#10;---&#10;&#10;## Implementation&#10;&#10;### 1. ESC/POS Thermal Printer (Bluetooth)&#10;**File:** `ESCPosPrinter.kt`&#10;&#10;**Format untuk item dengan diskon:**&#10;```&#10;Produk A&#10;  @Rp 5.000           ← Harga asli (dengan @)&#10;1 x Rp 4.000 = Rp 4.000  ← Qty x harga diskon = subtotal&#10;  Diskon: -Rp 1.000   ← Jumlah diskon&#10;```&#10;&#10;**Format untuk item tanpa diskon:**&#10;```&#10;Produk A&#10;1 x Rp 4.000 = Rp 4.000&#10;```&#10;&#10;**Code:**&#10;```kotlin&#10;items.forEach { itx -&gt;&#10;    text(itx.productName.take(cpl))&#10;    &#10;    if (itx.discount &gt; 0) {&#10;        val originalPrice = itx.productPrice&#10;        // Show original price with @ prefix&#10;        text(&quot;  @${nf.format(originalPrice)}&quot;)&#10;        &#10;        // Discounted line&#10;        val qty = &quot;${itx.quantity} x ${nf.format(itx.unitPrice)}&quot;&#10;        val sub = nf.format(itx.subtotal)&#10;        text(qty + &quot; &quot; + sub)&#10;        &#10;        // Discount amount&#10;        text(&quot;  Diskon: -${nf.format(itx.discount)}&quot;)&#10;    } else {&#10;        // Simple format without discount&#10;        val qty = &quot;${itx.quantity} x ${nf.format(itx.unitPrice)}&quot;&#10;        val sub = nf.format(itx.subtotal)&#10;        text(qty + &quot; &quot; + sub)&#10;    }&#10;}&#10;```&#10;&#10;---&#10;&#10;### 2. Thermal PDF (58mm/80mm)&#10;**File:** `ReceiptPrinter.kt` - `generateThermalReceiptPdf()`&#10;&#10;**Format untuk item dengan diskon:**&#10;```&#10;Produk A&#10;  @Rp 5.000 (strikethrough line)&#10;1 x Rp 4.000         Rp 4.000&#10;  Diskon: -Rp 1.000&#10;```&#10;&#10;**Code:**&#10;```kotlin&#10;items.forEach { item -&gt;&#10;    canvas.drawText(name, left, y, textPaint)&#10;    y += 16f&#10;    &#10;    if (item.discount &gt; 0) {&#10;        // Original price with strikethrough&#10;        val origPriceStr = &quot;@${nf.format(originalPrice)}&quot;&#10;        canvas.drawText(origPriceStr, left + 8f, y, smallPaint)&#10;        &#10;        // Draw strikethrough line&#10;        val lineY = y - 4f&#10;        canvas.drawLine(left + 8f, lineY, left + 8f + textWidth, lineY, smallPaint)&#10;        y += 14f&#10;    }&#10;    &#10;    // Quantity x discounted price = subtotal&#10;    val qtyPart = &quot;${item.quantity} x ${nf.format(item.unitPrice)}&quot;&#10;    val subPart = nf.format(item.subtotal)&#10;    canvas.drawText(qtyPart, left + 8f, y, smallPaint)&#10;    canvas.drawText(subPart, right - paint.measureText(subPart), y, textPaint)&#10;    y += 18f&#10;    &#10;    if (item.discount &gt; 0) {&#10;        val discountPart = &quot;Diskon: -${nf.format(item.discount)}&quot;&#10;        canvas.drawText(discountPart, left + 8f, y, smallPaint)&#10;        y += 16f&#10;    }&#10;}&#10;```&#10;&#10;---&#10;&#10;### 3. A4 PDF (Standard Printer)&#10;**File:** `ReceiptPrinter.kt` - `generateReceiptPdf()`&#10;&#10;**Format untuk item dengan diskon:**&#10;```&#10;Nama Produk    Qty    Harga (strikethrough)    Subtotal&#10;                      Harga diskon: Rp 4.000&#10;                      Diskon: -Rp 1.000&#10;```&#10;&#10;**Code:**&#10;```kotlin&#10;items.forEach { item -&gt;&#10;    if (item.discount &gt; 0) {&#10;        // Line 1: Name, Qty, Original Price (strikethrough), Subtotal&#10;        canvas.drawText(name, xPadding, y, normalPaint)&#10;        canvas.drawText(qty, qtyColumnX, y, normalPaint)&#10;        &#10;        val origPriceStr = nf.format(originalPrice)&#10;        canvas.drawText(origPriceStr, priceColumnX, y, normalPaint)&#10;        // Strikethrough&#10;        canvas.drawLine(priceColumnX, y - 4f, priceColumnX + textWidth, y - 4f, normalPaint)&#10;        &#10;        canvas.drawText(sub, rightX, y, normalPaint)&#10;        y += 18f&#10;        &#10;        // Line 2: Discounted price&#10;        canvas.drawText(&quot;Harga diskon: ${nf.format(discountedPrice)}&quot;, xPadding + 20f, y, smallPaint)&#10;        y += 14f&#10;        &#10;        // Line 3: Discount amount&#10;        canvas.drawText(&quot;Diskon: -${nf.format(item.discount)}&quot;, xPadding + 20f, y, smallPaint)&#10;        y += 18f&#10;    } else {&#10;        // Simple format&#10;        canvas.drawText(name, xPadding, y, normalPaint)&#10;        canvas.drawText(qty, qtyColumnX, y, normalPaint)&#10;        canvas.drawText(price, priceColumnX, y, normalPaint)&#10;        canvas.drawText(sub, rightX, y, normalPaint)&#10;        y += 18f&#10;    }&#10;}&#10;```&#10;&#10;---&#10;&#10;## Visual Examples&#10;&#10;### ESC/POS Thermal (58mm)&#10;```&#10;================================&#10;         TOKO SAYA&#10;    Jl. Contoh No. 123&#10;--------------------------------&#10;Produk A (diskon 20%)&#10;  @Rp 5.000&#10;1 x Rp 4.000         Rp 4.000&#10;  Diskon: -Rp 1.000&#10;&#10;Produk B (tanpa diskon)&#10;2 x Rp 3.000         Rp 6.000&#10;--------------------------------&#10;Subtotal            Rp 10.000&#10;Diskon item         -Rp 1.000&#10;PPN (11%)            Rp 1.000&#10;--------------------------------&#10;TOTAL               Rp 10.000&#10;================================&#10;```&#10;&#10;### Thermal PDF (80mm)&#10;```&#10;╔══════════════════════════════════╗&#10;║         TOKO SAYA                ║&#10;║    Jl. Contoh No. 123            ║&#10;╠══════════════════════════════════╣&#10;║ ITEM                    JUMLAH   ║&#10;╠──────────────────────────────────╣&#10;║ Produk A                         ║&#10;║   @Rp 5.000 (strikethrough)      ║&#10;║   1 x Rp 4.000         Rp 4.000  ║&#10;║   Diskon: -Rp 1.000              ║&#10;║                                  ║&#10;║ Produk B                         ║&#10;║   2 x Rp 3.000         Rp 6.000  ║&#10;╠══════════════════════════════════╣&#10;║ Subtotal              Rp 10.000  ║&#10;║ Diskon item           -Rp 1.000  ║&#10;║ PPN (11%)              Rp 1.000  ║&#10;╠══════════════════════════════════╣&#10;║ TOTAL                 Rp 10.000  ║&#10;╚══════════════════════════════════╝&#10;```&#10;&#10;### A4 PDF (Table Format)&#10;```&#10;┌─────────────┬─────┬──────────────┬──────────┐&#10;│ Item        │ Qty │ Harga        │ Subtotal │&#10;├─────────────┼─────┼──────────────┼──────────┤&#10;│ Produk A    │ 1   │ Rp 5.000     │ Rp 4.000 │&#10;│             │     │ (strikethrough)         │&#10;│ Harga diskon: Rp 4.000                      │&#10;│ Diskon: -Rp 1.000                           │&#10;├─────────────┼─────┼──────────────┼──────────┤&#10;│ Produk B    │ 2   │ Rp 3.000     │ Rp 6.000 │&#10;└─────────────┴─────┴──────────────┴──────────┘&#10;```&#10;&#10;---&#10;&#10;## Benefits&#10;&#10;### 1. Transparency (Transparansi)&#10;- ✅ Customer tahu harga asli produk&#10;- ✅ Customer tahu berapa diskon yang didapat&#10;- ✅ Builds trust dengan customer&#10;&#10;### 2. Clarity (Kejelasan)&#10;- ✅ Tidak ada kebingungan kenapa harga berbeda&#10;- ✅ Clear breakdown dari perhitungan&#10;- ✅ Professional appearance&#10;&#10;### 3. Compliance (Kepatuhan)&#10;- ✅ Sesuai dengan praktik retail yang baik&#10;- ✅ Informasi lengkap di struk&#10;- ✅ Audit trail yang jelas&#10;&#10;### 4. Consistency (Konsistensi)&#10;- ✅ Format sama untuk semua jenis printer&#10;- ✅ ESC/POS, Thermal PDF, A4 PDF semua konsisten&#10;- ✅ User experience yang seragam&#10;&#10;---&#10;&#10;## Technical Details&#10;&#10;### Data Structure&#10;```kotlin&#10;data class TransactionItemEntity(&#10;    val productName: String,&#10;    val productPrice: Double,    // Harga asli/katalog&#10;    val quantity: Int,&#10;    val unitPrice: Double,        // Harga setelah diskon item&#10;    val discount: Double,         // Jumlah diskon (productPrice - unitPrice) * quantity&#10;    val subtotal: Double          // unitPrice * quantity&#10;)&#10;```&#10;&#10;### Logic Flow&#10;```kotlin&#10;if (item.discount &gt; 0) {&#10;    // Item has discount&#10;    val originalPrice = item.productPrice       // e.g., 5000&#10;    val discountedPrice = item.unitPrice        // e.g., 4000&#10;    val discountAmount = item.discount          // e.g., 1000&#10;    &#10;    // Display:&#10;    // 1. Product name&#10;    // 2. Original price (strikethrough)&#10;    // 3. Qty x discounted price = subtotal&#10;    // 4. Discount amount&#10;} else {&#10;    // No discount - simple format&#10;    // 1. Product name&#10;    // 2. Qty x price = subtotal&#10;}&#10;```&#10;&#10;---&#10;&#10;## Files Modified&#10;&#10;1. ✅ `feature/pos/print/ESCPosPrinter.kt`&#10;   - Updated `writeReceipt()` function&#10;   - Added original price display with @&#10;   - Added discount amount line&#10;   - Conditional formatting based on discount&#10;&#10;2. ✅ `feature/pos/print/ReceiptPrinter.kt`&#10;   - Updated `generateThermalReceiptPdf()` function&#10;   - Added strikethrough for original price&#10;   - Updated `generateReceiptPdf()` function (A4)&#10;   - Added discounted price line&#10;&#10;---&#10;&#10;## Testing Checklist&#10;&#10;### ESC/POS Thermal:&#10;- [x] Item tanpa diskon: Simple format&#10;- [x] Item dengan diskon: Show original price dengan @&#10;- [x] Item dengan diskon: Show qty x discounted price&#10;- [x] Item dengan diskon: Show discount amount&#10;- [x] Format rapi dalam 32/48 chars&#10;&#10;### Thermal PDF:&#10;- [x] Item tanpa diskon: Simple format&#10;- [x] Item dengan diskon: Show original price dengan strikethrough&#10;- [x] Item dengan diskon: Show qty x discounted price&#10;- [x] Item dengan diskon: Show discount amount&#10;- [x] Layout rapi dan terbaca&#10;&#10;### A4 PDF:&#10;- [x] Item tanpa diskon: Simple table row&#10;- [x] Item dengan diskon: Original price dengan strikethrough&#10;- [x] Item dengan diskon: Discounted price line&#10;- [x] Item dengan diskon: Discount amount line&#10;- [x] Table alignment correct&#10;&#10;---&#10;&#10;## Build Status&#10;&#10;✅ **BUILD SUCCESSFUL**&#10;```&#10;42 actionable tasks: 13 executed, 29 up-to-date&#10;Warnings: Only deprecated Locale (cosmetic)&#10;```&#10;&#10;---&#10;&#10;## Summary&#10;&#10;**Problem:** Diskon item tidak terlihat di struk - hanya tampil harga final tanpa informasi harga asli dan diskon&#10;&#10;**Solution:**&#10;- ✅ Show harga asli dengan strikethrough/@ prefix&#10;- ✅ Show qty x harga setelah diskon = subtotal&#10;- ✅ Show discount amount separately&#10;- ✅ Implemented di semua format: ESC/POS, Thermal PDF, A4 PDF&#10;&#10;**Result:**&#10;- ✅ Customer tahu harga asli&#10;- ✅ Customer tahu berapa diskon yang didapat&#10;- ✅ Transparent dan professional&#10;- ✅ Builds trust&#10;&#10;---&#10;&#10;**Status: ✅ COMPLETE**&#10;&#10;Struk sekarang menampilkan informasi diskon item dengan lengkap dan jelas!&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>