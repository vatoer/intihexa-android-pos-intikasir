<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/docs/FIX_ITEMS_NOT_LOADED_ISSUE.md">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/docs/FIX_ITEMS_NOT_LOADED_ISSUE.md" />
              <option name="updatedContent" value="# Fix: &quot;Item Belum Dimuat&quot; Padahal Item Sudah Terlihat di UI&#10;&#10;## Masalah&#10;&#10;User melaporkan bahwa ketika mencoba print struk dari detail transaksi, muncul pesan **&quot;Item belum dimuat, tunggu sebentar&quot;** padahal di UI item-item transaksi sudah terlihat.&#10;&#10;## Root Cause Analysis&#10;&#10;### 1. Race Condition pada State Loading&#10;**File**: `HistoryDetailScreen.kt` (sebelum perbaikan)&#10;&#10;```kotlin&#10;onPrint = {&#10;    if (printing) return@TransactionActions&#10;    printing = true&#10;    val itemsLoaded = uiState.items.isNotEmpty()&#10;    if (!itemsLoaded) {&#10;        scope.launch { snackbarHostState.showSnackbar(&quot;Item belum dimuat...&quot;) }&#10;        printing = false&#10;    } else {&#10;        onPrint(tx)&#10;        // ...&#10;    }&#10;}&#10;```&#10;&#10;**Masalahnya**:&#10;- `loadDetail()` di ViewModel menggunakan `combine()` flow yang **asynchronous**&#10;- UI merender items dari flow yang sudah emit value&#10;- Tetapi saat user klik tombol, `uiState.items` bisa saja **belum ter-update** di Composable scope&#10;- Ini menyebabkan **race condition**: UI sudah tampil tapi state di lambda belum&#10;&#10;### 2. Flow Collection Timing&#10;&#10;**File**: `HistoryViewModel.kt`&#10;&#10;```kotlin&#10;private fun loadDetail(transactionId: String) {&#10;    _detailUiState.update { it.copy(isLoading = true) }&#10;    viewModelScope.launch {&#10;        combine(&#10;            repo.getTransactionById(transactionId),&#10;            repo.getTransactionItems(transactionId)&#10;        ) { tx, items -&gt; tx to items }&#10;            .collect { (tx, items) -&gt;&#10;                _detailUiState.update { &#10;                    it.copy(isLoading = false, transaction = tx, items = items) &#10;                }&#10;            }&#10;    }&#10;}&#10;```&#10;&#10;**Timeline yang terjadi**:&#10;1. `loadDetail()` dipanggil → `isLoading = true`&#10;2. Flow mulai collect dari database&#10;3. UI merender items dari flow emission pertama&#10;4. User melihat items dan klik tombol print&#10;5. Lambda `onPrint` capture state yang belum ter-update&#10;6. Check `uiState.items.isNotEmpty()` return **false**&#10;7. Muncul pesan &quot;Item belum dimuat&quot; &#10;&#10;## Solusi&#10;&#10;### Strategi 1: Disable Buttons Saat Loading (Dipilih)&#10;&#10;Menonaktifkan tombol print/share sampai data benar-benar selesai dimuat:&#10;&#10;```kotlin&#10;onPrint = if (!uiState.isLoading &amp;&amp; uiState.items.isNotEmpty()) {&#10;    {&#10;        if (printing) return@TransactionActions&#10;        printing = true&#10;        onPrint(tx)&#10;        scope.launch {&#10;            kotlinx.coroutines.delay(800)&#10;            printing = false&#10;        }&#10;    }&#10;} else null,  // Button disabled/hidden&#10;```&#10;&#10;**Keuntungan**:&#10;✅ Mencegah user klik tombol sebelum data siap&#10;✅ UX lebih jelas (button disabled = data belum siap)&#10;✅ Tidak ada pesan error yang membingungkan&#10;✅ Lebih reliable karena pakai `isLoading` flag&#10;&#10;### Strategi 2: Hapus Check &amp; Trust State (Alternatif)&#10;&#10;Menghapus validasi items dan percaya bahwa jika UI sudah render, data sudah ada:&#10;&#10;```kotlin&#10;onPrint = {&#10;    if (printing) return@TransactionActions&#10;    printing = true&#10;    onPrint(tx)&#10;    scope.launch {&#10;        kotlinx.coroutines.delay(800)&#10;        printing = false&#10;    }&#10;}&#10;```&#10;&#10;**Keuntungan**:&#10;✅ Kode lebih sederhana&#10;✅ Tidak ada check redundant&#10;&#10;**Kekurangan**:&#10;❌ Bisa crash jika state belum siap&#10;❌ Tidak ada indikasi visual kalau data belum ready&#10;&#10;## Implementasi Final&#10;&#10;**File**: `HistoryDetailScreen.kt`&#10;&#10;```kotlin&#10;TransactionActions(&#10;    status = tx.status,&#10;    onEdit = { onEdit(tx.id) },&#10;    &#10;    // Print button: disabled until items loaded&#10;    onPrint = if (!uiState.isLoading &amp;&amp; uiState.items.isNotEmpty()) {&#10;        {&#10;            if (printing) return@TransactionActions&#10;            printing = true&#10;            onPrint(tx)&#10;            scope.launch {&#10;                kotlinx.coroutines.delay(800)&#10;                printing = false&#10;            }&#10;        }&#10;    } else null,&#10;    &#10;    // Share button: disabled until items loaded&#10;    onShare = if (!uiState.isLoading &amp;&amp; uiState.items.isNotEmpty()) {&#10;        { onShare(tx) }&#10;    } else null,&#10;    &#10;    // Print queue: only needs transaction (not items)&#10;    onPrintQueue = if (!uiState.isLoading) {&#10;        {&#10;            if (printing) return@TransactionActions&#10;            onPrintQueue(tx)&#10;            scope.launch { &#10;                snackbarHostState.showSnackbar(&quot;Tiket antrian dicetak&quot;) &#10;            }&#10;        }&#10;    } else null,&#10;    &#10;    // Other actions...&#10;)&#10;```&#10;&#10;## Kondisi Disable Button&#10;&#10;| Button | Kondisi Disabled | Alasan |&#10;|--------|------------------|--------|&#10;| **Cetak Struk** | `isLoading` ATAU `items.isEmpty()` | Butuh items untuk print receipt |&#10;| **Bagikan** | `isLoading` ATAU `items.isEmpty()` | Butuh items untuk generate PDF |&#10;| **Cetak Antrian** | `isLoading` saja | Hanya butuh transaction number &amp; total |&#10;| **Selesai** | Tidak disabled | Hanya update status |&#10;| **Edit** | Tidak disabled | Navigasi saja |&#10;| **Hapus** | Tidak disabled | Admin action |&#10;&#10;## Testing Checklist&#10;&#10;- [x] Build berhasil tanpa error&#10;- [ ] Test: Buka detail transaksi dengan banyak items&#10;- [ ] Test: Tombol print disabled saat loading&#10;- [ ] Test: Tombol print enabled setelah items muncul&#10;- [ ] Test: Klik print → struk tercetak dengan benar&#10;- [ ] Test: Tidak ada pesan &quot;Item belum dimuat&quot;&#10;- [ ] Test: Print queue tetap bisa digunakan (tidak butuh items)&#10;&#10;## Pelajaran&#10;&#10;### Do ✅&#10;- Gunakan `isLoading` state untuk disable UI actions&#10;- Disable button sampai semua data dependency siap&#10;- Percaya loading state dari ViewModel lebih daripada UI render state&#10;- Berikan feedback visual (disabled button) daripada error message&#10;&#10;### Don't ❌&#10;- Jangan check state di dalam lambda yang bisa ter-capture sebelum update&#10;- Jangan asumsikan UI render = state sudah ready&#10;- Jangan buat validasi redundant yang bisa race condition&#10;- Jangan tampilkan error message untuk kondisi normal (loading)&#10;&#10;## Related Issues&#10;&#10;- Print tidak keluar → Fixed di `ReceiptPrinter.kt` dengan fallback logic&#10;- Permission error → Fixed dengan `BluetoothPermissionHelper`&#10;- Logo tidak muncul di struk → Fixed dengan bitmap caching&#10;&#10;---&#10;**Status**: ✅ Fixed&#10;**Date**: 20 November 2025&#10;**Build**: Successful&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>